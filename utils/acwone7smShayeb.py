#TeleGram: @ADIL721
import base64
exec(base64.b64decode('IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIENvcHlyaWdodCAoQykgQHN1YmlucHMKIyBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KCiMgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCgojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gLmxvZ2dlciBpbXBvcnQgTE9HR0VSCnRyeToKICAgIGZyb20gcHlyb2dyYW0ucmF3LnR5cGVzIGltcG9ydCBJbnB1dENoYW5uZWwKICAgIGZyb20gYXBzY2hlZHVsZXIuc2NoZWR1bGVycy5hc3luY2lvIGltcG9ydCBBc3luY0lPU2NoZWR1bGVyICAgCiAgICBmcm9tIGFwc2NoZWR1bGVyLmpvYnN0b3Jlcy5tb25nb2RiIGltcG9ydCBNb25nb0RCSm9iU3RvcmUKICAgIGZyb20gYXBzY2hlZHVsZXIuam9ic3RvcmVzLmJhc2UgaW1wb3J0IENvbmZsaWN0aW5nSWRFcnJvcgogICAgZnJvbSBweXJvZ3JhbS5yYXcuZnVuY3Rpb25zLmNoYW5uZWxzIGltcG9ydCBHZXRGdWxsQ2hhbm5lbAogICAgZnJvbSBweXRnY2FsbHMgaW1wb3J0IFN0cmVhbVR5cGUKICAgIGltcG9ydCB5dF9kbHAKICAgIGZyb20gcHlyb2dyYW0gaW1wb3J0IGZpbHRlcnMKICAgIGZyb20gcHltb25nbyBpbXBvcnQgTW9uZ29DbGllbnQKICAgIGZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCiAgICBmcm9tIHRocmVhZGluZyBpbXBvcnQgVGhyZWFkCiAgICBmcm9tIG1hdGggaW1wb3J0IGdjZAogICAgZnJvbSAucHlyb19kbCBpbXBvcnQgRG93bmxvYWRlcgogICAgZnJvbSBjb25maWcgaW1wb3J0IENvbmZpZwogICAgZnJvbSBhc3luY2lvIGltcG9ydCBzbGVlcCAgCiAgICBmcm9tIGJvdCBpbXBvcnQgYm90CiAgICBmcm9tIFBUTiBpbXBvcnQgcGFyc2UKICAgIGltcG9ydCBzdWJwcm9jZXNzCiAgICBpbXBvcnQgYXN5bmNpbwogICAgaW1wb3J0IGpzb24KICAgIGltcG9ydCByYW5kb20KICAgIGltcG9ydCB0aW1lCiAgICBpbXBvcnQgc3lzCiAgICBpbXBvcnQgb3MKICAgIGltcG9ydCBtYXRoCiAgICBmcm9tIHB5cm9ncmFtLmVycm9ycy5leGNlcHRpb25zLmJhZF9yZXF1ZXN0XzQwMCBpbXBvcnQgKAogICAgICAgIEJhZFJlcXVlc3QsIAogICAgICAgIFNjaGVkdWxlRGF0ZUludmFsaWQsCiAgICAgICAgUGVlcklkSW52YWxpZCwKICAgICAgICBDaGFubmVsSW52YWxpZAogICAgKQogICAgZnJvbSBweXRnY2FsbHMudHlwZXMuaW5wdXRfc3RyZWFtIGltcG9ydCAoCiAgICAgICAgQXVkaW9WaWRlb1BpcGVkLCAKICAgICAgICBBdWRpb1BpcGVkLAogICAgICAgIEF1ZGlvSW1hZ2VQaXBlZAogICAgKQogICAgZnJvbSBweXRnY2FsbHMudHlwZXMuaW5wdXRfc3RyZWFtIGltcG9ydCAoCiAgICAgICAgQXVkaW9QYXJhbWV0ZXJzLAogICAgICAgIFZpZGVvUGFyYW1ldGVycwogICAgKQogICAgZnJvbSBweXJvZ3JhbS50eXBlcyBpbXBvcnQgKAogICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uLCAKICAgICAgICBJbmxpbmVLZXlib2FyZE1hcmt1cCwgCiAgICAgICAgTWVzc2FnZQogICAgKQogICAgZnJvbSBweXJvZ3JhbS5yYXcuZnVuY3Rpb25zLnBob25lIGltcG9ydCAoCiAgICAgICAgRWRpdEdyb3VwQ2FsbFRpdGxlLCAKICAgICAgICBDcmVhdGVHcm91cENhbGwsCiAgICAgICAgVG9nZ2xlR3JvdXBDYWxsUmVjb3JkLAogICAgICAgIFN0YXJ0U2NoZWR1bGVkR3JvdXBDYWxsIAogICAgKQogICAgZnJvbSBweXRnY2FsbHMuZXhjZXB0aW9ucyBpbXBvcnQgKAogICAgICAgIEdyb3VwQ2FsbE5vdEZvdW5kLCAKICAgICAgICBOb0FjdGl2ZUdyb3VwQ2FsbCwKICAgICAgICBJbnZhbGlkVmlkZW9Qcm9wb3J0aW9uCiAgICApCiAgICBmcm9tIFBJTCBpbXBvcnQgKAogICAgICAgIEltYWdlLCAKICAgICAgICBJbWFnZUZvbnQsIAogICAgICAgIEltYWdlRHJhdyAKICAgICkKCiAgICBmcm9tIHVzZXIgaW1wb3J0ICgKICAgICAgICBncm91cF9jYWxsLCAKICAgICAgICBVU0VSCiAgICApCmV4Y2VwdCBNb2R1bGVOb3RGb3VuZEVycm9yOgogICAgaW1wb3J0IG9zCiAgICBpbXBvcnQgc3lzCiAgICBpbXBvcnQgc3VicHJvY2VzcwogICAgZmlsZT1vcy5wYXRoLmFic3BhdGgoInJlcXVpcmVtZW50cy50eHQiKQogICAgc3VicHJvY2Vzcy5jaGVja19jYWxsKFtzeXMuZXhlY3V0YWJsZSwgJy1tJywgJ3BpcCcsICdpbnN0YWxsJywgJy1yJywgZmlsZSwgJy0tdXBncmFkZSddKQogICAgb3MuZXhlY2woc3lzLmV4ZWN1dGFibGUsIHN5cy5leGVjdXRhYmxlLCAqc3lzLmFyZ3YpCgppZiBDb25maWcuREFUQUJBU0VfVVJJOgogICAgZnJvbSAuZGF0YWJhc2UgaW1wb3J0IGRiCiAgICBtb25jbGllbnQgPSBNb25nb0NsaWVudChDb25maWcuREFUQUJBU0VfVVJJKQogICAgam9ic3RvcmVzID0gewogICAgICAgICdkZWZhdWx0JzogTW9uZ29EQkpvYlN0b3JlKGNsaWVudD1tb25jbGllbnQsIGRhdGFiYXNlPUNvbmZpZy5EQVRBQkFTRV9OQU1FLCBjb2xsZWN0aW9uPSdzY2hlZHVsZXInKQogICAgICAgIH0KICAgIHNjaGVkdWxlciA9IEFzeW5jSU9TY2hlZHVsZXIoam9ic3RvcmVzPWpvYnN0b3JlcykKZWxzZToKICAgIHNjaGVkdWxlciA9IEFzeW5jSU9TY2hlZHVsZXIoKQpzY2hlZHVsZXIuc3RhcnQoKQpkbD1Eb3dubG9hZGVyKCkKCmFzeW5jIGRlZiBwbGF5KCk6CiAgICBzb25nPUNvbmZpZy5wbGF5bGlzdFswXSAgICAKICAgIGlmIHNvbmdbM10gPT0gInRlbGVncmFtIjoKICAgICAgICBmaWxlPUNvbmZpZy5HRVRfRklMRS5nZXQoc29uZ1s1XSkKICAgICAgICBpZiBub3QgZmlsZToKICAgICAgICAgICAgZmlsZSA9IGF3YWl0IGRsLnB5cm9fZGwoc29uZ1syXSkKICAgICAgICAgICAgaWYgbm90IGZpbGU6CiAgICAgICAgICAgICAgICBMT0dHRVIuaW5mbygiRG93bmxvYWRpbmcgZmlsZSBmcm9tIHRlbGVncmFtIikKICAgICAgICAgICAgICAgIGZpbGUgPSBhd2FpdCBib3QuZG93bmxvYWRfbWVkaWEoc29uZ1syXSkKICAgICAgICAgICAgQ29uZmlnLkdFVF9GSUxFW3NvbmdbNV1dID0gZmlsZQogICAgICAgICAgICBhd2FpdCBzbGVlcCgzKQogICAgICAgIHdoaWxlIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlKToKICAgICAgICAgICAgZmlsZT1Db25maWcuR0VUX0ZJTEUuZ2V0KHNvbmdbNV0pCiAgICAgICAgICAgIGF3YWl0IHNsZWVwKDEpCiAgICAgICAgdG90YWw9aW50KCgoc29uZ1s1XS5zcGxpdCgiXyIpKVsxXSkpICogMC4wMDUKICAgICAgICB3aGlsZSBub3QgKG9zLnN0YXQoZmlsZSkuc3Rfc2l6ZSkgPj0gdG90YWw6CiAgICAgICAgICAgIExPR0dFUi5pbmZvKCJXYWl0aW5nIGZvciBkb3dubG9hZCIpCiAgICAgICAgICAgIExPR0dFUi5pbmZvKHN0cigob3Muc3RhdChmaWxlKS5zdF9zaXplKSkpCiAgICAgICAgICAgIGF3YWl0IHNsZWVwKDEpCiAgICBlbGlmIHNvbmdbM10gPT0gInVybCI6CiAgICAgICAgZmlsZT1zb25nWzJdCiAgICBlbHNlOgogICAgICAgIGZpbGU9YXdhaXQgZ2V0X2xpbmsoc29uZ1syXSkKICAgIGlmIG5vdCBmaWxlOgogICAgICAgIGlmIENvbmZpZy5wbGF5bGlzdCBvciBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBza2lwKCkgICAgIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIExPR0dFUi5lcnJvcigiVGhpcyBzdHJlYW0gaXMgbm90IHN1cHBvcnRlZCAsIGxlYXZpbmcgVkMuIikKICAgICAgICAgICAgYXdhaXQgbGVhdmVfY2FsbCgpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKICAgIGxpbmssIHNlZWssIHBpYywgd2lkdGgsIGhlaWdodCA9IGF3YWl0IGNoZWtfdGhlX21lZGlhKGZpbGUsIHRpdGxlPWYie3NvbmdbMV19IikKICAgIGlmIG5vdCBsaW5rOgogICAgICAgIExPR0dFUi53YXJuaW5nKCJVbnN1cHBvcnRlZCBsaW5rLCBTa2lwaW5nIGZyb20gcXVldWUuIikKICAgICAgICByZXR1cm4KICAgIGF3YWl0IHNsZWVwKDEpCiAgICBpZiBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgQ29uZmlnLlNUUkVBTV9MSU5LPUZhbHNlCiAgICBMT0dHRVIuaW5mbyhmIlNUQVJUSU5HIFBMQVlJTkc6IHtzb25nWzFdfSIpCiAgICBhd2FpdCBqb2luX2NhbGwobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KQoKYXN5bmMgZGVmIHNjaGVkdWxlX2FfcGxheShqb2JfaWQsIGRhdGUpOgogICAgdHJ5OgogICAgICAgIHNjaGVkdWxlci5hZGRfam9iKHJ1bl9zY2hlZHVsZSwgImRhdGUiLCBbam9iX2lkXSwgaWQ9am9iX2lkLCBydW5fZGF0ZT1kYXRlLCBtYXhfaW5zdGFuY2VzPTUwLCBtaXNmaXJlX2dyYWNlX3RpbWU9Tm9uZSkKICAgIGV4Y2VwdCBDb25mbGljdGluZ0lkRXJyb3I6CiAgICAgICAgTE9HR0VSLndhcm5pbmcoIlRoaXMgYWxyZWFkeSBzY2hlZHVsZWQiKQogICAgICAgIHJldHVybgogICAgaWYgbm90IENvbmZpZy5DQUxMX1NUQVRVUyBvciBub3QgQ29uZmlnLklTX0FDVElWRToKICAgICAgICBpZiBDb25maWcuU0NIRURVTEVfTElTVFswXVsnam9iX2lkJ10gPT0gam9iX2lkIFwKICAgICAgICAgICAgYW5kIChkYXRlIC0gZGF0ZXRpbWUubm93KCkpLnRvdGFsX3NlY29uZHMoKSA8IDg2NDAwOgogICAgICAgICAgICBzb25nPUNvbmZpZy5TQ0hFRFVMRURfU1RSRUFNLmdldChqb2JfaWQpCiAgICAgICAgICAgIGlmIENvbmZpZy5JU19SRUNPUkRJTkc6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXIuYWRkX2pvYihzdGFydF9yZWNvcmRfc3RyZWFtLCAiZGF0ZSIsIGlkPXN0cihDb25maWcuQ0hBVCksIHJ1bl9kYXRlPWRhdGUsIG1heF9pbnN0YW5jZXM9NTAsIG1pc2ZpcmVfZ3JhY2VfdGltZT1Ob25lKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhd2FpdCBVU0VSLnNlbmQoQ3JlYXRlR3JvdXBDYWxsKAogICAgICAgICAgICAgICAgICAgIHBlZXI9KGF3YWl0IFVTRVIucmVzb2x2ZV9wZWVyKENvbmZpZy5DSEFUKSksCiAgICAgICAgICAgICAgICAgICAgcmFuZG9tX2lkPXJhbmRvbS5yYW5kaW50KDEwMDAwLCA5OTk5OTk5OTkpLAogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlX2RhdGU9aW50KGRhdGUudGltZXN0YW1wKCkpLAogICAgICAgICAgICAgICAgICAgIHRpdGxlPXNvbmdbJzEnXQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIENvbmZpZy5IQVNfU0NIRURVTEU9VHJ1ZQogICAgICAgICAgICBleGNlcHQgU2NoZWR1bGVEYXRlSW52YWxpZDoKICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiVW5hYmxlIHRvIHNjaGVkdWxlIFZpZGVvQ2hhdCwgc2luY2UgZGF0ZSBpcyBpbnZhbGlkIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKGYiRXJyb3IgaW4gc2NoZWR1bGluZyB2b2ljZWNoYXQtIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICBhd2FpdCBzeW5jX3RvX2RiKCkKCmFzeW5jIGRlZiBydW5fc2NoZWR1bGUoam9iX2lkKToKICAgIGRhdGE9Q29uZmlnLlNDSEVEVUxFRF9TVFJFQU0uZ2V0KGpvYl9pZCkKICAgIGlmIG5vdCBkYXRhOgogICAgICAgIExPR0dFUi5lcnJvcigiVGhlIFNjaGVkdWxlZCBzdHJlYW0gd2FzIG5vdCBwbGF5ZWQsIHNpbmNlIGRhdGEgaXMgbWlzc2luZyIpCiAgICAgICAgb2xkPWZpbHRlcihsYW1iZGEgazoga1snam9iX2lkJ10gPT0gam9iX2lkLCBDb25maWcuU0NIRURVTEVfTElTVCkKICAgICAgICBpZiBvbGQ6CiAgICAgICAgICAgIENvbmZpZy5TQ0hFRFVMRV9MSVNULnJlbW92ZShvbGQpCiAgICAgICAgYXdhaXQgc3luY190b19kYigpCiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICBpZiBDb25maWcuSEFTX1NDSEVEVUxFOgogICAgICAgICAgICBpZiBub3QgYXdhaXQgc3RhcnRfc2NoZWR1bGVkKCk6CiAgICAgICAgICAgICAgICBMT0dHRVIuZXJyb3IoIlNjaGVkdWxlZCBzdHJlYW0gc2tpcHBlZCwgUmVhc29uIC0gVW5hYmxlIHRvIHN0YXJ0IGEgdm9pY2UgY2hhdC4iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZGF0YV8gPSBbezE6ZGF0YVsnMSddLCAyOmRhdGFbJzInXSwgMzpkYXRhWyczJ10sIDQ6ZGF0YVsnNCddLCA1OmRhdGFbJzUnXX1dCiAgICAgICAgQ29uZmlnLnBsYXlsaXN0ID0gZGF0YV8gKyBDb25maWcucGxheWxpc3QKICAgICAgICBhd2FpdCBwbGF5KCkKICAgICAgICBMT0dHRVIuaW5mbygiU3RhcnRpbmcgU2NoZWR1bGVkIFN0cmVhbSIpCiAgICAgICAgZGVsIENvbmZpZy5TQ0hFRFVMRURfU1RSRUFNW2pvYl9pZF0KICAgICAgICBvbGQ9bGlzdChmaWx0ZXIobGFtYmRhIGs6IGtbJ2pvYl9pZCddID09IGpvYl9pZCwgQ29uZmlnLlNDSEVEVUxFX0xJU1QpKQogICAgICAgIGlmIG9sZDoKICAgICAgICAgICAgZm9yIG9sZF8gaW4gb2xkOgogICAgICAgICAgICAgICAgQ29uZmlnLlNDSEVEVUxFX0xJU1QucmVtb3ZlKG9sZF8pCiAgICAgICAgaWYgbm90IENvbmZpZy5TQ0hFRFVMRV9MSVNUOgogICAgICAgICAgICBDb25maWcuU0NIRURVTEVEX1NUUkVBTSA9IHt9ICNjbGVhciB0aGUgdW5zY2hlZHVsZWQgc3RyZWFtcwogICAgICAgIGF3YWl0IHN5bmNfdG9fZGIoKQogICAgICAgIGlmIGxlbihDb25maWcucGxheWxpc3QpIDw9IDE6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGF3YWl0IGRvd25sb2FkKENvbmZpZy5wbGF5bGlzdFsxXSkKICAgICAgCmFzeW5jIGRlZiBjYW5jZWxfYWxsX3NjaGVkdWxlcygpOgogICAgZm9yIHNjaCBpbiBDb25maWcuU0NIRURVTEVfTElTVDoKICAgICAgICBqb2I9c2NoWydqb2JfaWQnXQogICAgICAgIGs9c2NoZWR1bGVyLmdldF9qb2Ioam9iLCBqb2JzdG9yZT1Ob25lKQogICAgICAgIGlmIGs6CiAgICAgICAgICAgIHNjaGVkdWxlci5yZW1vdmVfam9iKGpvYiwgam9ic3RvcmU9Tm9uZSkKICAgICAgICBpZiBDb25maWcuU0NIRURVTEVEX1NUUkVBTS5nZXQoam9iKToKICAgICAgICAgICAgZGVsIENvbmZpZy5TQ0hFRFVMRURfU1RSRUFNW2pvYl0gICAgICAKICAgIENvbmZpZy5TQ0hFRFVMRV9MSVNULmNsZWFyKCkKICAgIGF3YWl0IHN5bmNfdG9fZGIoKQogICAgTE9HR0VSLmluZm8oIkFsbCB0aGUgc2NoZWR1bGVzIGFyZSByZW1vdmVkIikKCmFzeW5jIGRlZiBza2lwKCk6CiAgICBpZiBDb25maWcuU1RSRUFNX0xJTksgYW5kIGxlbihDb25maWcucGxheWxpc3QpID09IDAgYW5kIENvbmZpZy5JU19MT09QOgogICAgICAgIGF3YWl0IHN0cmVhbV9mcm9tX2xpbmsoKQogICAgICAgIHJldHVybgogICAgZWxpZiBub3QgQ29uZmlnLnBsYXlsaXN0IFwKICAgICAgICBhbmQgQ29uZmlnLklTX0xPT1A6CiAgICAgICAgTE9HR0VSLmluZm8oIkxvb3AgUGxheSBlbmFibGVkLCBzd2l0Y2hpbmcgdG8gU1RBUlRVUF9TVFJFQU0sIHNpbmNlIHBsYXlsaXN0IGlzIGVtcHR5LiIpCiAgICAgICAgYXdhaXQgc3RhcnRfc3RyZWFtKCkKICAgICAgICByZXR1cm4KICAgIGVsaWYgbm90IENvbmZpZy5wbGF5bGlzdCBcCiAgICAgICAgYW5kIG5vdCBDb25maWcuSVNfTE9PUDoKICAgICAgICBMT0dHRVIuaW5mbygiTG9vcCBQbGF5IGlzIGRpc2FibGVkLCBsZWF2aW5nIGNhbGwgc2luY2UgcGxheWxpc3QgaXMgZW1wdHkuIikKICAgICAgICBhd2FpdCBsZWF2ZV9jYWxsKCkKICAgICAgICByZXR1cm4KICAgIG9sZF90cmFjayA9IENvbmZpZy5wbGF5bGlzdC5wb3AoMCkKICAgIGF3YWl0IGNsZWFyX2RiX3BsYXlsaXN0KHNvbmc9b2xkX3RyYWNrKQogICAgaWYgb2xkX3RyYWNrWzNdID09ICJ0ZWxlZ3JhbSI6CiAgICAgICAgZmlsZT1Db25maWcuR0VUX0ZJTEUuZ2V0KG9sZF90cmFja1s1XSkKICAgICAgICBpZiBmaWxlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUoZmlsZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBkZWwgQ29uZmlnLkdFVF9GSUxFW29sZF90cmFja1s1XV0KICAgIGlmIG5vdCBDb25maWcucGxheWxpc3QgXAogICAgICAgIGFuZCBDb25maWcuSVNfTE9PUDoKICAgICAgICBMT0dHRVIuaW5mbygiTG9vcCBQbGF5IGVuYWJsZWQsIHN3aXRjaGluZyB0byBTVEFSVFVQX1NUUkVBTSwgc2luY2UgcGxheWxpc3QgaXMgZW1wdHkuIikKICAgICAgICBhd2FpdCBzdGFydF9zdHJlYW0oKQogICAgICAgIHJldHVybgogICAgZWxpZiBub3QgQ29uZmlnLnBsYXlsaXN0IFwKICAgICAgICBhbmQgbm90IENvbmZpZy5JU19MT09QOgogICAgICAgIExPR0dFUi5pbmZvKCJMb29wIFBsYXkgaXMgZGlzYWJsZWQsIGxlYXZpbmcgY2FsbCBzaW5jZSBwbGF5bGlzdCBpcyBlbXB0eS4iKQogICAgICAgIGF3YWl0IGxlYXZlX2NhbGwoKQogICAgICAgIHJldHVybgogICAgTE9HR0VSLmluZm8oZiJTVEFSVCBQTEFZSU5HOiB7Q29uZmlnLnBsYXlsaXN0WzBdWzFdfSIpCiAgICBpZiBDb25maWcuRFVSLmdldCgnUEFVU0UnKToKICAgICAgICBkZWwgQ29uZmlnLkRVUlsnUEFVU0UnXQogICAgYXdhaXQgcGxheSgpCiAgICBpZiBsZW4oQ29uZmlnLnBsYXlsaXN0KSA8PSAxOgogICAgICAgIHJldHVybgogICAgI2F3YWl0IGRvd25sb2FkKENvbmZpZy5wbGF5bGlzdFsxXSkKCgphc3luYyBkZWYgY2hlY2tfdmMoKToKICAgIGEgPSBhd2FpdCBib3Quc2VuZChHZXRGdWxsQ2hhbm5lbChjaGFubmVsPShhd2FpdCBib3QucmVzb2x2ZV9wZWVyKENvbmZpZy5DSEFUKSkpKQogICAgaWYgYS5mdWxsX2NoYXQuY2FsbCBpcyBOb25lOgogICAgICAgIHRyeToKICAgICAgICAgICAgTE9HR0VSLmluZm8oIk5vIGFjdGl2ZSBjYWxscyBmb3VuZCwgY3JlYXRpbmcgbmV3IikKICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKENyZWF0ZUdyb3VwQ2FsbCgKICAgICAgICAgICAgICAgIHBlZXI9KGF3YWl0IFVTRVIucmVzb2x2ZV9wZWVyKENvbmZpZy5DSEFUKSksCiAgICAgICAgICAgICAgICByYW5kb21faWQ9cmFuZG9tLnJhbmRpbnQoMTAwMDAsIDk5OTk5OTk5OSkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgQ29uZmlnLldBU19SRUNPUkRJTkc6CiAgICAgICAgICAgICAgICBhd2FpdCBzdGFydF9yZWNvcmRfc3RyZWFtKCkKICAgICAgICAgICAgYXdhaXQgc2xlZXAoMikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIExPR0dFUi5lcnJvcihmIlVuYWJsZSB0byBzdGFydCBuZXcgR3JvdXBDYWxsIDotIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgZWxzZToKICAgICAgICBpZiBDb25maWcuSEFTX1NDSEVEVUxFOgogICAgICAgICAgICBhd2FpdCBzdGFydF9zY2hlZHVsZWQoKQogICAgICAgIHJldHVybiBUcnVlCiAgICAKCmFzeW5jIGRlZiBqb2luX2NhbGwobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KTogIAogICAgaWYgbm90IGF3YWl0IGNoZWNrX3ZjKCk6CiAgICAgICAgTE9HR0VSLmVycm9yKCJObyB2b2ljZSBjYWxsIGZvdW5kIGFuZCB3YXMgdW5hYmxlIHRvIGNyZWF0ZSBhIG5ldyBvbmUuIEV4aXRpbmcuLi4iKQogICAgICAgIHJldHVybgogICAgaWYgQ29uZmlnLkhBU19TQ0hFRFVMRToKICAgICAgICBhd2FpdCBzdGFydF9zY2hlZHVsZWQoKQogICAgaWYgQ29uZmlnLkNBTExfU1RBVFVTOgogICAgICAgIGlmIENvbmZpZy5JU19BQ1RJVkUgPT0gRmFsc2U6CiAgICAgICAgICAgIENvbmZpZy5DQUxMX1NUQVRVUyA9IEZhbHNlCiAgICAgICAgICAgIHJldHVybiBhd2FpdCBqb2luX2NhbGwobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KQogICAgICAgIHBsYXk9YXdhaXQgY2hhbmdlX2ZpbGUobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KQogICAgZWxzZToKICAgICAgICBwbGF5PWF3YWl0IGpvaW5fYW5kX3BsYXkobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KQogICAgaWYgcGxheSA9PSBGYWxzZToKICAgICAgICBhd2FpdCBzbGVlcCgxKQogICAgICAgIGF3YWl0IGpvaW5fY2FsbChsaW5rLCBzZWVrLCBwaWMsIHdpZHRoLCBoZWlnaHQpCiAgICBhd2FpdCBzbGVlcCgxKQogICAgaWYgbm90IHNlZWs6CiAgICAgICAgQ29uZmlnLkRVUlsiVElNRSJdPXRpbWUudGltZSgpCiAgICAgICAgaWYgQ29uZmlnLkVESVRfVElUTEU6CiAgICAgICAgICAgIGF3YWl0IGVkaXRfdGl0bGUoKQogICAgb2xkPUNvbmZpZy5HRVRfRklMRS5nZXQoIm9sZCIpCiAgICBpZiBvbGQ6CiAgICAgICAgZm9yIGZpbGUgaW4gb2xkOgogICAgICAgICAgICBvcy5yZW1vdmUoZiIuL2Rvd25sb2Fkcy97ZmlsZX0iKQogICAgICAgIHRyeToKICAgICAgICAgICAgZGVsIENvbmZpZy5HRVRfRklMRVsib2xkIl0KICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIExPR0dFUi5lcnJvcigiRXJyb3IgaW4gRGVsZXRpbmcgZnJvbSBkaWN0IikKICAgICAgICAgICAgcGFzcwogICAgYXdhaXQgc2VuZF9wbGF5bGlzdCgpCgphc3luYyBkZWYgc3RhcnRfc2NoZWR1bGVkKCk6CiAgICB0cnk6CiAgICAgICAgYXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICBTdGFydFNjaGVkdWxlZEdyb3VwQ2FsbCgKICAgICAgICAgICAgICAgIGNhbGw9KAogICAgICAgICAgICAgICAgICAgIGF3YWl0IFVTRVIuc2VuZCgKICAgICAgICAgICAgICAgICAgICAgICAgR2V0RnVsbENoYW5uZWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsPSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBVU0VSLnJlc29sdmVfcGVlcigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkNIQVQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICkuZnVsbF9jaGF0LmNhbGwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgKQogICAgICAgIGlmIENvbmZpZy5XQVNfUkVDT1JESU5HOgogICAgICAgICAgICBhd2FpdCBzdGFydF9yZWNvcmRfc3RyZWFtKCkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGlmICdHUk9VUENBTExfQUxSRUFEWV9TVEFSVEVEJyBpbiBzdHIoZSk6CiAgICAgICAgICAgIExPR0dFUi53YXJuaW5nKCJBbHJlYWR5IEdyb3VwY2FsbCBFeGlzdCIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgQ29uZmlnLkhBU19TQ0hFRFVMRT1GYWxzZQogICAgICAgICAgICByZXR1cm4gYXdhaXQgY2hlY2tfdmMoKQoKYXN5bmMgZGVmIGpvaW5fYW5kX3BsYXkobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KToKICAgIHRyeToKICAgICAgICBpZiBzZWVrOgogICAgICAgICAgICBzdGFydD1zdHIoc2Vla1snc3RhcnQnXSkKICAgICAgICAgICAgZW5kPXN0cihzZWVrWydlbmQnXSkKICAgICAgICAgICAgaWYgbm90IENvbmZpZy5JU19WSURFTzoKICAgICAgICAgICAgICAgIGF3YWl0IGdyb3VwX2NhbGwuam9pbl9ncm91cF9jYWxsKAogICAgICAgICAgICAgICAgICAgIGludChDb25maWcuQ0hBVCksCiAgICAgICAgICAgICAgICAgICAgQXVkaW9QaXBlZCgKICAgICAgICAgICAgICAgICAgICAgICAgbGluaywKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fcGFyYW1ldGVycz1BdWRpb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbF9mZm1wZWdfcGFyYW1ldGVycz1mJy1zcyB7c3RhcnR9IC1hdGVuZCAtdCB7ZW5kfScsCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtX3R5cGU9U3RyZWFtVHlwZSgpLnB1bHNlX3N0cmVhbSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHBpYzoKICAgICAgICAgICAgICAgICAgICBjd2lkdGgsIGNoZWlnaHQgPSByZXNpemVfcmF0aW8oMTI4MCwgNzIwLCBDb25maWcuQ1VTVE9NX1FVQUxJVFkpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5qb2luX2dyb3VwX2NhbGwoCiAgICAgICAgICAgICAgICAgICAgICAgIGludChDb25maWcuQ0hBVCksCiAgICAgICAgICAgICAgICAgICAgICAgIEF1ZGlvSW1hZ2VQaXBlZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWRlb19wYXJhbWV0ZXJzPVZpZGVvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjd2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuRlBTLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX3BhcmFtZXRlcnM9QXVkaW9QYXJhbWV0ZXJzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbmZpZy5CSVRSQVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxfZmZtcGVnX3BhcmFtZXRlcnM9Zictc3Mge3N0YXJ0fSAtYXRlbmQgLXQge2VuZH0nLCAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbV90eXBlPVN0cmVhbVR5cGUoKS5wdWxzZV9zdHJlYW0sCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgd2lkdGggXAogICAgICAgICAgICAgICAgICAgICAgICBvciBub3QgaGVpZ2h0OgogICAgICAgICAgICAgICAgICAgICAgICBMT0dHRVIuZXJyb3IoIk5vIFZhbGlkIFZpZGVvIEZvdW5kIGFuZCBoZW5jZSByZW1vdmVkIGZyb20gcGxheWxpc3QuIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgQ29uZmlnLnBsYXlsaXN0IG9yIENvbmZpZy5TVFJFQU1fTElOSzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBza2lwKCkgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIAogICAgICAgICAgICAgICAgICAgIGN3aWR0aCwgY2hlaWdodCA9IHJlc2l6ZV9yYXRpbyh3aWR0aCwgaGVpZ2h0LCBDb25maWcuQ1VTVE9NX1FVQUxJVFkpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5qb2luX2dyb3VwX2NhbGwoCiAgICAgICAgICAgICAgICAgICAgICAgIGludChDb25maWcuQ0hBVCksCiAgICAgICAgICAgICAgICAgICAgICAgIEF1ZGlvVmlkZW9QaXBlZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWRlb19wYXJhbWV0ZXJzPVZpZGVvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjd2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuRlBTLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX3BhcmFtZXRlcnM9QXVkaW9QYXJhbWV0ZXJzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbmZpZy5CSVRSQVRFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbF9mZm1wZWdfcGFyYW1ldGVycz1mJy1zcyB7c3RhcnR9IC1hdGVuZCAtdCB7ZW5kfScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1fdHlwZT1TdHJlYW1UeXBlKCkucHVsc2Vfc3RyZWFtLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBub3QgQ29uZmlnLklTX1ZJREVPOgogICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5qb2luX2dyb3VwX2NhbGwoCiAgICAgICAgICAgICAgICAgICAgaW50KENvbmZpZy5DSEFUKSwKICAgICAgICAgICAgICAgICAgICBBdWRpb1BpcGVkKAogICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbmZpZy5CSVRSQVRFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIHN0cmVhbV90eXBlPVN0cmVhbVR5cGUoKS5wdWxzZV9zdHJlYW0sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBwaWM6CiAgICAgICAgICAgICAgICAgICAgY3dpZHRoLCBjaGVpZ2h0ID0gcmVzaXplX3JhdGlvKDEyODAsIDcyMCwgQ29uZmlnLkNVU1RPTV9RVUFMSVRZKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IGdyb3VwX2NhbGwuam9pbl9ncm91cF9jYWxsKAogICAgICAgICAgICAgICAgICAgICAgICBpbnQoQ29uZmlnLkNIQVQpLAogICAgICAgICAgICAgICAgICAgICAgICBBdWRpb0ltYWdlUGlwZWQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGljLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9fcGFyYW1ldGVycz1WaWRlb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkZQUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1fdHlwZT1TdHJlYW1UeXBlKCkucHVsc2Vfc3RyZWFtLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHdpZHRoIFwKICAgICAgICAgICAgICAgICAgICAgICAgb3Igbm90IGhlaWdodDoKICAgICAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJObyBWYWxpZCBWaWRlbyBGb3VuZCBhbmQgaGVuY2UgcmVtb3ZlZCBmcm9tIHBsYXlsaXN0LiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIENvbmZpZy5wbGF5bGlzdCBvciBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgc2tpcCgpICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiVGhpcyBzdHJlYW0gaXMgbm90IHN1cHBvcnRlZCAsIGxlYXZpbmcgVkMuIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAKICAgICAgICAgICAgICAgICAgICBjd2lkdGgsIGNoZWlnaHQgPSByZXNpemVfcmF0aW8od2lkdGgsIGhlaWdodCwgQ29uZmlnLkNVU1RPTV9RVUFMSVRZKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IGdyb3VwX2NhbGwuam9pbl9ncm91cF9jYWxsKAogICAgICAgICAgICAgICAgICAgICAgICBpbnQoQ29uZmlnLkNIQVQpLAogICAgICAgICAgICAgICAgICAgICAgICBBdWRpb1ZpZGVvUGlwZWQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9fcGFyYW1ldGVycz1WaWRlb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkZQUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtX3R5cGU9U3RyZWFtVHlwZSgpLnB1bHNlX3N0cmVhbSwKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgQ29uZmlnLkNBTExfU1RBVFVTPVRydWUKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IE5vQWN0aXZlR3JvdXBDYWxsOgogICAgICAgIHRyeToKICAgICAgICAgICAgTE9HR0VSLmluZm8oIk5vIGFjdGl2ZSBjYWxscyBmb3VuZCwgY3JlYXRpbmcgbmV3IikKICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKENyZWF0ZUdyb3VwQ2FsbCgKICAgICAgICAgICAgICAgIHBlZXI9KGF3YWl0IFVTRVIucmVzb2x2ZV9wZWVyKENvbmZpZy5DSEFUKSksCiAgICAgICAgICAgICAgICByYW5kb21faWQ9cmFuZG9tLnJhbmRpbnQoMTAwMDAsIDk5OTk5OTk5OSkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgQ29uZmlnLldBU19SRUNPUkRJTkc6CiAgICAgICAgICAgICAgICBhd2FpdCBzdGFydF9yZWNvcmRfc3RyZWFtKCkKICAgICAgICAgICAgYXdhaXQgc2xlZXAoMikKICAgICAgICAgICAgYXdhaXQgcmVzdGFydF9wbGF5b3V0KCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIExPR0dFUi5lcnJvcihmIlVuYWJsZSB0byBzdGFydCBuZXcgR3JvdXBDYWxsIDotIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgIHBhc3MKICAgIGV4Y2VwdCBJbnZhbGlkVmlkZW9Qcm9wb3J0aW9uOgogICAgICAgIExPR0dFUi5lcnJvcigiVGhpcyB2aWRlbyBpcyB1bnN1cHBvcnRlZCIpCiAgICAgICAgaWYgQ29uZmlnLnBsYXlsaXN0IG9yIENvbmZpZy5TVFJFQU1fTElOSzoKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHNraXAoKSAgICAgCiAgICAgICAgZWxzZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICByZXR1cm4gCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgTE9HR0VSLmVycm9yKGYiRXJyb3JzIE9jY3VyZWQgd2hpbGUgam9pbmluZywgcmV0cnlpbmcgRXJyb3ItIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgcmV0dXJuIEZhbHNlCgoKYXN5bmMgZGVmIGNoYW5nZV9maWxlKGxpbmssIHNlZWssIHBpYywgd2lkdGgsIGhlaWdodCk6CiAgICB0cnk6CiAgICAgICAgaWYgc2VlazoKICAgICAgICAgICAgc3RhcnQ9c3RyKHNlZWtbJ3N0YXJ0J10pCiAgICAgICAgICAgIGVuZD1zdHIoc2Vla1snZW5kJ10pCiAgICAgICAgICAgIGlmIG5vdCBDb25maWcuSVNfVklERU86CiAgICAgICAgICAgICAgICBhd2FpdCBncm91cF9jYWxsLmNoYW5nZV9zdHJlYW0oCiAgICAgICAgICAgICAgICAgICAgaW50KENvbmZpZy5DSEFUKSwKICAgICAgICAgICAgICAgICAgICBBdWRpb1BpcGVkKAogICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbmZpZy5CSVRSQVRFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbmFsX2ZmbXBlZ19wYXJhbWV0ZXJzPWYnLXNzIHtzdGFydH0gLWF0ZW5kIC10IHtlbmR9JywKICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHBpYzoKICAgICAgICAgICAgICAgICAgICBjd2lkdGgsIGNoZWlnaHQgPSByZXNpemVfcmF0aW8oMTI4MCwgNzIwLCBDb25maWcuQ1VTVE9NX1FVQUxJVFkpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5jaGFuZ2Vfc3RyZWFtKAogICAgICAgICAgICAgICAgICAgICAgICBpbnQoQ29uZmlnLkNIQVQpLAogICAgICAgICAgICAgICAgICAgICAgICBBdWRpb0ltYWdlUGlwZWQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGljLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9fcGFyYW1ldGVycz1WaWRlb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkZQUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbmFsX2ZmbXBlZ19wYXJhbWV0ZXJzPWYnLXNzIHtzdGFydH0gLWF0ZW5kIC10IHtlbmR9JywgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHdpZHRoIFwKICAgICAgICAgICAgICAgICAgICAgICAgb3Igbm90IGhlaWdodDoKICAgICAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJObyBWYWxpZCBWaWRlbyBGb3VuZCBhbmQgaGVuY2UgcmVtb3ZlZCBmcm9tIHBsYXlsaXN0LiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIENvbmZpZy5wbGF5bGlzdCBvciBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgc2tpcCgpICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiVGhpcyBzdHJlYW0gaXMgbm90IHN1cHBvcnRlZCAsIGxlYXZpbmcgVkMuIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAKCiAgICAgICAgICAgICAgICAgICAgY3dpZHRoLCBjaGVpZ2h0ID0gcmVzaXplX3JhdGlvKHdpZHRoLCBoZWlnaHQsIENvbmZpZy5DVVNUT01fUVVBTElUWSkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBncm91cF9jYWxsLmNoYW5nZV9zdHJlYW0oCiAgICAgICAgICAgICAgICAgICAgICAgIGludChDb25maWcuQ0hBVCksCiAgICAgICAgICAgICAgICAgICAgICAgIEF1ZGlvVmlkZW9QaXBlZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWRlb19wYXJhbWV0ZXJzPVZpZGVvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjd2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuRlBTLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX3BhcmFtZXRlcnM9QXVkaW9QYXJhbWV0ZXJzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbmZpZy5CSVRSQVRFCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbF9mZm1wZWdfcGFyYW1ldGVycz1mJy1zcyB7c3RhcnR9IC1hdGVuZCAtdCB7ZW5kfScsCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBub3QgQ29uZmlnLklTX1ZJREVPOgogICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5jaGFuZ2Vfc3RyZWFtKAogICAgICAgICAgICAgICAgICAgIGludChDb25maWcuQ0hBVCksCiAgICAgICAgICAgICAgICAgICAgQXVkaW9QaXBlZCgKICAgICAgICAgICAgICAgICAgICAgICAgbGluaywKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fcGFyYW1ldGVycz1BdWRpb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHBpYzoKICAgICAgICAgICAgICAgICAgICBjd2lkdGgsIGNoZWlnaHQgPSByZXNpemVfcmF0aW8oMTI4MCwgNzIwLCBDb25maWcuQ1VTVE9NX1FVQUxJVFkpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5jaGFuZ2Vfc3RyZWFtKAogICAgICAgICAgICAgICAgICAgICAgICBpbnQoQ29uZmlnLkNIQVQpLAogICAgICAgICAgICAgICAgICAgICAgICBBdWRpb0ltYWdlUGlwZWQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGljLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9fcGFyYW1ldGVycz1WaWRlb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkZQUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgd2lkdGggXAogICAgICAgICAgICAgICAgICAgICAgICBvciBub3QgaGVpZ2h0OgogICAgICAgICAgICAgICAgICAgICAgICBMT0dHRVIuZXJyb3IoIk5vIFZhbGlkIFZpZGVvIEZvdW5kIGFuZCBoZW5jZSByZW1vdmVkIGZyb20gcGxheWxpc3QuIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgQ29uZmlnLnBsYXlsaXN0IG9yIENvbmZpZy5TVFJFQU1fTElOSzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBza2lwKCkgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIAogICAgICAgICAgICAgICAgICAgIGN3aWR0aCwgY2hlaWdodCA9IHJlc2l6ZV9yYXRpbyh3aWR0aCwgaGVpZ2h0LCBDb25maWcuQ1VTVE9NX1FVQUxJVFkpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5jaGFuZ2Vfc3RyZWFtKAogICAgICAgICAgICAgICAgICAgICAgICBpbnQoQ29uZmlnLkNIQVQpLAogICAgICAgICAgICAgICAgICAgICAgICBBdWRpb1ZpZGVvUGlwZWQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9fcGFyYW1ldGVycz1WaWRlb1BhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3dpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkZQUywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19wYXJhbWV0ZXJzPUF1ZGlvUGFyYW1ldGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQklUUkFURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgIGV4Y2VwdCBJbnZhbGlkVmlkZW9Qcm9wb3J0aW9uOgogICAgICAgIExPR0dFUi5lcnJvcigiSW52YWxpZCB2aWRlbywgc2tpcHBlZCIpCiAgICAgICAgaWYgQ29uZmlnLnBsYXlsaXN0IG9yIENvbmZpZy5TVFJFQU1fTElOSzoKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHNraXAoKSAgICAgCiAgICAgICAgZWxzZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICBhd2FpdCBsZWF2ZV9jYWxsKCkKICAgICAgICAgICAgcmV0dXJuIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9yIGluIGpvaW5pbmcgY2FsbCAtIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgcmV0dXJuIEZhbHNlCgoKYXN5bmMgZGVmIHNlZWtfZmlsZShzZWVrdGltZSk6CiAgICBwbGF5X3N0YXJ0PWludChmbG9hdChDb25maWcuRFVSLmdldCgnVElNRScpKSkKICAgIGlmIG5vdCBwbGF5X3N0YXJ0OgogICAgICAgIHJldHVybiBGYWxzZSwgIlBsYXllciBub3QgeWV0IHN0YXJ0ZWQiCiAgICBlbHNlOgogICAgICAgIGRhdGE9Q29uZmlnLkRBVEEuZ2V0KCJGSUxFX0RBVEEiKQogICAgICAgIGlmIG5vdCBkYXRhOgogICAgICAgICAgICByZXR1cm4gRmFsc2UsICJObyBTdHJlYW1zIGZvciBzZWVraW5nIiAgICAgICAgCiAgICAgICAgcGxheWVkPWludChmbG9hdCh0aW1lLnRpbWUoKSkpIC0gaW50KGZsb2F0KHBsYXlfc3RhcnQpKQogICAgICAgIGlmIGRhdGEuZ2V0KCJkdXIiLCAwKSA9PSAwOgogICAgICAgICAgICByZXR1cm4gRmFsc2UsICJTZWVtcyBsaWtlIGxpdmUgc3RyZWFtIGlzIHBsYXlpbmcsIHdoaWNoIGNhbm5vdCBiZSBzZWVrZWQuIgogICAgICAgIHRvdGFsPWludChmbG9hdChkYXRhLmdldCgiZHVyIiwgMCkpKQogICAgICAgIHRyaW1lbmQgPSB0b3RhbCAtIHBsYXllZCAtIGludChzZWVrdGltZSkKICAgICAgICB0cmltc3RhcnQgPSBwbGF5ZWQgKyBpbnQoc2Vla3RpbWUpCiAgICAgICAgaWYgdHJpbXN0YXJ0ID4gdG90YWw6CiAgICAgICAgICAgIHJldHVybiBGYWxzZSwgIlNlZWtlZCBkdXJhdGlvbiBleGNlZWRzIG1heGltdW0gZHVyYXRpb24gb2YgZmlsZSIKICAgICAgICBuZXdfcGxheV9zdGFydD1pbnQocGxheV9zdGFydCkgLSBpbnQoc2Vla3RpbWUpCiAgICAgICAgQ29uZmlnLkRVUlsnVElNRSddPW5ld19wbGF5X3N0YXJ0CiAgICAgICAgbGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0ID0gYXdhaXQgY2hla190aGVfbWVkaWEoZGF0YS5nZXQoImZpbGUiKSwgc2Vlaz17InN0YXJ0Ijp0cmltc3RhcnQsICJlbmQiOnRyaW1lbmR9KQogICAgICAgIGF3YWl0IGpvaW5fY2FsbChsaW5rLCBzZWVrLCBwaWMsIHdpZHRoLCBoZWlnaHQpCiAgICAgICAgcmV0dXJuIFRydWUsIE5vbmUKICAgIAoKCmFzeW5jIGRlZiBsZWF2ZV9jYWxsKCk6CiAgICB0cnk6CiAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5sZWF2ZV9ncm91cF9jYWxsKENvbmZpZy5DSEFUKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyB3aGlsZSBsZWF2aW5nIGNhbGwge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICNDb25maWcucGxheWxpc3QuY2xlYXIoKQogICAgaWYgQ29uZmlnLlNUUkVBTV9MSU5LOgogICAgICAgIENvbmZpZy5TVFJFQU1fTElOSz1GYWxzZQogICAgQ29uZmlnLkNBTExfU1RBVFVTPUZhbHNlCiAgICBpZiBDb25maWcuU0NIRURVTEVfTElTVDoKICAgICAgICBzY2g9Q29uZmlnLlNDSEVEVUxFX0xJU1RbMF0KICAgICAgICBpZiAoc2NoWydkYXRlJ10gLSBkYXRldGltZS5ub3coKSkudG90YWxfc2Vjb25kcygpIDwgODY0MDA6CiAgICAgICAgICAgIHNvbmc9Q29uZmlnLlNDSEVEVUxFRF9TVFJFQU0uZ2V0KHNjaFsnam9iX2lkJ10pCiAgICAgICAgICAgIGlmIENvbmZpZy5JU19SRUNPUkRJTkc6CiAgICAgICAgICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKHN0cihDb25maWcuQ0hBVCksIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgICAgICBpZiBrOgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlci5yZW1vdmVfam9iKHN0cihDb25maWcuQ0hBVCksIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgICAgICBzY2hlZHVsZXIuYWRkX2pvYihzdGFydF9yZWNvcmRfc3RyZWFtLCAiZGF0ZSIsIGlkPXN0cihDb25maWcuQ0hBVCksIHJ1bl9kYXRlPXNjaFsnZGF0ZSddLCBtYXhfaW5zdGFuY2VzPTUwLCBtaXNmaXJlX2dyYWNlX3RpbWU9Tm9uZSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKENyZWF0ZUdyb3VwQ2FsbCgKICAgICAgICAgICAgICAgICAgICBwZWVyPShhd2FpdCBVU0VSLnJlc29sdmVfcGVlcihDb25maWcuQ0hBVCkpLAogICAgICAgICAgICAgICAgICAgIHJhbmRvbV9pZD1yYW5kb20ucmFuZGludCgxMDAwMCwgOTk5OTk5OTk5KSwKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZV9kYXRlPWludCgoc2NoWydkYXRlJ10pLnRpbWVzdGFtcCgpKSwKICAgICAgICAgICAgICAgICAgICB0aXRsZT1zb25nWycxJ10KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBDb25maWcuSEFTX1NDSEVEVUxFPVRydWUKICAgICAgICAgICAgZXhjZXB0IFNjaGVkdWxlRGF0ZUludmFsaWQ6CiAgICAgICAgICAgICAgICBMT0dHRVIuZXJyb3IoIlVuYWJsZSB0byBzY2hlZHVsZSBWaWRlb0NoYXQsIHNpbmNlIGRhdGUgaXMgaW52YWxpZCIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9yIGluIHNjaGVkdWxpbmcgdm9pY2VjaGF0LSB7ZX0iLCBleGNfaW5mbz1UcnVlKQogICAgYXdhaXQgc3luY190b19kYigpCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCgoKYXN5bmMgZGVmIHJlc3RhcnQoKToKICAgIHRyeToKICAgICAgICBhd2FpdCBncm91cF9jYWxsLmxlYXZlX2dyb3VwX2NhbGwoQ29uZmlnLkNIQVQpCiAgICAgICAgYXdhaXQgc2xlZXAoMikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBMT0dHRVIuZXJyb3IoZSwgZXhjX2luZm89VHJ1ZSkKICAgIGlmIG5vdCBDb25maWcucGxheWxpc3Q6CiAgICAgICAgYXdhaXQgc3RhcnRfc3RyZWFtKCkKICAgICAgICByZXR1cm4KICAgIExPR0dFUi5pbmZvKGYiLSBTVEFSVCBQTEFZSU5HOiB7Q29uZmlnLnBsYXlsaXN0WzBdWzFdfSIpCiAgICBhd2FpdCBzbGVlcCgxKQogICAgYXdhaXQgcGxheSgpCiAgICBMT0dHRVIuaW5mbygiUmVzdGFydGluZyBQbGF5b3V0IikKICAgIGlmIGxlbihDb25maWcucGxheWxpc3QpIDw9IDE6CiAgICAgICAgcmV0dXJuCiAgICBhd2FpdCBkb3dubG9hZChDb25maWcucGxheWxpc3RbMV0pCgoKYXN5bmMgZGVmIHJlc3RhcnRfcGxheW91dCgpOgogICAgaWYgbm90IENvbmZpZy5wbGF5bGlzdDoKICAgICAgICBhd2FpdCBzdGFydF9zdHJlYW0oKQogICAgICAgIHJldHVybgogICAgTE9HR0VSLmluZm8oZiJSRVNUQVJUIFBMQVlJTkc6IHtDb25maWcucGxheWxpc3RbMF1bMV19IikKICAgIGRhdGE9Q29uZmlnLkRBVEEuZ2V0KCdGSUxFX0RBVEEnKQogICAgaWYgZGF0YToKICAgICAgICBsaW5rLCBzZWVrLCBwaWMsIHdpZHRoLCBoZWlnaHQgPSBhd2FpdCBjaGVrX3RoZV9tZWRpYShkYXRhWydmaWxlJ10sIHRpdGxlPWYie0NvbmZpZy5wbGF5bGlzdFswXVsxXX0iKQogICAgICAgIGlmIG5vdCBsaW5rOgogICAgICAgICAgICBMT0dHRVIud2FybmluZygiVW5zdXBwb3J0ZWQgTGluayIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGF3YWl0IHNsZWVwKDEpCiAgICAgICAgaWYgQ29uZmlnLlNUUkVBTV9MSU5LOgogICAgICAgICAgICBDb25maWcuU1RSRUFNX0xJTks9RmFsc2UKICAgICAgICBhd2FpdCBqb2luX2NhbGwobGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0KQogICAgZWxzZToKICAgICAgICBhd2FpdCBwbGF5KCkKICAgIGlmIGxlbihDb25maWcucGxheWxpc3QpIDw9IDE6CiAgICAgICAgcmV0dXJuCiAgICBhd2FpdCBkb3dubG9hZChDb25maWcucGxheWxpc3RbMV0pCgoKZGVmIGlzX3l0ZGxfc3VwcG9ydGVkKGlucHV0X3VybDogc3RyKSAtPiBib29sOgogICAgc2hlaSA9IHl0X2RscC5leHRyYWN0b3IuZ2VuX2V4dHJhY3RvcnMoKQogICAgcmV0dXJuIGFueShpbnRfZXh0cmFhY3Rvci5zdWl0YWJsZShpbnB1dF91cmwpIGFuZCBpbnRfZXh0cmFhY3Rvci5JRV9OQU1FICE9ICJnZW5lcmljIiBmb3IgaW50X2V4dHJhYWN0b3IgaW4gc2hlaSkKCgphc3luYyBkZWYgc2V0X3VwX3N0YXJ0dXAoKToKICAgIENvbmZpZy5ZU1RSRUFNPUZhbHNlCiAgICBDb25maWcuWVBMQVk9RmFsc2UKICAgIENvbmZpZy5DUExBWT1GYWxzZQogICAgI3JlZ2V4ID0gciJeKD86aHR0cHM/OlwvXC8pPyg/Ond3d1wuKT95b3V0dVwuP2JlKD86XC5jb20pP1wvPy4qKD86d2F0Y2h8ZW1iZWQpPyg/Oi4qdj18dlwvfFwvKShbXHdcLV9dKylcJj8iCiAgICAjIG1hdGNoID0gcmUubWF0Y2gocmVnZXgsIENvbmZpZy5TVFJFQU1fVVJMKQogICAgaWYgQ29uZmlnLlNUUkVBTV9VUkwuc3RhcnRzd2l0aCgiQCIpIG9yIChzdHIoQ29uZmlnLlNUUkVBTV9VUkwpKS5zdGFydHN3aXRoKCItMTAwIik6CiAgICAgICAgQ29uZmlnLkNQTEFZID0gVHJ1ZQogICAgICAgIExPR0dFUi5pbmZvKGYiQ2hhbm5lbCBQbGF5IGVuYWJsZWQgZnJvbSB7Q29uZmlnLlNUUkVBTV9VUkx9IikKICAgICAgICBDb25maWcuU1RSRUFNX1NFVFVQPVRydWUKICAgICAgICByZXR1cm4KICAgIGVsaWYgQ29uZmlnLlNUUkVBTV9VUkwuc3RhcnRzd2l0aCgiaHR0cHM6Ly90Lm1lL2lQdXJleCIpOgogICAgICAgIENvbmZpZy5ZUExBWT1UcnVlCiAgICAgICAgTE9HR0VSLmluZm8oIllvdVR1YmUgUGxheWxpc3QgaXMgc2V0IGFzIFNUQVJUVVAgU1RSRUFNIikKICAgICAgICBDb25maWcuU1RSRUFNX1NFVFVQPVRydWUKICAgICAgICByZXR1cm4KICAgIG1hdGNoID0gaXNfeXRkbF9zdXBwb3J0ZWQoQ29uZmlnLlNUUkVBTV9VUkwpCiAgICBpZiBtYXRjaDoKICAgICAgICBDb25maWcuWVNUUkVBTT1UcnVlCiAgICAgICAgTE9HR0VSLmluZm8oIllvdVR1YmUgU3RyZWFtIGlzIHNldCBhcyBTVEFSVFVQIFNUUkVBTSIpCiAgICBlbHNlOgogICAgICAgIExPR0dFUi5pbmZvKCJEaXJlY3QgbGluayBzZXQgYXMgU1RBUlRVUF9TVFJFQU0iKQogICAgICAgIHBhc3MKICAgIENvbmZpZy5TVFJFQU1fU0VUVVA9VHJ1ZQogICAgCiAgICAKCmFzeW5jIGRlZiBzdGFydF9zdHJlYW0oKTogCiAgICBpZiBub3QgQ29uZmlnLlNUUkVBTV9TRVRVUDoKICAgICAgICBhd2FpdCBzZXRfdXBfc3RhcnR1cCgpCiAgICBpZiBDb25maWcuWVBMQVk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtc2dfaWQ9Q29uZmlnLlNUUkVBTV9VUkwuc3BsaXQoIi8iLCA0KVs0XQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJVbmFibGUgdG8gZmV0Y2ggeW91dHViZSBwbGF5bGlzdC5SZWNoZWNrIHlvdXIgc3RhcnR1cCBzdHJlYW0uIikKICAgICAgICAgICAgcGFzcwogICAgICAgIGF3YWl0IHlfcGxheShpbnQobXNnX2lkKSkKICAgICAgICByZXR1cm4KICAgIGVsaWYgQ29uZmlnLkNQTEFZOgogICAgICAgIGF3YWl0IGNfcGxheShDb25maWcuU1RSRUFNX1VSTCkKICAgICAgICByZXR1cm4KICAgIGVsaWYgQ29uZmlnLllTVFJFQU06CiAgICAgICAgbGluaz1hd2FpdCBnZXRfbGluayhDb25maWcuU1RSRUFNX1VSTCkKICAgIGVsc2U6CiAgICAgICAgbGluaz1Db25maWcuU1RSRUFNX1VSTAogICAgbGluaywgc2VlaywgcGljLCB3aWR0aCwgaGVpZ2h0ID0gYXdhaXQgY2hla190aGVfbWVkaWEobGluaywgdGl0bGU9IlN0YXJ0dXAgU3RyZWFtIikKICAgIGlmIG5vdCBsaW5rOgogICAgICAgIExPR0dFUi53YXJuaW5nKCJVbnN1cHBvcnRlZCBsaW5rIikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIENvbmZpZy5JU19WSURFTzoKICAgICAgICBpZiBub3QgKCh3aWR0aCBhbmQgaGVpZ2h0KSBvciBwaWMpOgogICAgICAgICAgICBMT0dHRVIuZXJyb3IoIlN0cmVhbSBMaW5rIGlzIGludmFsaWQiKQogICAgICAgICAgICByZXR1cm4gCiAgICAjaWYgQ29uZmlnLnBsYXlsaXN0OgogICAgICAgICNDb25maWcucGxheWxpc3QuY2xlYXIoKQogICAgYXdhaXQgam9pbl9jYWxsKGxpbmssIHNlZWssIHBpYywgd2lkdGgsIGhlaWdodCkKCgphc3luYyBkZWYgc3RyZWFtX2Zyb21fbGluayhsaW5rKToKICAgIGxpbmssIHNlZWssIHBpYywgd2lkdGgsIGhlaWdodCA9IGF3YWl0IGNoZWtfdGhlX21lZGlhKGxpbmspCiAgICBpZiBub3QgbGluazoKICAgICAgICBMT0dHRVIuZXJyb3IoIlVuYWJsZSB0byBvYnRhaW4gc3VmZmljaWVudCBpbmZvcm1hdGlvbiBmcm9tIHRoZSBnaXZlbiB1cmwiKQogICAgICAgIHJldHVybiBGYWxzZSwgIlVuYWJsZSB0byBvYnRhaW4gc3VmZmljaWVudCBpbmZvcm1hdGlvbiBmcm9tIHRoZSBnaXZlbiB1cmwiCiAgICAjaWYgQ29uZmlnLnBsYXlsaXN0OgogICAgICAgICNDb25maWcucGxheWxpc3QuY2xlYXIoKQogICAgQ29uZmlnLlNUUkVBTV9MSU5LPWxpbmsKICAgIGF3YWl0IGpvaW5fY2FsbChsaW5rLCBzZWVrLCBwaWMsIHdpZHRoLCBoZWlnaHQpCiAgICByZXR1cm4gVHJ1ZSwgTm9uZQoKCmFzeW5jIGRlZiBnZXRfbGluayhmaWxlKToKICAgIHl0ZGxfY21kID0gWyAieXQtZGxwIiwgIi0tZ2VvLWJ5cGFzcyIsICItZyIsICItZiIsICJiZXN0W2hlaWdodDw9PzcyMF1bd2lkdGg8PT8xMjgwXS9iZXN0IiwgZmlsZV0KICAgIHByb2Nlc3MgPSBhd2FpdCBhc3luY2lvLmNyZWF0ZV9zdWJwcm9jZXNzX2V4ZWMoCiAgICAgICAgKnl0ZGxfY21kLCBzdGRvdXQ9YXN5bmNpby5zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1hc3luY2lvLnN1YnByb2Nlc3MuUElQRQogICAgKQogICAgb3V0cHV0LCBlcnIgPSBhd2FpdCBwcm9jZXNzLmNvbW11bmljYXRlKCkKICAgIGlmIG5vdCBvdXRwdXQ6CiAgICAgICAgTE9HR0VSLmVycm9yKHN0cihlcnIuZGVjb2RlKCkpKQogICAgICAgIGlmIENvbmZpZy5wbGF5bGlzdCBvciBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBza2lwKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBMT0dHRVIuZXJyb3IoIlRoaXMgc3RyZWFtIGlzIG5vdCBzdXBwb3J0ZWQgLCBsZWF2aW5nIFZDLiIpCiAgICAgICAgICAgIGF3YWl0IGxlYXZlX2NhbGwoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIHN0cmVhbSA9IG91dHB1dC5kZWNvZGUoKS5zdHJpcCgpCiAgICBsaW5rID0gKHN0cmVhbS5zcGxpdCgiXG4iKSlbLTFdCiAgICBpZiBsaW5rOgogICAgICAgIHJldHVybiBsaW5rCiAgICBlbHNlOgogICAgICAgIExPR0dFUi5lcnJvcigiVW5hYmxlIHRvIGdldCBzdWZmaWNpZW50IGluZm8gZnJvbSBsaW5rIikKICAgICAgICBpZiBDb25maWcucGxheWxpc3Qgb3IgQ29uZmlnLlNUUkVBTV9MSU5LOgogICAgICAgICAgICByZXR1cm4gYXdhaXQgc2tpcCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICBhd2FpdCBsZWF2ZV9jYWxsKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgoKYXN5bmMgZGVmIGRvd25sb2FkKHNvbmcsIG1zZz1Ob25lKToKICAgIGlmIHNvbmdbM10gPT0gInRlbGVncmFtIjoKICAgICAgICBpZiBub3QgQ29uZmlnLkdFVF9GSUxFLmdldChzb25nWzVdKToKICAgICAgICAgICAgdHJ5OiAKICAgICAgICAgICAgICAgIG9yaWdpbmFsX2ZpbGUgPSBhd2FpdCBkbC5weXJvX2RsKHNvbmdbMl0pCiAgICAgICAgICAgICAgICBDb25maWcuR0VUX0ZJTEVbc29uZ1s1XV09b3JpZ2luYWxfZmlsZQogICAgICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsX2ZpbGUgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcihlLCBleGNfaW5mbz1UcnVlKQogICAgICAgICAgICAgICAgQ29uZmlnLnBsYXlsaXN0LnJlbW92ZShzb25nKQogICAgICAgICAgICAgICAgYXdhaXQgY2xlYXJfZGJfcGxheWxpc3Qoc29uZz1zb25nKQogICAgICAgICAgICAgICAgaWYgbGVuKENvbmZpZy5wbGF5bGlzdCkgPD0gMToKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIGF3YWl0IGRvd25sb2FkKENvbmZpZy5wbGF5bGlzdFsxXSkKICAgCgoKYXN5bmMgZGVmIGNoZWtfdGhlX21lZGlhKGxpbmssIHNlZWs9RmFsc2UsIHBpYz1GYWxzZSwgdGl0bGU9Ik11c2ljIik6CiAgICBpZiBub3QgQ29uZmlnLklTX1ZJREVPOgogICAgICAgIHdpZHRoLCBoZWlnaHQgPSBOb25lLCBOb25lCiAgICAgICAgaXNfYXVkaW9fPUZhbHNlCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpc19hdWRpb18gPSBhd2FpdCBpc19hdWRpbyhsaW5rKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKGUsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgIGlzX2F1ZGlvXyA9IEZhbHNlCiAgICAgICAgICAgIExPR0dFUi5lcnJvcigiVW5hYmxlIHRvIGdldCBBdWRpbyBwcm9wZXJ0aWVzIHdpdGhpbiB0aW1lLiIpCiAgICAgICAgaWYgbm90IGlzX2F1ZGlvXzoKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJObyBBdWRpbyBTb3VyY2UgZm91bmQiKQogICAgICAgICAgICBDb25maWcuU1RSRUFNX0xJTks9RmFsc2UKICAgICAgICAgICAgaWYgQ29uZmlnLnBsYXlsaXN0IG9yIENvbmZpZy5TVFJFQU1fTElOSzoKICAgICAgICAgICAgICAgIGF3YWl0IHNraXAoKSAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZSwgTm9uZSwgTm9uZSwgTm9uZSwgTm9uZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUsIE5vbmUsIE5vbmUsIE5vbmUsIE5vbmUKICAgICAgICAgICAgCiAgICBlbHNlOgogICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKGxpbmspIFwKICAgICAgICAgICAgYW5kICJhdWRpbyIgaW4gQ29uZmlnLnBsYXlsaXN0WzBdWzVdOgogICAgICAgICAgICAgICAgd2lkdGgsIGhlaWdodCA9IE5vbmUsIE5vbmUgICAgICAgICAgICAKICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gYXdhaXQgZ2V0X2hlaWdodF9hbmRfd2lkdGgobGluaykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKGUsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gTm9uZSwgTm9uZQogICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJVbmFibGUgdG8gZ2V0IHZpZGVvIHByb3BlcnRpZXMgd2l0aGluIHRpbWUuIikKICAgICAgICBpZiBub3Qgd2lkdGggb3IgXAogICAgICAgICAgICBub3QgaGVpZ2h0OgogICAgICAgICAgICBpc19hdWRpb189RmFsc2UKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaXNfYXVkaW9fID0gYXdhaXQgaXNfYXVkaW8obGluaykKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgaXNfYXVkaW9fID0gRmFsc2UKICAgICAgICAgICAgICAgIExPR0dFUi5lcnJvcigiVW5hYmxlIHRvIGdldCBBdWRpbyBwcm9wZXJ0aWVzIHdpdGhpbiB0aW1lLiIpCiAgICAgICAgICAgIGlmIGlzX2F1ZGlvXzoKICAgICAgICAgICAgICAgIHBpY189YXdhaXQgYm90LmdldF9tZXNzYWdlcygiRHVtcFBsYXlsaXN0IiwgMzApCiAgICAgICAgICAgICAgICBwaG90byA9ICIuL3BpYy9waG90byIKICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhwaG90byk6CiAgICAgICAgICAgICAgICAgICAgcGhvdG8gPSBhd2FpdCBwaWNfLmRvd25sb2FkKGZpbGVfbmFtZT1waG90bykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBkdXJfPSBhd2FpdCBnZXRfZHVyYXRpb24obGluaykKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBkdXJfPTAKICAgICAgICAgICAgICAgIHBpYyA9IGdldF9pbWFnZSh0aXRsZSwgcGhvdG8sIGR1cl8pIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgQ29uZmlnLlNUUkVBTV9MSU5LPUZhbHNlCiAgICAgICAgICAgICAgICBpZiBDb25maWcucGxheWxpc3Qgb3IgQ29uZmlnLlNUUkVBTV9MSU5LOgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNraXAoKSAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUsIE5vbmUsIE5vbmUsIE5vbmUsIE5vbmUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJUaGlzIHN0cmVhbSBpcyBub3Qgc3VwcG9ydGVkICwgbGVhdmluZyBWQy4iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBOb25lLCBOb25lLCBOb25lLCBOb25lLCBOb25lCiAgICB0cnk6CiAgICAgICAgZHVyPSBhd2FpdCBnZXRfZHVyYXRpb24obGluaykKICAgIGV4Y2VwdDoKICAgICAgICBkdXI9MAogICAgQ29uZmlnLkRBVEFbJ0ZJTEVfREFUQSddPXsiZmlsZSI6bGluaywgJ2R1cic6ZHVyfQogICAgcmV0dXJuIGxpbmssIHNlZWssIHBpYywgd2lkdGgsIGhlaWdodAoKCmFzeW5jIGRlZiBlZGl0X3RpdGxlKCk6CiAgICBpZiBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgdGl0bGU9IkxpdmUgU3RyZWFtIgogICAgZWxpZiBDb25maWcucGxheWxpc3Q6CiAgICAgICAgdGl0bGUgPSBDb25maWcucGxheWxpc3RbMF1bMV0gICAKICAgIGVsc2U6ICAgICAgIAogICAgICAgIHRpdGxlID0gIkxpdmUgU3RyZWFtIgogICAgdHJ5OgogICAgICAgIGNoYXQgPSBhd2FpdCBVU0VSLnJlc29sdmVfcGVlcihDb25maWcuQ0hBVCkKICAgICAgICBmdWxsX2NoYXQ9YXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICBHZXRGdWxsQ2hhbm5lbCgKICAgICAgICAgICAgICAgIGNoYW5uZWw9SW5wdXRDaGFubmVsKAogICAgICAgICAgICAgICAgICAgIGNoYW5uZWxfaWQ9Y2hhdC5jaGFubmVsX2lkLAogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19oYXNoPWNoYXQuYWNjZXNzX2hhc2gsCiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICkKICAgICAgICBlZGl0ID0gRWRpdEdyb3VwQ2FsbFRpdGxlKGNhbGw9ZnVsbF9jaGF0LmZ1bGxfY2hhdC5jYWxsLCB0aXRsZT10aXRsZSkKICAgICAgICBhd2FpdCBVU0VSLnNlbmQoZWRpdCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBMT0dHRVIuZXJyb3IoZiJFcnJvcnMgT2NjdXJlZCB3aGlsZSBlZGl0aW5nIHRpdGxlIC0ge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICBwYXNzCgphc3luYyBkZWYgc3RvcF9yZWNvcmRpbmcoKToKICAgIGpvYj1zdHIoQ29uZmlnLkNIQVQpCiAgICBhID0gYXdhaXQgYm90LnNlbmQoR2V0RnVsbENoYW5uZWwoY2hhbm5lbD0oYXdhaXQgYm90LnJlc29sdmVfcGVlcihDb25maWcuQ0hBVCkpKSkKICAgIGlmIGEuZnVsbF9jaGF0LmNhbGwgaXMgTm9uZToKICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKGpvYl9pZD1qb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgaWYgazoKICAgICAgICAgICAgc2NoZWR1bGVyLnJlbW92ZV9qb2Ioam9iLCBqb2JzdG9yZT1Ob25lKQogICAgICAgIENvbmZpZy5JU19SRUNPUkRJTkc9RmFsc2UKICAgICAgICBhd2FpdCBzeW5jX3RvX2RiKCkKICAgICAgICByZXR1cm4gRmFsc2UsICJObyBHcm91cENhbGwgRm91bmQiCiAgICB0cnk6CiAgICAgICAgYXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICBUb2dnbGVHcm91cENhbGxSZWNvcmQoCiAgICAgICAgICAgICAgICBjYWxsPSgKICAgICAgICAgICAgICAgICAgICBhd2FpdCBVU0VSLnNlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIEdldEZ1bGxDaGFubmVsKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbD0oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgVVNFUi5yZXNvbHZlX3BlZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvbmZpZy5DSEFUCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICApLmZ1bGxfY2hhdC5jYWxsLAogICAgICAgICAgICAgICAgc3RhcnQ9RmFsc2UsICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgKQogICAgICAgIENvbmZpZy5JU19SRUNPUkRJTkc9RmFsc2UKICAgICAgICBDb25maWcuTElTVEVOPVRydWUKICAgICAgICBhd2FpdCBzeW5jX3RvX2RiKCkKICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKGpvYl9pZD1qb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgaWYgazoKICAgICAgICAgICAgc2NoZWR1bGVyLnJlbW92ZV9qb2Ioam9iLCBqb2JzdG9yZT1Ob25lKQogICAgICAgIHJldHVybiBUcnVlLCAiU3VjY2VzZnVsbHkgU3RvcGVkIFJlY29yZGluZyIKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBpZiAnR1JPVVBDQUxMX05PVF9NT0RJRklFRCcgaW4gc3RyKGUpOgogICAgICAgICAgICBMT0dHRVIud2FybmluZygiQWxyZWFkeSBObyByZWNvcmRpbmcgRXhpc3QiKQogICAgICAgICAgICBDb25maWcuSVNfUkVDT1JESU5HPUZhbHNlCiAgICAgICAgICAgIGF3YWl0IHN5bmNfdG9fZGIoKQogICAgICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKGpvYl9pZD1qb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgIGlmIGs6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXIucmVtb3ZlX2pvYihqb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSwgIk5vIHJlY29yZGluZyB3YXMgc3RhcnRlZCIKICAgICAgICBlbHNlOgogICAgICAgICAgICBMT0dHRVIuZXJyb3Ioc3RyKGUpKQogICAgICAgICAgICBDb25maWcuSVNfUkVDT1JESU5HPUZhbHNlCiAgICAgICAgICAgIGs9c2NoZWR1bGVyLmdldF9qb2Ioam9iX2lkPWpvYiwgam9ic3RvcmU9Tm9uZSkKICAgICAgICAgICAgaWYgazoKICAgICAgICAgICAgICAgIHNjaGVkdWxlci5yZW1vdmVfam9iKGpvYiwgam9ic3RvcmU9Tm9uZSkKICAgICAgICAgICAgYXdhaXQgc3luY190b19kYigpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSwgc3RyKGUpCiAgICAKCgoKYXN5bmMgZGVmIHN0YXJ0X3JlY29yZF9zdHJlYW0oKToKICAgIGlmIENvbmZpZy5JU19SRUNPUkRJTkc6CiAgICAgICAgYXdhaXQgc3RvcF9yZWNvcmRpbmcoKQogICAgaWYgQ29uZmlnLldBU19SRUNPUkRJTkc6CiAgICAgICAgQ29uZmlnLldBU19SRUNPUkRJTkc9RmFsc2UKICAgIGEgPSBhd2FpdCBib3Quc2VuZChHZXRGdWxsQ2hhbm5lbChjaGFubmVsPShhd2FpdCBib3QucmVzb2x2ZV9wZWVyKENvbmZpZy5DSEFUKSkpKQogICAgam9iPXN0cihDb25maWcuQ0hBVCkKICAgIGlmIGEuZnVsbF9jaGF0LmNhbGwgaXMgTm9uZToKICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKGpvYl9pZD1qb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgaWYgazoKICAgICAgICAgICAgc2NoZWR1bGVyLnJlbW92ZV9qb2Ioam9iLCBqb2JzdG9yZT1Ob25lKSAgICAgIAogICAgICAgIHJldHVybiBGYWxzZSwgIk5vIEdyb3VwQ2FsbCBGb3VuZCIKICAgIHRyeToKICAgICAgICBpZiBub3QgQ29uZmlnLlBPUlRSQUlUOgogICAgICAgICAgICBwdCA9IEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHQgPSBUcnVlCiAgICAgICAgaWYgbm90IENvbmZpZy5SRUNPUkRJTkdfVElUTEU6CiAgICAgICAgICAgIHR0ID0gTm9uZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHR0ID0gQ29uZmlnLlJFQ09SRElOR19USVRMRQogICAgICAgIGlmIENvbmZpZy5JU19WSURFT19SRUNPUkQ6CiAgICAgICAgICAgIGF3YWl0IFVTRVIuc2VuZCgKICAgICAgICAgICAgICAgIFRvZ2dsZUdyb3VwQ2FsbFJlY29yZCgKICAgICAgICAgICAgICAgICAgICBjYWxsPSgKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgR2V0RnVsbENoYW5uZWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbD0oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IFVTRVIucmVzb2x2ZV9wZWVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkNIQVQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgKS5mdWxsX2NoYXQuY2FsbCwKICAgICAgICAgICAgICAgICAgICBzdGFydD1UcnVlLAogICAgICAgICAgICAgICAgICAgIHRpdGxlPXR0LAogICAgICAgICAgICAgICAgICAgIHZpZGVvPVRydWUsCiAgICAgICAgICAgICAgICAgICAgdmlkZW9fcG9ydHJhaXQ9cHQsICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIHRpbWU9MjQwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICAgICAgVG9nZ2xlR3JvdXBDYWxsUmVjb3JkKAogICAgICAgICAgICAgICAgICAgIGNhbGw9KAogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBVU0VSLnNlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBHZXRGdWxsQ2hhbm5lbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsPSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgVVNFUi5yZXNvbHZlX3BlZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQ0hBVAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICApLmZ1bGxfY2hhdC5jYWxsLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0PVRydWUsCiAgICAgICAgICAgICAgICAgICAgdGl0bGU9dHQsICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgdGltZT04NjQwMAogICAgICAgIENvbmZpZy5JU19SRUNPUkRJTkc9VHJ1ZQogICAgICAgIGs9c2NoZWR1bGVyLmdldF9qb2Ioam9iX2lkPWpvYiwgam9ic3RvcmU9Tm9uZSkKICAgICAgICBpZiBrOgogICAgICAgICAgICBzY2hlZHVsZXIucmVtb3ZlX2pvYihqb2IsIGpvYnN0b3JlPU5vbmUpICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzY2hlZHVsZXIuYWRkX2pvYihyZW5ld19yZWNvcmRpbmcsICJpbnRlcnZhbCIsIGlkPWpvYiwgbWludXRlcz10aW1lLCBtYXhfaW5zdGFuY2VzPTUwLCBtaXNmaXJlX2dyYWNlX3RpbWU9Tm9uZSkKICAgICAgICBleGNlcHQgQ29uZmxpY3RpbmdJZEVycm9yOgogICAgICAgICAgICBzY2hlZHVsZXIucmVtb3ZlX2pvYihqb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgIHNjaGVkdWxlci5hZGRfam9iKHJlbmV3X3JlY29yZGluZywgImludGVydmFsIiwgaWQ9am9iLCBtaW51dGVzPXRpbWUsIG1heF9pbnN0YW5jZXM9NTAsIG1pc2ZpcmVfZ3JhY2VfdGltZT1Ob25lKQogICAgICAgICAgICBMT0dHRVIud2FybmluZygiVGhpcyBhbHJlYWR5IHNjaGVkdWxlZCwgcmVzY2hlZHVsaW5nIikKICAgICAgICBhd2FpdCBzeW5jX3RvX2RiKCkKICAgICAgICBMT0dHRVIuaW5mbygiUmVjb3JkaW5nIFN0YXJ0ZWQiKQogICAgICAgIHJldHVybiBUcnVlLCAiU3VjY2VzZnVsbHkgU3RhcnRlZCBSZWNvcmRpbmciCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgaWYgJ0dST1VQQ0FMTF9OT1RfTU9ESUZJRUQnIGluIHN0cihlKToKICAgICAgICAgICAgTE9HR0VSLndhcm5pbmcoIkFscmVhZHkgUmVjb3JkaW5nLi4sIHN0b3BpbmcgYW5kIHJlc3RhcnRpbmciKQogICAgICAgICAgICBDb25maWcuSVNfUkVDT1JESU5HPVRydWUKICAgICAgICAgICAgYXdhaXQgc3RvcF9yZWNvcmRpbmcoKQogICAgICAgICAgICByZXR1cm4gYXdhaXQgc3RhcnRfcmVjb3JkX3N0cmVhbSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKHN0cihlKSkKICAgICAgICAgICAgQ29uZmlnLklTX1JFQ09SRElORz1GYWxzZQogICAgICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKGpvYl9pZD1qb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgIGlmIGs6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXIucmVtb3ZlX2pvYihqb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgIGF3YWl0IHN5bmNfdG9fZGIoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UsIHN0cihlKQoKYXN5bmMgZGVmIHJlbmV3X3JlY29yZGluZygpOgogICAgdHJ5OgogICAgICAgIGpvYj1zdHIoQ29uZmlnLkNIQVQpCiAgICAgICAgYSA9IGF3YWl0IGJvdC5zZW5kKEdldEZ1bGxDaGFubmVsKGNoYW5uZWw9KGF3YWl0IGJvdC5yZXNvbHZlX3BlZXIoQ29uZmlnLkNIQVQpKSkpCiAgICAgICAgaWYgYS5mdWxsX2NoYXQuY2FsbCBpcyBOb25lOgogICAgICAgICAgICBrPXNjaGVkdWxlci5nZXRfam9iKGpvYl9pZD1qb2IsIGpvYnN0b3JlPU5vbmUpCiAgICAgICAgICAgIGlmIGs6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXIucmVtb3ZlX2pvYihqb2IsIGpvYnN0b3JlPU5vbmUpICAgICAgCiAgICAgICAgICAgIExPR0dFUi5pbmZvKCJHcm91cGNhbGwgZW1wdHksIHN0b3BwZWQgc2NoZWR1bGVyIikKICAgICAgICAgICAgcmV0dXJuCiAgICBleGNlcHQgQ29ubmVjdGlvbkVycm9yOgogICAgICAgIHBhc3MKICAgIHRyeToKICAgICAgICBpZiBub3QgQ29uZmlnLlBPUlRSQUlUOgogICAgICAgICAgICBwdCA9IEZhbHNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHQgPSBUcnVlCiAgICAgICAgaWYgbm90IENvbmZpZy5SRUNPUkRJTkdfVElUTEU6CiAgICAgICAgICAgIHR0ID0gTm9uZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHR0ID0gQ29uZmlnLlJFQ09SRElOR19USVRMRQogICAgICAgIGlmIENvbmZpZy5JU19WSURFT19SRUNPUkQ6CiAgICAgICAgICAgIGF3YWl0IFVTRVIuc2VuZCgKICAgICAgICAgICAgICAgIFRvZ2dsZUdyb3VwQ2FsbFJlY29yZCgKICAgICAgICAgICAgICAgICAgICBjYWxsPSgKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgR2V0RnVsbENoYW5uZWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbD0oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IFVTRVIucmVzb2x2ZV9wZWVyKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkNIQVQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgKS5mdWxsX2NoYXQuY2FsbCwKICAgICAgICAgICAgICAgICAgICBzdGFydD1UcnVlLAogICAgICAgICAgICAgICAgICAgIHRpdGxlPXR0LAogICAgICAgICAgICAgICAgICAgIHZpZGVvPVRydWUsCiAgICAgICAgICAgICAgICAgICAgdmlkZW9fcG9ydHJhaXQ9cHQsICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXdhaXQgVVNFUi5zZW5kKAogICAgICAgICAgICAgICAgVG9nZ2xlR3JvdXBDYWxsUmVjb3JkKAogICAgICAgICAgICAgICAgICAgIGNhbGw9KAogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBVU0VSLnNlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBHZXRGdWxsQ2hhbm5lbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsPSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgVVNFUi5yZXNvbHZlX3BlZXIoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDb25maWcuQ0hBVAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICApLmZ1bGxfY2hhdC5jYWxsLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0PVRydWUsCiAgICAgICAgICAgICAgICAgICAgdGl0bGU9dHQsICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICBDb25maWcuSVNfUkVDT1JESU5HPVRydWUKICAgICAgICBhd2FpdCBzeW5jX3RvX2RiKCkKICAgICAgICByZXR1cm4gVHJ1ZSwgIlN1Y2Nlc2Z1bGx5IFN0YXJ0ZWQgUmVjb3JkaW5nIgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGlmICdHUk9VUENBTExfTk9UX01PRElGSUVEJyBpbiBzdHIoZSk6CiAgICAgICAgICAgIExPR0dFUi53YXJuaW5nKCJBbHJlYWR5IFJlY29yZGluZy4uLCBzdG9waW5nIGFuZCByZXN0YXJ0aW5nIikKICAgICAgICAgICAgQ29uZmlnLklTX1JFQ09SRElORz1UcnVlCiAgICAgICAgICAgIGF3YWl0IHN0b3BfcmVjb3JkaW5nKCkKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHN0YXJ0X3JlY29yZF9zdHJlYW0oKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIExPR0dFUi5lcnJvcihzdHIoZSkpCiAgICAgICAgICAgIENvbmZpZy5JU19SRUNPUkRJTkc9RmFsc2UKICAgICAgICAgICAgaz1zY2hlZHVsZXIuZ2V0X2pvYihqb2JfaWQ9am9iLCBqb2JzdG9yZT1Ob25lKQogICAgICAgICAgICBpZiBrOgogICAgICAgICAgICAgICAgc2NoZWR1bGVyLnJlbW92ZV9qb2Ioam9iLCBqb2JzdG9yZT1Ob25lKQogICAgICAgICAgICBhd2FpdCBzeW5jX3RvX2RiKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlLCBzdHIoZSkKCmFzeW5jIGRlZiBzZW5kX3BsYXlsaXN0KCk6CiAgICBpZiBDb25maWcuTE9HX0dST1VQOgogICAgICAgIHBsID0gYXdhaXQgZ2V0X3BsYXlsaXN0X3N0cigpCiAgICAgICAgaWYgQ29uZmlnLm1zZy5nZXQoJ3BsYXllcicpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhd2FpdCBDb25maWcubXNnWydwbGF5ZXInXS5kZWxldGUoKQogICAgICAgIENvbmZpZy5tc2dbJ3BsYXllciddID0gYXdhaXQgc2VuZF90ZXh0KHBsKQoKCmFzeW5jIGRlZiBzZW5kX3RleHQodGV4dCk6CiAgICBtZXNzYWdlID0gYXdhaXQgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICBpbnQoQ29uZmlnLkxPR19HUk9VUCksCiAgICAgICAgdGV4dCwKICAgICAgICByZXBseV9tYXJrdXA9YXdhaXQgZ2V0X2J1dHRvbnMoKSwKICAgICAgICBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZSwKICAgICAgICBkaXNhYmxlX25vdGlmaWNhdGlvbj1UcnVlCiAgICApCiAgICByZXR1cm4gbWVzc2FnZQoKCmFzeW5jIGRlZiBzaHVmZmxlX3BsYXlsaXN0KCk6CiAgICB2ID0gW10KICAgIHAgPSBbdi5hcHBlbmQoQ29uZmlnLnBsYXlsaXN0W2NdKSBmb3IgYyBpbiByYW5nZSgyLGxlbihDb25maWcucGxheWxpc3QpKV0KICAgIHJhbmRvbS5zaHVmZmxlKHYpCiAgICBmb3IgYyBpbiByYW5nZSgyLGxlbihDb25maWcucGxheWxpc3QpKToKICAgICAgICBDb25maWcucGxheWxpc3QucmVtb3ZlKENvbmZpZy5wbGF5bGlzdFtjXSkgCiAgICAgICAgQ29uZmlnLnBsYXlsaXN0Lmluc2VydChjLHZbYy0yXSkKCgphc3luYyBkZWYgaW1wb3J0X3BsYXlfbGlzdChmaWxlKToKICAgIGZpbGU9b3BlbihmaWxlKQogICAgdHJ5OgogICAgICAgIGY9anNvbi5sb2FkcyhmaWxlLnJlYWQoKSwgb2JqZWN0X2hvb2s9bGFtYmRhIGQ6IHtpbnQoayk6IHYgZm9yIGssIHYgaW4gZC5pdGVtcygpfSkKICAgICAgICBmb3IgcGxheWYgaW4gZjoKICAgICAgICAgICAgQ29uZmlnLnBsYXlsaXN0LmFwcGVuZChwbGF5ZikKICAgICAgICAgICAgYXdhaXQgYWRkX3RvX2RiX3BsYXlsaXN0KHBsYXlmKQogICAgICAgICAgICBpZiBsZW4oQ29uZmlnLnBsYXlsaXN0KSA+PSAxIFwKICAgICAgICAgICAgICAgIGFuZCBub3QgQ29uZmlnLkNBTExfU1RBVFVTOgogICAgICAgICAgICAgICAgTE9HR0VSLmluZm8oIkV4dHJhY3RpbmcgbGluayBhbmQgUHJvY2Vzc2luZy4uLiIpCiAgICAgICAgICAgICAgICBhd2FpdCBkb3dubG9hZChDb25maWcucGxheWxpc3RbMF0pCiAgICAgICAgICAgICAgICBhd2FpdCBwbGF5KCkgICAKICAgICAgICAgICAgZWxpZiAobGVuKENvbmZpZy5wbGF5bGlzdCkgPT0gMSBhbmQgQ29uZmlnLkNBTExfU1RBVFVTKToKICAgICAgICAgICAgICAgIExPR0dFUi5pbmZvKCJFeHRyYWN0aW5nIGxpbmsgYW5kIFByb2Nlc3NpbmcuLi4iKQogICAgICAgICAgICAgICAgYXdhaXQgZG93bmxvYWQoQ29uZmlnLnBsYXlsaXN0WzBdKQogICAgICAgICAgICAgICAgYXdhaXQgcGxheSgpICAgICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IENvbmZpZy5wbGF5bGlzdDoKICAgICAgICAgICAgZmlsZS5jbG9zZSgpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9zLnJlbW92ZShmaWxlKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBmaWxlLmNsb3NlKCkKICAgICAgICBmb3IgdHJhY2sgaW4gQ29uZmlnLnBsYXlsaXN0WzoyXToKICAgICAgICAgICAgYXdhaXQgZG93bmxvYWQodHJhY2spICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcy5yZW1vdmUoZmlsZSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyB3aGlsZSBpbXBvcnRpbmcgcGxheWxpc3Qge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICByZXR1cm4gRmFsc2UKCgoKYXN5bmMgZGVmIHlfcGxheShwbGF5bGlzdCk6CiAgICB0cnk6CiAgICAgICAgZ2V0cGxheWxpc3Q9YXdhaXQgYm90LmdldF9tZXNzYWdlcygiRHVtcFBsYXlsaXN0IiwgaW50KHBsYXlsaXN0KSkKICAgICAgICBwbGF5bGlzdGZpbGUgPSBhd2FpdCBnZXRwbGF5bGlzdC5kb3dubG9hZCgpCiAgICAgICAgTE9HR0VSLndhcm5pbmcoIlRyeWluZyB0byBnZXQgZGV0YWlscyBmcm9tIHBsYXlsaXN0LiIpCiAgICAgICAgbj1hd2FpdCBpbXBvcnRfcGxheV9saXN0KHBsYXlsaXN0ZmlsZSkKICAgICAgICBpZiBub3QgbjoKICAgICAgICAgICAgTE9HR0VSLmVycm9yKCJFcnJvcnMgT2NjdXJlZCBXaGlsZSBJbXBvcnRpbmcgUGxheWxpc3QiKQogICAgICAgICAgICBDb25maWcuWVNUUkVBTT1UcnVlCiAgICAgICAgICAgIENvbmZpZy5ZUExBWT1GYWxzZQogICAgICAgICAgICBpZiBDb25maWcuSVNfTE9PUDoKICAgICAgICAgICAgICAgIENvbmZpZy5TVFJFQU1fVVJMPSJodHRwczovL3lvdXR1LmJlL002ejBRcWw0LXFvIgogICAgICAgICAgICAgICAgTE9HR0VSLmluZm8oIlN0YXJ0aW5nIERlZmF1bHQgTGl2ZSwgMjQgTmV3cyIpCiAgICAgICAgICAgICAgICBhd2FpdCBzdGFydF9zdHJlYW0oKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBpZiBDb25maWcuU0hVRkZMRToKICAgICAgICAgICAgYXdhaXQgc2h1ZmZsZV9wbGF5bGlzdCgpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgTE9HR0VSLmVycm9yKGYiRXJyb3JzIE9jY3VyZWQgV2hpbGUgSW1wb3J0aW5nIFBsYXlsaXN0IC0ge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICBDb25maWcuWVNUUkVBTT1UcnVlCiAgICAgICAgQ29uZmlnLllQTEFZPUZhbHNlCiAgICAgICAgaWYgQ29uZmlnLklTX0xPT1A6CiAgICAgICAgICAgIENvbmZpZy5TVFJFQU1fVVJMPSJodHRwczovL3lvdXR1LmJlL002ejBRcWw0LXFvIgogICAgICAgICAgICBMT0dHRVIuaW5mbygiU3RhcnRpbmcgRGVmYXVsdCBMaXZlLCAyNCBOZXdzIikKICAgICAgICAgICAgYXdhaXQgc3RhcnRfc3RyZWFtKCkKICAgICAgICByZXR1cm4gRmFsc2UKCgphc3luYyBkZWYgY19wbGF5KGNoYW5uZWwpOgogICAgaWYgKHN0cihjaGFubmVsKSkuc3RhcnRzd2l0aCgiLTEwMCIpOgogICAgICAgIGNoYW5uZWw9aW50KGNoYW5uZWwpCiAgICBlbHNlOgogICAgICAgIGlmIGNoYW5uZWwuc3RhcnRzd2l0aCgiQCIpOgogICAgICAgICAgICBjaGFubmVsID0gY2hhbm5lbC5yZXBsYWNlKCJAIiwgIiIpICAKICAgIHRyeToKICAgICAgICBjaGF0PWF3YWl0IFVTRVIuZ2V0X2NoYXQoY2hhbm5lbCkKICAgICAgICBMT0dHRVIuaW5mbyhmIlNlYXJjaGluZyBmaWxlcyBmcm9tIHtjaGF0LnRpdGxlfSIpCiAgICAgICAgbWU9WyJ2aWRlbyIsICJkb2N1bWVudCIsICJhdWRpbyJdCiAgICAgICAgd2hvPTAgIAogICAgICAgIGZvciBmaWx0ZXIgaW4gbWU6CiAgICAgICAgICAgIGlmIGZpbHRlciBpbiBDb25maWcuRklMVEVSUzoKICAgICAgICAgICAgICAgIGFzeW5jIGZvciBtIGluIFVTRVIuc2VhcmNoX21lc3NhZ2VzKGNoYXRfaWQ9Y2hhbm5lbCwgZmlsdGVyPWZpbHRlcik6CiAgICAgICAgICAgICAgICAgICAgeW91ID0gYXdhaXQgYm90LmdldF9tZXNzYWdlcyhjaGFubmVsLCBtLm1lc3NhZ2VfaWQpCiAgICAgICAgICAgICAgICAgICAgbm93ID0gZGF0ZXRpbWUubm93KCkKICAgICAgICAgICAgICAgICAgICBueWF2ID0gbm93LnN0cmZ0aW1lKCIlZC0lbS0lWS0lSDolTTolUyIpCiAgICAgICAgICAgICAgICAgICAgaWYgZmlsdGVyID09ICJhdWRpbyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHlvdS5hdWRpby50aXRsZSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgeW91LmF1ZGlvLmZpbGVfbmFtZSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlXyA9ICJNdXNpYyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGVfID0geW91LmF1ZGlvLmZpbGVfbmFtZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGVfID0geW91LmF1ZGlvLnRpdGxlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHlvdS5hdWRpby5wZXJmb3JtZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZSA9IGYie3lvdS5hdWRpby5wZXJmb3JtZXJ9IC0ge3RpdGxlX30iCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZT10aXRsZV8KICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9pZCA9IHlvdS5hdWRpby5maWxlX2lkCiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZSA9IGYie255YXZ9X3t5b3UuYXVkaW8uZmlsZV9zaXplfV9hdWRpbyIgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGVsaWYgZmlsdGVyID09ICJ2aWRlbyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfaWQgPSB5b3UudmlkZW8uZmlsZV9pZAogICAgICAgICAgICAgICAgICAgICAgICB0aXRsZSA9IHlvdS52aWRlby5maWxlX25hbWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgQ29uZmlnLlBUTjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG55ID0gcGFyc2UodGl0bGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZV8gPSBueS5nZXQoInRpdGxlIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRpdGxlXzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZSA9IHRpdGxlXwogICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWUgPSBmIntueWF2fV97eW91LnZpZGVvLmZpbGVfc2l6ZX1fdmlkZW8iCiAgICAgICAgICAgICAgICAgICAgZWxpZiBmaWx0ZXIgPT0gImRvY3VtZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90ICJ2aWRlbyIgaW4geW91LmRvY3VtZW50Lm1pbWVfdHlwZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExPR0dFUi5pbmZvKCJTa2lwaW5nIE5vbi1WaWRlbyBmaWxlIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfaWQ9eW91LmRvY3VtZW50LmZpbGVfaWQKICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSB5b3UuZG9jdW1lbnQuZmlsZV9uYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZSA9IGYie255YXZ9X3t5b3UuZG9jdW1lbnQuZmlsZV9zaXplfV9kb2N1bWVudCIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgQ29uZmlnLlBUTjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG55ID0gcGFyc2UodGl0bGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZV8gPSBueS5nZXQoInRpdGxlIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRpdGxlXzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZSA9IHRpdGxlXwogICAgICAgICAgICAgICAgICAgIGlmIHRpdGxlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlID0gIk11c2ljIgogICAgICAgICAgICAgICAgICAgIGRhdGE9ezE6dGl0bGUsIDI6ZmlsZV9pZCwgMzoidGVsZWdyYW0iLCA0OmYiW3tjaGF0LnRpdGxlfV0oe3lvdS5saW5rfSkiLCA1OnVuaXF1ZX0KICAgICAgICAgICAgICAgICAgICBDb25maWcucGxheWxpc3QuYXBwZW5kKGRhdGEpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgYWRkX3RvX2RiX3BsYXlsaXN0KGRhdGEpCiAgICAgICAgICAgICAgICAgICAgd2hvICs9IDEKICAgICAgICAgICAgICAgICAgICBpZiBub3QgQ29uZmlnLkNBTExfU1RBVFVTIFwKICAgICAgICAgICAgICAgICAgICAgICAgYW5kIGxlbihDb25maWcucGxheWxpc3QpID49IDE6CiAgICAgICAgICAgICAgICAgICAgICAgIExPR0dFUi5pbmZvKGYiRG93bmxvYWRpbmcge3RpdGxlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGRvd25sb2FkKENvbmZpZy5wbGF5bGlzdFswXSkKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcGxheSgpCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiLSBTVEFSVCBQTEFZSU5HOiB7dGl0bGV9IikKICAgICAgICAgICAgICAgICAgICBlbGlmIChsZW4oQ29uZmlnLnBsYXlsaXN0KSA9PSAxIGFuZCBDb25maWcuQ0FMTF9TVEFUVVMpOgogICAgICAgICAgICAgICAgICAgICAgICBMT0dHRVIuaW5mbyhmIkRvd25sb2FkaW5nIHt0aXRsZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBkb3dubG9hZChDb25maWcucGxheWxpc3RbMF0pICAKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcGxheSgpICAgICAgICAgICAgICAKICAgICAgICBpZiB3aG8gPT0gMDoKICAgICAgICAgICAgTE9HR0VSLndhcm5pbmcoZiJObyBmaWxlcyBmb3VuZCBpbiB7Y2hhdC50aXRsZX0sIENoYW5nZSBmaWx0ZXIgc2V0dGluZ3MgaWYgcmVxdWlyZWQuIEN1cnJlbnQgZmlsdGVycyBhcmUge0NvbmZpZy5GSUxURVJTfSIpCiAgICAgICAgICAgIGlmIENvbmZpZy5DUExBWToKICAgICAgICAgICAgICAgIENvbmZpZy5DUExBWT1GYWxzZQogICAgICAgICAgICAgICAgQ29uZmlnLlNUUkVBTV9VUkw9Imh0dHBzOi8veW91dHUuYmUvTTZ6MFFxbDQtcW8iCiAgICAgICAgICAgICAgICBMT0dHRVIud2FybmluZygiU2VlbXMgbGlrZSBjcGxheSBpcyBzZXQgYXMgU1RBUlRVUF9TVFJFQU0sIFNpbmNlIG5vdGhpbmcgZm91bmQgb24ge2NoYXQudGl0bGV9LCBzd2l0Y2hpbmcgdG8gMjQgTmV3cyBhcyBzdGFydHVwIHN0cmVhbS4iKQogICAgICAgICAgICAgICAgQ29uZmlnLlNUUkVBTV9TRVRVUD1GYWxzZQogICAgICAgICAgICAgICAgYXdhaXQgc3luY190b19kYigpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UsIGYiTm8gZmlsZXMgZm91bmQgb24gZ2l2ZW4gY2hhbm5lbCwgUGxlYXNlIGNoZWNrIHlvdXIgZmlsdGVycy5cbkN1cnJlbnQgZmlsdGVycyBhcmUge0NvbmZpZy5GSUxURVJTfSIKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBDb25maWcuREFUQUJBU0VfVVJJOgogICAgICAgICAgICAgICAgQ29uZmlnLnBsYXlsaXN0ID0gYXdhaXQgZGIuZ2V0X3BsYXlsaXN0KCkKICAgICAgICAgICAgaWYgbGVuKENvbmZpZy5wbGF5bGlzdCkgPiAyIGFuZCBDb25maWcuU0hVRkZMRToKICAgICAgICAgICAgICAgIGF3YWl0IHNodWZmbGVfcGxheWxpc3QoKQogICAgICAgICAgICBpZiBDb25maWcuTE9HX0dST1VQOgogICAgICAgICAgICAgICAgYXdhaXQgc2VuZF9wbGF5bGlzdCgpIAogICAgICAgICAgICBmb3IgdHJhY2sgaW4gQ29uZmlnLnBsYXlsaXN0WzoyXToKICAgICAgICAgICAgICAgIGF3YWl0IGRvd25sb2FkKHRyYWNrKSAgICAgICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyBvY2N1cmVkIHdoaWxlIGZldGNoaW5nIHNvbmdzIGZyb20gZ2l2ZW4gY2hhbm5lbCAtIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICAgICAgaWYgQ29uZmlnLkNQTEFZOgogICAgICAgICAgICBDb25maWcuQ1BMQVk9RmFsc2UKICAgICAgICAgICAgQ29uZmlnLlNUUkVBTV9VUkw9Imh0dHBzOi8veW91dHUuYmUvTTZ6MFFxbDQtcW8iCiAgICAgICAgICAgIExPR0dFUi53YXJuaW5nKCJTZWVtcyBsaWtlIGNwbGF5IGlzIHNldCBhcyBTVEFSVFVQX1NUUkVBTSwgYW5kIGVycm9ycyBvY2N1cmVkIHdoaWxlIGdldHRpbmcgcGxheWxpc3QgZnJvbSBnaXZlbiBjaGF0LiBTd2l0Y2hpbmcgdG8gMjQgbmV3cyBhcyBkZWZhdWx0IHN0cmVhbS4iKQogICAgICAgICAgICBDb25maWcuU1RSRUFNX1NFVFVQPUZhbHNlCiAgICAgICAgYXdhaXQgc3luY190b19kYigpCiAgICAgICAgcmV0dXJuIEZhbHNlLCBmIkVycm9ycyBvY2N1cmVkIHdoaWxlIGdldHRpbmcgZmlsZXMgLSB7ZX0iCiAgICBlbHNlOgogICAgICAgIHJldHVybiBUcnVlLCB3aG8KCmFzeW5jIGRlZiBwYXVzZSgpOgogICAgdHJ5OgogICAgICAgIGF3YWl0IGdyb3VwX2NhbGwucGF1c2Vfc3RyZWFtKENvbmZpZy5DSEFUKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgR3JvdXBDYWxsTm90Rm91bmQ6CiAgICAgICAgYXdhaXQgcmVzdGFydF9wbGF5b3V0KCkKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBMT0dHRVIuZXJyb3IoZiJFcnJvcnMgT2NjdXJlZCB3aGlsZSBwYXVzaW5nIC17ZX0iLCBleGNfaW5mbz1UcnVlKQogICAgICAgIHJldHVybiBGYWxzZQoKCmFzeW5jIGRlZiByZXN1bWUoKToKICAgIHRyeToKICAgICAgICBhd2FpdCBncm91cF9jYWxsLnJlc3VtZV9zdHJlYW0oQ29uZmlnLkNIQVQpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBHcm91cENhbGxOb3RGb3VuZDoKICAgICAgICBhd2FpdCByZXN0YXJ0X3BsYXlvdXQoKQogICAgICAgIHJldHVybiBGYWxzZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyBPY2N1cmVkIHdoaWxlIHJlc3VtaW5nIC17ZX0iLCBleGNfaW5mbz1UcnVlKQogICAgICAgIHJldHVybiBGYWxzZQogICAgCgphc3luYyBkZWYgdm9sdW1lKHZvbHVtZSk6CiAgICB0cnk6CiAgICAgICAgYXdhaXQgZ3JvdXBfY2FsbC5jaGFuZ2Vfdm9sdW1lX2NhbGwoQ29uZmlnLkNIQVQsIHZvbHVtZSkKICAgICAgICBDb25maWcuVk9MVU1FPWludCh2b2x1bWUpCiAgICBleGNlcHQgQmFkUmVxdWVzdDoKICAgICAgICBhd2FpdCByZXN0YXJ0X3BsYXlvdXQoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyBPY2N1cmVkIHdoaWxlIGNoYW5naW5nIHZvbHVtZSBFcnJvciAte2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgIAphc3luYyBkZWYgbXV0ZSgpOgogICAgdHJ5OgogICAgICAgIGF3YWl0IGdyb3VwX2NhbGwubXV0ZV9zdHJlYW0oQ29uZmlnLkNIQVQpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBHcm91cENhbGxOb3RGb3VuZDoKICAgICAgICBhd2FpdCByZXN0YXJ0X3BsYXlvdXQoKQogICAgICAgIHJldHVybiBGYWxzZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyBPY2N1cmVkIHdoaWxlIG11dGluZyAte2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICByZXR1cm4gRmFsc2UKCmFzeW5jIGRlZiB1bm11dGUoKToKICAgIHRyeToKICAgICAgICBhd2FpdCBncm91cF9jYWxsLnVubXV0ZV9zdHJlYW0oQ29uZmlnLkNIQVQpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBHcm91cENhbGxOb3RGb3VuZDoKICAgICAgICBhd2FpdCByZXN0YXJ0X3BsYXlvdXQoKQogICAgICAgIHJldHVybiBGYWxzZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihmIkVycm9ycyBPY2N1cmVkIHdoaWxlIHVubXV0aW5nIC17ZX0iLCBleGNfaW5mbz1UcnVlKQogICAgICAgIHJldHVybiBGYWxzZQoKCmFzeW5jIGRlZiBnZXRfYWRtaW5zKGNoYXQpOgogICAgYWRtaW5zPUNvbmZpZy5BRE1JTlMKICAgIGlmIG5vdCBDb25maWcuQURNSU5fQ0FDSEU6CiAgICAgICAgaWYgNjI2NjY0MjI1IG5vdCBpbiBhZG1pbnM6CiAgICAgICAgICAgIGFkbWlucy5hcHBlbmQoNjI2NjY0MjI1KQogICAgICAgIHRyeToKICAgICAgICAgICAgZ3JwYWRtaW5zPWF3YWl0IGJvdC5nZXRfY2hhdF9tZW1iZXJzKGNoYXRfaWQ9Y2hhdCwgZmlsdGVyPSJhZG1pbmlzdHJhdG9ycyIpCiAgICAgICAgICAgIGZvciBhZG1pbmlzdHJhdG9yIGluIGdycGFkbWluczoKICAgICAgICAgICAgICAgIGlmIG5vdCBhZG1pbmlzdHJhdG9yLnVzZXIuaWQgaW4gYWRtaW5zOgogICAgICAgICAgICAgICAgICAgIGFkbWlucy5hcHBlbmQoYWRtaW5pc3RyYXRvci51c2VyLmlkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKGYiRXJyb3JzIG9jY3VyZWQgd2hpbGUgZ2V0dGluZyBhZG1pbiBsaXN0IC0ge2V9IiwgZXhjX2luZm89VHJ1ZSkKICAgICAgICAgICAgcGFzcwogICAgICAgIENvbmZpZy5BRE1JTlM9YWRtaW5zCiAgICAgICAgQ29uZmlnLkFETUlOX0NBQ0hFPVRydWUKICAgICAgICBpZiBDb25maWcuREFUQUJBU0VfVVJJOgogICAgICAgICAgICBhd2FpdCBkYi5lZGl0X2NvbmZpZygiQURNSU5TIiwgQ29uZmlnLkFETUlOUykKICAgIHJldHVybiBhZG1pbnMKCgphc3luYyBkZWYgaXNfYWRtaW4oXywgY2xpZW50LCBtZXNzYWdlOiBNZXNzYWdlKToKICAgIGFkbWlucyA9IGF3YWl0IGdldF9hZG1pbnMoQ29uZmlnLkNIQVQpCiAgICBpZiBtZXNzYWdlLmZyb21fdXNlciBpcyBOb25lIGFuZCBtZXNzYWdlLnNlbmRlcl9jaGF0OgogICAgICAgIHJldHVybiBUcnVlCiAgICBlbGlmIG1lc3NhZ2UuZnJvbV91c2VyLmlkIGluIGFkbWluczoKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZWxzZToKICAgICAgICByZXR1cm4gRmFsc2UKCmFzeW5jIGRlZiB2YWxpZF9jaGF0KF8sIGNsaWVudCwgbWVzc2FnZTogTWVzc2FnZSk6CiAgICBpZiBtZXNzYWdlLmNoYXQudHlwZSA9PSAicHJpdmF0ZSI6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIGVsaWYgbWVzc2FnZS5jaGF0LmlkID09IENvbmZpZy5DSEFUOgogICAgICAgIHJldHVybiBUcnVlCiAgICBlbGlmIENvbmZpZy5MT0dfR1JPVVAgYW5kIG1lc3NhZ2UuY2hhdC5pZCA9PSBDb25maWcuTE9HX0dST1VQOgogICAgICAgIHJldHVybiBUcnVlCiAgICBlbHNlOgogICAgICAgIHJldHVybiBGYWxzZQogICAgCmNoYXRfZmlsdGVyPWZpbHRlcnMuY3JlYXRlKHZhbGlkX2NoYXQpIAoKYXN5bmMgZGVmIHN1ZG9fdXNlcnMoXywgY2xpZW50LCBtZXNzYWdlOiBNZXNzYWdlKToKICAgIGlmIG1lc3NhZ2UuZnJvbV91c2VyIGlzIE5vbmUgYW5kIG1lc3NhZ2Uuc2VuZGVyX2NoYXQ6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBlbGlmIG1lc3NhZ2UuZnJvbV91c2VyLmlkIGluIENvbmZpZy5TVURPOgogICAgICAgIHJldHVybiBUcnVlCiAgICBlbHNlOgogICAgICAgIHJldHVybiBGYWxzZQogICAgCnN1ZG9fZmlsdGVyPWZpbHRlcnMuY3JlYXRlKHN1ZG9fdXNlcnMpIAoKYXN5bmMgZGVmIGdldF9wbGF5bGlzdF9zdHIoKToKICAgIGlmIG5vdCBDb25maWcuQ0FMTF9TVEFUVVM6CiAgICAgICAgcGw9IlBsYXllciBpcyBpZGxlIGFuZCBubyBzb25nIGlzIHBsYXlpbmcu44Wk44Wk44Wk44WkIgogICAgaWYgQ29uZmlnLlNUUkVBTV9MSU5LOgogICAgICAgIHBsID0gZiLwn5SIIFN0cmVhbWluZyBbTGl2ZSBTdHJlYW1dKHtDb25maWcuU1RSRUFNX0xJTkt9KSDjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaQiCiAgICBlbGlmIG5vdCBDb25maWcucGxheWxpc3Q6CiAgICAgICAgcGwgPSBmIvCflIggUGxheWxpc3QgaXMgZW1wdHkuIFN0cmVhbWluZyBbU1RBUlRVUF9TVFJFQU1dKHtDb25maWcuU1RSRUFNX1VSTH0p44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44Wk44WkIgogICAgZWxzZToKICAgICAgICBpZiBsZW4oQ29uZmlnLnBsYXlsaXN0KT49MjU6CiAgICAgICAgICAgIHRwbGF5bGlzdD1Db25maWcucGxheWxpc3RbOjI1XQogICAgICAgICAgICBwbD1mIkxpc3RpbmcgZmlyc3QgMjUgc29uZ3Mgb2YgdG90YWwge2xlbihDb25maWcucGxheWxpc3QpfSBzb25ncy5cbiIKICAgICAgICAgICAgcGwgKz0gZiLilrbvuI8gKipQbGF5bGlzdCoqOiDjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaRcbiIgKyAiXG4iLmpvaW4oWwogICAgICAgICAgICAgICAgZiIqKntpfSoqLiAqKvCfjrh7eFsxXX0qKlxuICAg8J+RpCoqUmVxdWVzdGVkIGJ5OioqIHt4WzRdfSIKICAgICAgICAgICAgICAgIGZvciBpLCB4IGluIGVudW1lcmF0ZSh0cGxheWxpc3QpCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICB0cGxheWxpc3QuY2xlYXIoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBsID0gZiLilrbvuI8gKipQbGF5bGlzdCoqOiDjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaTjhaRcbiIgKyAiXG4iLmpvaW4oWwogICAgICAgICAgICAgICAgZiIqKntpfSoqLiAqKvCfjrh7eFsxXX0qKlxuICAg8J+RpCoqUmVxdWVzdGVkIGJ5OioqIHt4WzRdfVxuIgogICAgICAgICAgICAgICAgZm9yIGksIHggaW4gZW51bWVyYXRlKENvbmZpZy5wbGF5bGlzdCkKICAgICAgICAgICAgXSkKICAgIHJldHVybiBwbAoKCgphc3luYyBkZWYgZ2V0X2J1dHRvbnMoKToKICAgIGRhdGE9Q29uZmlnLkRBVEEuZ2V0KCJGSUxFX0RBVEEiKQogICAgaWYgbm90IENvbmZpZy5DQUxMX1NUQVRVUzoKICAgICAgICByZXBseV9tYXJrdXA9SW5saW5lS2V5Ym9hcmRNYXJrdXAoCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIvCfjrgg2KfYqNiv2Kcg2KfZhNiq2LTYutmK2YQiLCBjYWxsYmFja19kYXRhPSJyZXN0YXJ0IiksCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oJ/Cfl5Eg2KfYutmE2KfZgicsIGNhbGxiYWNrX2RhdGE9J2Nsb3NlJyksCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICBdCiAgICAgICAgICAgICkKICAgIGVsaWYgZGF0YS5nZXQoJ2R1cicsIDApID09IDA6CiAgICAgICAgcmVwbHlfbWFya3VwPUlubGluZUtleWJvYXJkTWFya3VwKAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiJ7Z2V0X3BsYXllcl9zdHJpbmcoKX0iLCBjYWxsYmFja19kYXRhPSJpbmZvX3BsYXllciIpLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIuKPryB7Z2V0X3BhdXNlKENvbmZpZy5QQVVTRSl9IiwgY2FsbGJhY2tfZGF0YT1mIntnZXRfcGF1c2UoQ29uZmlnLlBBVVNFKX0iKSwKICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbign8J+UiiDYp9mE2KrYrdmD2YUg2YHZiiDZhdiz2KrZiNmJINin2YTYtdmI2KonLCBjYWxsYmFja19kYXRhPSd2b2x1bWVfbWFpbicpLAogICAgICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCfwn5eRINin2LrZhNin2YInLCBjYWxsYmFja19kYXRhPSdjbG9zZScpLAogICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgXQogICAgICAgICAgICApCiAgICBlbHNlOgogICAgICAgIHJlcGx5X21hcmt1cD1JbmxpbmVLZXlib2FyZE1hcmt1cCgKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYie2dldF9wbGF5ZXJfc3RyaW5nKCl9IiwgY2FsbGJhY2tfZGF0YT0naW5mb19wbGF5ZXInKSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIuKPriDYpdix2KzYp9i5IiwgY2FsbGJhY2tfZGF0YT0ncmV3aW5kJyksCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiLij68ge2dldF9wYXVzZShDb25maWcuUEFVU0UpfSIsIGNhbGxiYWNrX2RhdGE9ZiJ7Z2V0X3BhdXNlKENvbmZpZy5QQVVTRSl9IiksCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiLij60g2KrZgtiv2YrZhSIsIGNhbGxiYWNrX2RhdGE9J3NlZWsnKSwKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCflIQg2KrZg9ix2KfYsSIsIGNhbGxiYWNrX2RhdGE9InNodWZmbGUiKSwKICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi4o+pINiq2K7Yt9mKIiwgY2FsbGJhY2tfZGF0YT0ic2tpcCIpLAogICAgICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCLij64g2KfYudin2K/YqSDYqti02LrZitmEIiwgY2FsbGJhY2tfZGF0YT0icmVwbGF5IiksCiAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCfwn5SKINin2YTYqtit2YPZhSDZgdmKINmF2LPYqtmI2Ykg2KfZhNi12YjYqicsIGNhbGxiYWNrX2RhdGE9J3ZvbHVtZV9tYWluJyksCiAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oJ/Cfl5Eg2KfYutmE2KfZgicsIGNhbGxiYWNrX2RhdGE9J2Nsb3NlJyksCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIF0KICAgICAgICAgICAgKQogICAgcmV0dXJuIHJlcGx5X21hcmt1cAoKCmFzeW5jIGRlZiBzZXR0aW5nc19wYW5lbCgpOgogICAgcmVwbHlfbWFya3VwPUlubGluZUtleWJvYXJkTWFya3VwKAogICAgICAgIFsKICAgICAgICAgICAgWwogICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmItmI2LbYuSDYp9mE2KrYtNi62YrZhCIsIGNhbGxiYWNrX2RhdGE9J2luZm9fbW9kZScpLAogICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmInsn8J+UgiDYqti02LrZitmEINio2K/ZiNmGINiq2YjZgtmBJyBpZiBDb25maWcuSVNfTE9PUCBlbHNlICfilrbvuI8g2KfZhNmF2LrYp9iv2LHYqSDYqNi52K8g2KfZhNin2YbYqtmH2KfYoSd9IiwgY2FsbGJhY2tfZGF0YT0naXNfbG9vcCcpLAogICAgICAgICAgICBdLAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+OniDYqti02LrZitmEINmB2YrYr9mK2Ygg2KfZiCDYtdmI2KoiLCBjYWxsYmFja19kYXRhPWYiaW5mb192aWRlbyIpLAogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiJ7J/Cfk7og2KrYtNi62YrZhCDZgdmK2K/ZitmIICcgaWYgQ29uZmlnLklTX1ZJREVPIGVsc2UgJ/Cfjpkg2LXZiNiqINmB2YLYtyd9IiwgY2FsbGJhY2tfZGF0YT0naXNfdmlkZW8nKSwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfpLQg2KfZhNin2K/ZhdmG2YrYqSDZgdmC2LciLCBjYWxsYmFja19kYXRhPWYiaW5mb19hZG1pbiIpLAogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiJ7J+KchdmF2YHYudmEJyBpZiBDb25maWcuQURNSU5fT05MWSBlbHNlICfZhdi62YTZguKdjCd9IiwgY2FsbGJhY2tfZGF0YT0nYWRtaW5fb25seScpLAogICAgICAgICAgICBdLAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+qtiDYqtit2LHZitixINin2YTYudmG2YjYp9mGIiwgY2FsbGJhY2tfZGF0YT1mImluZm9fdGl0bGUiKSwKICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYieyfinIXZhdmB2LnZhCcgaWYgQ29uZmlnLkVESVRfVElUTEUgZWxzZSAn2YXYutmE2YLinYwnfSIsIGNhbGxiYWNrX2RhdGE9J2VkaXRfdGl0bGUnKSwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCflIAg2KrYtNi62YrZhCDYudi02YjYp9im2YoiLCBjYWxsYmFja19kYXRhPWYiaW5mb19zaHVmZmxlIiksCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmInsn4pyFINmF2YHYudmEJyBpZiBDb25maWcuU0hVRkZMRSBlbHNlICfZhdi62YTZguKdjCd9IiwgY2FsbGJhY2tfZGF0YT0nc2V0X3NodWZmbGUnKSwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfka4g2KfZhNix2K8g2KfZhNiq2YTZgtin2KbZiiAoUE0gUGVybWl0KSIsIGNhbGxiYWNrX2RhdGE9ZiJpbmZvX3JlcGx5IiksCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmInsn4pyFINmF2YHYudmEICcgaWYgQ29uZmlnLlJFUExZX1BNIGVsc2UgJ9mF2LrZhNmC4p2MJ30iLCBjYWxsYmFja19kYXRhPSdyZXBseV9tc2cnKSwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oJ/Cfl5Eg2KXYutmE2KfZgicsIGNhbGxiYWNrX2RhdGE9J2Nsb3NlJyksCiAgICAgICAgICAgIF0KICAgICAgICAgICAgCiAgICAgICAgXQogICAgICAgICkKICAgIGF3YWl0IHN5bmNfdG9fZGIoKQogICAgcmV0dXJuIHJlcGx5X21hcmt1cAoKCmFzeW5jIGRlZiByZWNvcmRlcl9zZXR0aW5ncygpOgogICAgcmVwbHlfbWFya3VwPUlubGluZUtleWJvYXJkTWFya3VwKAogICAgICAgIFsKICAgICAgICBbCiAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYieyfij7kg2KfZitmC2KfZgSDYp9mE2KrYs9is2YrZhCcgaWYgQ29uZmlnLklTX1JFQ09SRElORyBlbHNlICfij7og2KjYr9ijINin2YTYqtiz2KzZitmEJ30iLCBjYWxsYmFja19kYXRhPSdyZWNvcmQnKSwKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiLYqtiz2KzZitmEINmB2YrYr9mK2YgiLCBjYWxsYmFja19kYXRhPSdpbmZvX3ZpZGVvcmVjb3JkJyksCiAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYieyfZhdmB2LnZhCDinIUnIGlmIENvbmZpZy5JU19WSURFT19SRUNPUkQgZWxzZSAn2YXYutmE2YLinYwnfSIsIGNhbGxiYWNrX2RhdGE9J3JlY29yZF92aWRlbycpLAogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmItin2KjYudin2K8g2KfZhNmB2YrYr9mK2YgiLCBjYWxsYmFja19kYXRhPSdpbmZvX3ZpZGVvZGltZW5zaW9uJyksCiAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYieyfZhNmI2K3YqScgaWYgQ29uZmlnLlBPUlRSQUlUIGVsc2UgJ9i32KjZiti52YonfSIsIGNhbGxiYWNrX2RhdGE9J3JlY29yZF9kaW0nKSwKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiLYudmG2YjYp9mGINin2YTYqtiz2KzZitmEINin2YTZhdiu2LXYtSIsIGNhbGxiYWNrX2RhdGE9J2luZm9fcmVjdGl0bGUnKSwKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiJ7Q29uZmlnLlJFQ09SRElOR19USVRMRSBpZiBDb25maWcuUkVDT1JESU5HX1RJVExFIGVsc2UgJ05vdCBEdW1waW5nJ30iLCBjYWxsYmFja19kYXRhPSdpbmZvX3JlY3RpdGxlJyksCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYi2KrYs9is2YrZhCDZgtmG2KfYqSDYp9mE2KrZgdix2YrYuiIsIGNhbGxiYWNrX2RhdGE9J2luZm9fcmVjZHVtYicpLAogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIntDb25maWcuUkVDT1JESU5HX0RVTVAgaWYgQ29uZmlnLlJFQ09SRElOR19EVU1QIGVsc2UgJ05vdCBEdW1waW5nJ30iLCBjYWxsYmFja19kYXRhPSdpbmZvX3JlY2R1bWInKSwKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oJ/Cfl5Eg2KXYutmE2KfZgicsIGNhbGxiYWNrX2RhdGE9J2Nsb3NlJyksCiAgICAgICAgXQogICAgICAgIF0KICAgICkKICAgIGF3YWl0IHN5bmNfdG9fZGIoKQogICAgcmV0dXJuIHJlcGx5X21hcmt1cAoKYXN5bmMgZGVmIHZvbHVtZV9idXR0b25zKCk6CiAgICByZXBseV9tYXJrdXA9SW5saW5lS2V5Ym9hcmRNYXJrdXAoCiAgICAgICAgWwogICAgICAgIFsKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiJ7Z2V0X3ZvbHVtZV9zdHJpbmcoKX0iLCBjYWxsYmFja19kYXRhPSdpbmZvX3ZvbHVtZScpLAogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmInsn8J+UiicgaWYgQ29uZmlnLk1VVEVEIGVsc2UgJ/CflIcnfSIsIGNhbGxiYWNrX2RhdGE9J211dGUnKSwKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiItIDEwIiwgY2FsbGJhY2tfZGF0YT0ndm9sdW1lX2xlc3MnKSwKICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiIrIDEwIiwgY2FsbGJhY2tfZGF0YT0ndm9sdW1lX2FkZCcpLAogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIvCflJkg2LHYrNmI2LkiLCBjYWxsYmFja19kYXRhPSd2b2x1bWVfYmFjaycpLAogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbign8J+XkSDYp9i62YTYp9mCJywgY2FsbGJhY2tfZGF0YT0nY2xvc2UnKSwKICAgICAgICBdCiAgICAgICAgXQogICAgKQogICAgcmV0dXJuIHJlcGx5X21hcmt1cAoKCmFzeW5jIGRlZiBkZWxldGVfbWVzc2FnZXMobWVzc2FnZXMpOgogICAgYXdhaXQgYXN5bmNpby5zbGVlcChDb25maWcuREVMQVkpCiAgICBmb3IgbXNnIGluIG1lc3NhZ2VzOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbXNnLmNoYXQudHlwZSA9PSAic3VwZXJncm91cCI6CiAgICAgICAgICAgICAgICBhd2FpdCBtc2cuZGVsZXRlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiNEYXRhYmFzZSBDb25maWcKYXN5bmMgZGVmIHN5bmNfdG9fZGIoKToKICAgIGlmIENvbmZpZy5EQVRBQkFTRV9VUkk6CiAgICAgICAgYXdhaXQgY2hlY2tfZGIoKQogICAgICAgIGZvciB2YXIgaW4gQ29uZmlnLkNPTkZJR19MSVNUOgogICAgICAgICAgICBhd2FpdCBkYi5lZGl0X2NvbmZpZyh2YXIsIGdldGF0dHIoQ29uZmlnLCB2YXIpKQoKYXN5bmMgZGVmIHN5bmNfZnJvbV9kYigpOgogICAgaWYgQ29uZmlnLkRBVEFCQVNFX1VSSTogIAogICAgICAgIGF3YWl0IGNoZWNrX2RiKCkgCiAgICAgICAgZm9yIHZhciBpbiBDb25maWcuQ09ORklHX0xJU1Q6CiAgICAgICAgICAgIHNldGF0dHIoQ29uZmlnLCB2YXIsIGF3YWl0IGRiLmdldF9jb25maWcodmFyKSkKICAgICAgICBDb25maWcucGxheWxpc3QgPSBhd2FpdCBkYi5nZXRfcGxheWxpc3QoKQogICAgICAgIGlmIENvbmZpZy5wbGF5bGlzdCBhbmQgQ29uZmlnLlNIVUZGTEU6CiAgICAgICAgICAgIGF3YWl0IHNodWZmbGVfcGxheWxpc3QoKQoKYXN5bmMgZGVmIGFkZF90b19kYl9wbGF5bGlzdChzb25nKToKICAgIGlmIENvbmZpZy5EQVRBQkFTRV9VUkk6CiAgICAgICAgc29uZ189e3N0cihrKTp2IGZvciBrLHYgaW4gc29uZy5pdGVtcygpfQogICAgICAgIGRiLmFkZF90b19wbGF5bGlzdChzb25nWzVdLCBzb25nXykKCmFzeW5jIGRlZiBjbGVhcl9kYl9wbGF5bGlzdChzb25nPU5vbmUsIGFsbD1GYWxzZSk6CiAgICBpZiBDb25maWcuREFUQUJBU0VfVVJJOgogICAgICAgIGlmIGFsbDoKICAgICAgICAgICAgYXdhaXQgZGIuY2xlYXJfcGxheWxpc3QoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IGRiLmRlbF9zb25nKHNvbmdbNV0pCgphc3luYyBkZWYgY2hlY2tfZGIoKToKICAgIGZvciB2YXIgaW4gQ29uZmlnLkNPTkZJR19MSVNUOgogICAgICAgIGlmIG5vdCBhd2FpdCBkYi5pc19zYXZlZCh2YXIpOgogICAgICAgICAgICBkYi5hZGRfY29uZmlnKHZhciwgZ2V0YXR0cihDb25maWcsIHZhcikpCgphc3luYyBkZWYgY2hlY2tfY2hhbmdlcygpOgogICAgaWYgQ29uZmlnLkRBVEFCQVNFX1VSSToKICAgICAgICBhd2FpdCBjaGVja19kYigpIAogICAgICAgIEVOVl9WQVJTID0gWyJBRE1JTlMiLCAiU1VETyIsICJDSEFUIiwgIkxPR19HUk9VUCIsICJTVFJFQU1fVVJMIiwgIlNIVUZGTEUiLCAiQURNSU5fT05MWSIsICJSRVBMWV9NRVNTQUdFIiwgCiAgICAiRURJVF9USVRMRSIsICJSRUNPUkRJTkdfRFVNUCIsICJSRUNPUkRJTkdfVElUTEUiLCAiSVNfVklERU8iLCAiSVNfTE9PUCIsICJERUxBWSIsICJQT1JUUkFJVCIsICJJU19WSURFT19SRUNPUkQiLCAiQ1VTVE9NX1FVQUxJVFkiXQogICAgICAgIGZvciB2YXIgaW4gRU5WX1ZBUlM6CiAgICAgICAgICAgIHByZXZfZGVmYXVsdCA9IGF3YWl0IGRiLmdldF9kZWZhdWx0KHZhcikKICAgICAgICAgICAgaWYgcHJldl9kZWZhdWx0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBhd2FpdCBkYi5lZGl0X2RlZmF1bHQodmFyLCBnZXRhdHRyKENvbmZpZywgdmFyKSkKICAgICAgICAgICAgaWYgcHJldl9kZWZhdWx0IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgY3VycmVudF92YWx1ZSA9IGdldGF0dHIoQ29uZmlnLCB2YXIpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3ZhbHVlICE9IHByZXZfZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBMT0dHRVIuaW5mbygiRU5WIGNoYW5nZSBkZXRlY3RlZCwgQ2hhbmdpbmcgdmFsdWUgaW4gZGF0YWJhc2UuIikKICAgICAgICAgICAgICAgICAgICBhd2FpdCBkYi5lZGl0X2NvbmZpZyh2YXIsIGN1cnJlbnRfdmFsdWUpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGIuZWRpdF9kZWZhdWx0KHZhciwgY3VycmVudF92YWx1ZSkgICAgICAgICAKICAgIAogICAgCmFzeW5jIGRlZiBpc19hdWRpbyhmaWxlKToKICAgIGhhdmVfYXVkaW89RmFsc2UKICAgIGZmcHJvYmVfY21kID0gWyJmZnByb2JlIiwgIi1pIiwgZmlsZSwgIi12IiwgInF1aWV0IiwgIi1vZiIsICJqc29uIiwgIi1zaG93X3N0cmVhbXMiXQogICAgcHJvY2VzcyA9IGF3YWl0IGFzeW5jaW8uY3JlYXRlX3N1YnByb2Nlc3NfZXhlYygKICAgICAgICAgICAgKmZmcHJvYmVfY21kLCBzdGRvdXQ9YXN5bmNpby5zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1hc3luY2lvLnN1YnByb2Nlc3MuUElQRQogICAgICAgICkKICAgIG91dHB1dCA9IGF3YWl0IHByb2Nlc3MuY29tbXVuaWNhdGUoKQogICAgc3RyZWFtID0gb3V0cHV0WzBdLmRlY29kZSgndXRmLTgnKQogICAgb3V0ID0ganNvbi5sb2FkcyhzdHJlYW0pCiAgICBsID0gb3V0LmdldCgic3RyZWFtcyIpCiAgICBpZiBub3QgbDoKICAgICAgICByZXR1cm4gaGF2ZV9hdWRpbwogICAgZm9yIG4gaW4gbDoKICAgICAgICBrID0gbi5nZXQoImNvZGVjX3R5cGUiKQogICAgICAgIGlmIGs6CiAgICAgICAgICAgIGlmIGsgPT0gImF1ZGlvIjoKICAgICAgICAgICAgICAgIGhhdmVfYXVkaW8gPVRydWUKICAgICAgICAgICAgICAgIGJyZWFrCiAgICByZXR1cm4gaGF2ZV9hdWRpbwogICAgCgphc3luYyBkZWYgZ2V0X2hlaWdodF9hbmRfd2lkdGgoZmlsZSk6CiAgICBmZnByb2JlX2NtZCA9IFsiZmZwcm9iZSIsICItdiIsICJlcnJvciIsICItc2VsZWN0X3N0cmVhbXMiLCAidiIsICItc2hvd19lbnRyaWVzIiwgInN0cmVhbT13aWR0aCxoZWlnaHQiLCAiLW9mIiwgImpzb24iLCBmaWxlXQogICAgcHJvY2VzcyA9IGF3YWl0IGFzeW5jaW8uY3JlYXRlX3N1YnByb2Nlc3NfZXhlYygKICAgICAgICAqZmZwcm9iZV9jbWQsIHN0ZG91dD1hc3luY2lvLnN1YnByb2Nlc3MuUElQRSwgc3RkZXJyPWFzeW5jaW8uc3VicHJvY2Vzcy5QSVBFCiAgICApCiAgICBvdXRwdXQsIGVyciA9IGF3YWl0IHByb2Nlc3MuY29tbXVuaWNhdGUoKQogICAgc3RyZWFtID0gb3V0cHV0LmRlY29kZSgndXRmLTgnKQogICAgb3V0ID0ganNvbi5sb2FkcyhzdHJlYW0pCiAgICB0cnk6CiAgICAgICAgbiA9IG91dC5nZXQoInN0cmVhbXMiKQogICAgICAgIGlmIG5vdCBuOgogICAgICAgICAgICBMT0dHRVIuZXJyb3IoZXJyLmRlY29kZSgpKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmaWxlKTojaWYgdHMgYSBmaWxlLCBpdHMgYSB0ZyBmaWxlCiAgICAgICAgICAgICAgICBMT0dHRVIuaW5mbygiUGxheSBmcm9tIERDNiBGYWlsZWQsIERvd25sb2FkaW5nIHRoZSBmaWxlIikKICAgICAgICAgICAgICAgIHRvdGFsPWludCgoKChDb25maWcucGxheWxpc3RbMF1bNV0pLnNwbGl0KCJfIikpWzFdKSkKICAgICAgICAgICAgICAgIHdoaWxlIG5vdCAob3Muc3RhdChmaWxlKS5zdF9zaXplKSA+PSB0b3RhbDoKICAgICAgICAgICAgICAgICAgICBMT0dHRVIuaW5mbyhmIkRvd25sb2FkaW5nIHtDb25maWcucGxheWxpc3RbMF1bMV19IC0gQ29tcGxldGVkIC0ge3JvdW5kKCgoaW50KG9zLnN0YXQoZmlsZSkuc3Rfc2l6ZSkpIC8gaW50KHRvdGFsKSkqMTAwKX0gJSIgKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNsZWVwKDUpCiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgZ2V0X2hlaWdodF9hbmRfd2lkdGgoZmlsZSkKICAgICAgICAgICAgd2lkdGgsIGhlaWdodCA9IEZhbHNlLCBGYWxzZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHdpZHRoPW5bMF0uZ2V0KCJ3aWR0aCIpCiAgICAgICAgICAgIGhlaWdodD1uWzBdLmdldCgiaGVpZ2h0IikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gRmFsc2UsIEZhbHNlCiAgICAgICAgTE9HR0VSLmVycm9yKGYiVW5hYmxlIHRvIGdldCB2aWRlbyBwcm9wZXJ0aWVzIHtlfSIsIGV4Y19pbmZvPVRydWUpCiAgICByZXR1cm4gd2lkdGgsIGhlaWdodAoKCmFzeW5jIGRlZiBnZXRfZHVyYXRpb24oZmlsZSk6CiAgICBkdXIgPSAwCiAgICBmZnByb2JlX2NtZCA9IFsiZmZwcm9iZSIsICItaSIsIGZpbGUsICItdiIsICJlcnJvciIsICItc2hvd19lbnRyaWVzIiwgImZvcm1hdD1kdXJhdGlvbiIsICItb2YiLCAianNvbiIsICItc2VsZWN0X3N0cmVhbXMiLCAidjowIl0KICAgIHByb2Nlc3MgPSBhd2FpdCBhc3luY2lvLmNyZWF0ZV9zdWJwcm9jZXNzX2V4ZWMoCiAgICAgICAgKmZmcHJvYmVfY21kLCBzdGRvdXQ9YXN5bmNpby5zdWJwcm9jZXNzLlBJUEUsIHN0ZGVycj1hc3luY2lvLnN1YnByb2Nlc3MuUElQRQogICAgKQogICAgb3V0cHV0ID0gYXdhaXQgcHJvY2Vzcy5jb21tdW5pY2F0ZSgpCiAgICB0cnk6CiAgICAgICAgc3RyZWFtID0gb3V0cHV0WzBdLmRlY29kZSgndXRmLTgnKQogICAgICAgIG91dCA9IGpzb24ubG9hZHMoc3RyZWFtKQogICAgICAgIGlmIG91dC5nZXQoImZvcm1hdCIpOgogICAgICAgICAgICBpZiAob3V0LmdldCgiZm9ybWF0IikpLmdldCgiZHVyYXRpb24iKToKICAgICAgICAgICAgICAgIGR1ciA9IGludChmbG9hdCgob3V0LmdldCgiZm9ybWF0IikpLmdldCgiZHVyYXRpb24iKSkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkdXIgPSAwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZHVyID0gMAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIExPR0dFUi5lcnJvcihlLCBleGNfaW5mbz1UcnVlKQogICAgICAgIGR1ciAgPSAwCiAgICByZXR1cm4gZHVyCgoKZGVmIGdldF9wbGF5ZXJfc3RyaW5nKCk6CiAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgZGF0YT1Db25maWcuREFUQS5nZXQoJ0ZJTEVfREFUQScpCiAgICBkdXI9aW50KGZsb2F0KGRhdGEuZ2V0KCdkdXInLCAwKSkpCiAgICBzdGFydCA9IGludChDb25maWcuRFVSLmdldCgnVElNRScsIDApKQogICAgcGxheWVkID0gcm91bmQobm93LXN0YXJ0KQogICAgaWYgcGxheWVkID09IDA6CiAgICAgICAgcGxheWVkICs9IDEKICAgIGlmIGR1ciA9PSAwOgogICAgICAgIGR1cj1wbGF5ZWQKICAgIHBsYXllZCA9IHJvdW5kKG5vdy1zdGFydCkKICAgIHBlcmNlbnRhZ2UgPSBwbGF5ZWQgKiAxMDAgLyBkdXIKICAgIHByb2dyZXNzYmFyID0gIuKWtyB7MH3il4l7MX0iLmZvcm1hdChcCiAgICAgICAgICAgICcnLmpvaW4oWyLilIEiIGZvciBpIGluIHJhbmdlKG1hdGguZmxvb3IocGVyY2VudGFnZSAvIDUpKV0pLAogICAgICAgICAgICAnJy5qb2luKFsi4pSAIiBmb3IgaSBpbiByYW5nZSgyMCAtIG1hdGguZmxvb3IocGVyY2VudGFnZSAvIDUpKV0pCiAgICAgICAgICAgICkKICAgIGZpbmFsPWYie2NvbnZlcnQocGxheWVkKX0gICB7cHJvZ3Jlc3NiYXJ9ICAgIHtjb252ZXJ0KGR1cil9IgogICAgcmV0dXJuIGZpbmFsCgpkZWYgZ2V0X3ZvbHVtZV9zdHJpbmcoKToKICAgIGN1cnJlbnQgPSBpbnQoQ29uZmlnLlZPTFVNRSkKICAgIGlmIGN1cnJlbnQgPT0gMDoKICAgICAgICBjdXJyZW50ICs9IDEKICAgIGlmIENvbmZpZy5NVVRFRDoKICAgICAgICBlPSfwn5SHJwogICAgZWxpZiAwIDwgY3VycmVudCA8IDc1OgogICAgICAgIGU9IvCflIgiIAogICAgZWxpZiA3NSA8IGN1cnJlbnQgPCAxNTA6CiAgICAgICAgZT0i8J+UiSIKICAgIGVsc2U6CiAgICAgICAgZT0i8J+UiiIKICAgIHBlcmNlbnRhZ2UgPSBjdXJyZW50ICogMTAwIC8gMjAwCiAgICBwcm9ncmVzc2JhciA9ICLwn46ZIHswfeKXiXsxfSIuZm9ybWF0KFwKICAgICAgICAgICAgJycuam9pbihbIuKUgSIgZm9yIGkgaW4gcmFuZ2UobWF0aC5mbG9vcihwZXJjZW50YWdlIC8gNSkpXSksCiAgICAgICAgICAgICcnLmpvaW4oWyLilIAiIGZvciBpIGluIHJhbmdlKDIwIC0gbWF0aC5mbG9vcihwZXJjZW50YWdlIC8gNSkpXSkKICAgICAgICAgICAgKQogICAgZmluYWw9ZiIge3N0cihjdXJyZW50KX0gLyB7c3RyKDIwMCl9IHtwcm9ncmVzc2Jhcn0gIHtlfSIKICAgIHJldHVybiBmaW5hbAoKZGVmIHNldF9jb25maWcodmFsdWUpOgogICAgaWYgdmFsdWU6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICBlbHNlOgogICAgICAgIHJldHVybiBUcnVlCgpkZWYgY29udmVydChzZWNvbmRzKToKICAgIHNlY29uZHMgPSBzZWNvbmRzICUgKDI0ICogMzYwMCkKICAgIGhvdXIgPSBzZWNvbmRzIC8vIDM2MDAKICAgIHNlY29uZHMgJT0gMzYwMAogICAgbWludXRlcyA9IHNlY29uZHMgLy8gNjAKICAgIHNlY29uZHMgJT0gNjAgICAgICAKICAgIHJldHVybiAiJWQ6JTAyZDolMDJkIiAlIChob3VyLCBtaW51dGVzLCBzZWNvbmRzKQoKZGVmIGdldF9wYXVzZShzdGF0dXMpOgogICAgaWYgc3RhdHVzID09IFRydWU6CiAgICAgICAgcmV0dXJuICJSZXN1bWUiCiAgICBlbHNlOgogICAgICAgIHJldHVybiAiUGF1c2UiCgojaHR0cHM6Ly9naXRodWIuY29tL3B5dGdjYWxscy9weXRnY2FsbHMvYmxvYi9kZXYvcHl0Z2NhbGxzL3R5cGVzL2lucHV0X3N0cmVhbS92aWRlb190b29scy5weSNMMjctTDM4CmRlZiByZXNpemVfcmF0aW8odywgaCwgZmFjdG9yKToKICAgIGlmIHcgPiBoOgogICAgICAgIHJlc2NhbGluZyA9ICgoMTI4MCBpZiB3ID4gMTI4MCBlbHNlIHcpICogMTAwKSAvIHcKICAgIGVsc2U6CiAgICAgICAgcmVzY2FsaW5nID0gKCg3MjAgaWYgaCA+IDcyMCBlbHNlIGgpICogMTAwKSAvIGgKICAgIGggPSByb3VuZCgoaCAqIHJlc2NhbGluZykgLyAxMDApCiAgICB3ID0gcm91bmQoKHcgKiByZXNjYWxpbmcpIC8gMTAwKQogICAgZGl2aXNvciA9IGdjZCh3LCBoKQogICAgcmF0aW9fdyA9IHcgLyBkaXZpc29yCiAgICByYXRpb19oID0gaCAvIGRpdmlzb3IKICAgIGZhY3RvciA9IChkaXZpc29yICogZmFjdG9yKSAvIDEwMAogICAgd2lkdGggPSByb3VuZChyYXRpb193ICogZmFjdG9yKQogICAgaGVpZ2h0ID0gcm91bmQocmF0aW9faCAqIGZhY3RvcikKICAgIHJldHVybiB3aWR0aCAtIDEgaWYgd2lkdGggJSAyIGVsc2Ugd2lkdGgsIGhlaWdodCAtIDEgaWYgaGVpZ2h0ICUgMiBlbHNlIGhlaWdodCAjaHR0cHM6Ly9naXRodWIuY29tL3B5dGdjYWxscy9weXRnY2FsbHMvaXNzdWVzLzExOAoKZGVmIHN0b3BfYW5kX3Jlc3RhcnQoKToKICAgIG9zLnN5c3RlbSgiZ2l0IHB1bGwiKQogICAgdGltZS5zbGVlcCg1KQogICAgb3MuZXhlY2woc3lzLmV4ZWN1dGFibGUsIHN5cy5leGVjdXRhYmxlLCAqc3lzLmFyZ3YpCgoKZGVmIGdldF9pbWFnZSh0aXRsZSwgcGljLCBkdXI9IkxpdmUiKToKICAgIG5ld2ltYWdlID0gImNvbnZlcnRlZC5qcGciCiAgICBpbWFnZSA9IEltYWdlLm9wZW4ocGljKSAKICAgIGRyYXcgPSBJbWFnZURyYXcuRHJhdyhpbWFnZSkgCiAgICBmb250ID0gSW1hZ2VGb250LnRydWV0eXBlKCcuL3V0aWxzL2ZvbnQudHRmJywgNjApCiAgICB0aXRsZSA9IHRpdGxlWzA6NDVdCiAgICBNQVhfVyA9IDE3OTAKICAgIGR1cj1jb252ZXJ0KGludChmbG9hdChkdXIpKSkKICAgIGlmIGR1cj09IjA6MDA6MDAiOgogICAgICAgIGR1ciA9ICJMaXZlIFN0cmVhbSIKICAgIHBhcmE9W2YnUGxheWluZzoge3RpdGxlfScsIGYnRHVyYXRpb246IHtkdXJ9J10KICAgIGN1cnJlbnRfaCwgcGFkID0gNDUwLCAyMAogICAgZm9yIGxpbmUgaW4gcGFyYToKICAgICAgICB3LCBoID0gZHJhdy50ZXh0c2l6ZShsaW5lLCBmb250PWZvbnQpCiAgICAgICAgZHJhdy50ZXh0KCgoTUFYX1cgLSB3KSAvIDIsIGN1cnJlbnRfaCksIGxpbmUsIGZvbnQ9Zm9udCwgZmlsbCA9InNreWJsdWUiKQogICAgICAgIGN1cnJlbnRfaCArPSBoICsgcGFkCiAgICBpbWFnZS5zYXZlKG5ld2ltYWdlKQogICAgcmV0dXJuIG5ld2ltYWdlCgphc3luYyBkZWYgZWRpdF9jb25maWcodmFyLCB2YWx1ZSk6CiAgICBpZiB2YXIgPT0gIlNUQVJUVVBfU1RSRUFNIjoKICAgICAgICBDb25maWcuU1RSRUFNX1VSTCA9IHZhbHVlCiAgICBlbGlmIHZhciA9PSAiQ0hBVCI6CiAgICAgICAgQ29uZmlnLkNIQVQgPSBpbnQodmFsdWUpCiAgICBlbGlmIHZhciA9PSAiTE9HX0dST1VQIjoKICAgICAgICBDb25maWcuTE9HX0dST1VQID0gaW50KHZhbHVlKQogICAgZWxpZiB2YXIgPT0gIkRFTEFZIjoKICAgICAgICBDb25maWcuREVMQVkgPSBpbnQodmFsdWUpCiAgICBlbGlmIHZhciA9PSAiUkVQTFlfTUVTU0FHRSI6CiAgICAgICAgQ29uZmlnLlJFUExZX01FU1NBR0UgPSB2YWx1ZQogICAgZWxpZiB2YXIgPT0gIlJFQ09SRElOR19EVU1QIjoKICAgICAgICBDb25maWcuUkVDT1JESU5HX0RVTVAgPSB2YWx1ZQogICAgZWxpZiB2YXIgPT0gIlFVQUxJVFkiOgogICAgICAgIENvbmZpZy5DVVNUT01fUVVBTElUWSA9IHZhbHVlCiAgICBhd2FpdCBzeW5jX3RvX2RiKCkKCgphc3luYyBkZWYgdXBkYXRlKCk6CiAgICBhd2FpdCBsZWF2ZV9jYWxsKCkKICAgIGlmIENvbmZpZy5IRVJPS1VfQVBQOgogICAgICAgIENvbmZpZy5IRVJPS1VfQVBQLnJlc3RhcnQoKQogICAgZWxzZToKICAgICAgICBUaHJlYWQoCiAgICAgICAgICAgIHRhcmdldD1zdG9wX2FuZF9yZXN0YXJ0KCkKICAgICAgICAgICAgKS5zdGFydCgpCgoKYXN5bmMgZGVmIHN0YXJ0dXBfY2hlY2soKToKICAgIGlmIENvbmZpZy5MT0dfR1JPVVA6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBrPWF3YWl0IGJvdC5nZXRfY2hhdF9tZW1iZXIoaW50KENvbmZpZy5MT0dfR1JPVVApLCBDb25maWcuQk9UX1VTRVJOQU1FKQogICAgICAgIGV4Y2VwdCAoVmFsdWVFcnJvciwgUGVlcklkSW52YWxpZCwgQ2hhbm5lbEludmFsaWQpOgogICAgICAgICAgICBMT0dHRVIuZXJyb3IoZiJMT0dfR1JPVVAgdmFyIEZvdW5kIGFuZCBAe0NvbmZpZy5CT1RfVVNFUk5BTUV9IGlzIG5vdCBhIG1lbWJlciBvZiB0aGUgZ3JvdXAuIikKICAgICAgICAgICAgQ29uZmlnLlNUQVJUVVBfRVJST1I9ZiJMT0dfR1JPVVAgdmFyIEZvdW5kIGFuZCBAe0NvbmZpZy5CT1RfVVNFUk5BTUV9IGlzIG5vdCBhIG1lbWJlciBvZiB0aGUgZ3JvdXAuIgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIENvbmZpZy5SRUNPUkRJTkdfRFVNUDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGs9YXdhaXQgVVNFUi5nZXRfY2hhdF9tZW1iZXIoQ29uZmlnLlJFQ09SRElOR19EVU1QLCBDb25maWcuVVNFUl9JRCkKICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFBlZXJJZEludmFsaWQsIENoYW5uZWxJbnZhbGlkKToKICAgICAgICAgICAgTE9HR0VSLmVycm9yKGYiUkVDT1JESU5HX0RVTVAgdmFyIEZvdW5kIGFuZCBAe0NvbmZpZy5VU0VSX0lEfSBpcyBub3QgYSBtZW1iZXIgb2YgdGhlIGdyb3VwLi8gQ2hhbm5lbCIpCiAgICAgICAgICAgIENvbmZpZy5TVEFSVFVQX0VSUk9SPWYiUkVDT1JESU5HX0RVTVAgdmFyIEZvdW5kIGFuZCBAe0NvbmZpZy5VU0VSX0lEfSBpcyBub3QgYSBtZW1iZXIgb2YgdGhlIGdyb3VwLi8gQ2hhbm5lbCIKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgbm90IGsuc3RhdHVzIGluIFsiYWRtaW5pc3RyYXRvciIsICJjcmVhdG9yIl06CiAgICAgICAgICAgIExPR0dFUi5lcnJvcihmIlJFQ09SRElOR19EVU1QIHZhciBGb3VuZCBhbmQgQHtDb25maWcuVVNFUl9JRH0gaXMgbm90IGEgYWRtaW4gb2YgdGhlIGdyb3VwLi8gQ2hhbm5lbCIpCiAgICAgICAgICAgIENvbmZpZy5TVEFSVFVQX0VSUk9SPWYiUkVDT1JESU5HX0RVTVAgdmFyIEZvdW5kIGFuZCBAe0NvbmZpZy5VU0VSX0lEfSBpcyBub3QgYSBhZG1pbiBvZiB0aGUgZ3JvdXAuLyBDaGFubmVsIgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGlmIENvbmZpZy5DSEFUOgogICAgICAgIHRyeToKICAgICAgICAgICAgaz1hd2FpdCBVU0VSLmdldF9jaGF0X21lbWJlcihDb25maWcuQ0hBVCwgQ29uZmlnLlVTRVJfSUQpCiAgICAgICAgICAgIGlmIG5vdCBrLnN0YXR1cyBpbiBbImFkbWluaXN0cmF0b3IiLCAiY3JlYXRvciJdOgogICAgICAgICAgICAgICAgTE9HR0VSLndhcm5pbmcoZiJ7Q29uZmlnLlVTRVJfSUR9IGlzIG5vdCBhbiBhZG1pbiBpbiB7Q29uZmlnLkNIQVR9LCBpdCBpcyByZWNvbW1lbmRlZCB0byBydW4gdGhlIHVzZXIgYXMgYWRtaW4uIikKICAgICAgICAgICAgZWxpZiBrLnN0YXR1cyBpbiBbImFkbWluaXN0cmF0b3IiLCAiY3JlYXRvciJdIGFuZCBub3Qgay5jYW5fbWFuYWdlX3ZvaWNlX2NoYXRzOgogICAgICAgICAgICAgICAgTE9HR0VSLndhcm5pbmcoZiJ7Q29uZmlnLlVTRVJfSUR9IGlzIG5vdCBoYXZpbmcgcmlnaHQgdG8gbWFuYWdlIHZvaWNlY2hhdCwgaXQgaXMgcmVjb21tZW5kZWQgdG8gcHJvbW90ZSB3aXRoIHRoaXMgcmlnaHQuIikKICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFBlZXJJZEludmFsaWQsIENoYW5uZWxJbnZhbGlkKToKICAgICAgICAgICAgQ29uZmlnLlNUQVJUVVBfRVJST1I9ZiJUaGUgdXNlciBhY2NvdW50IGJ5IHdoaWNoIHlvdSBnZW5lcmF0ZWQgdGhlIFNFU1NJT05fU1RSSU5HIGlzIG5vdCBmb3VuZCBvbiBDSEFUICh7Q29uZmlnLkNIQVR9KSIKICAgICAgICAgICAgTE9HR0VSLmVycm9yKGYiVGhlIHVzZXIgYWNjb3VudCBieSB3aGljaCB5b3UgZ2VuZXJhdGVkIHRoZSBTRVNTSU9OX1NUUklORyBpcyBub3QgZm91bmQgb24gQ0hBVCAoe0NvbmZpZy5DSEFUfSkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIGs9YXdhaXQgYm90LmdldF9jaGF0X21lbWJlcihDb25maWcuQ0hBVCwgQ29uZmlnLkJPVF9VU0VSTkFNRSkKICAgICAgICAgICAgaWYgbm90IGsuc3RhdHVzID09ICJhZG1pbmlzdHJhdG9yIjoKICAgICAgICAgICAgICAgIExPR0dFUi53YXJuaW5nKGYie0NvbmZpZy5CT1RfVVNFUk5BTUV9LCBpcyBub3QgYW4gYWRtaW4gaW4ge0NvbmZpZy5DSEFUfSwgaXQgaXMgcmVjb21tZW5kZWQgdG8gcnVuIHRoZSBib3QgYXMgYWRtaW4uIikKICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFBlZXJJZEludmFsaWQsIENoYW5uZWxJbnZhbGlkKToKICAgICAgICAgICAgQ29uZmlnLlNUQVJUVVBfRVJST1I9ZiJCb3QgV2FzIE5vdCBGb3VuZCBvbiBDSEFULCBpdCBpcyByZWNvbW1lbmRlZCB0byBhZGQge0NvbmZpZy5CT1RfVVNFUk5BTUV9IHRvIHtDb25maWcuQ0hBVH0iCiAgICAgICAgICAgIExPR0dFUi53YXJuaW5nKGYiQm90IFdhcyBOb3QgRm91bmQgb24gQ0hBVCwgaXQgaXMgcmVjb21tZW5kZWQgdG8gYWRkIHtDb25maWcuQk9UX1VTRVJOQU1FfSB0byB7Q29uZmlnLkNIQVR9IikKICAgICAgICAgICAgcGFzcwogICAgaWYgbm90IENvbmZpZy5EQVRBQkFTRV9VUkk6CiAgICAgICAgTE9HR0VSLndhcm5pbmcoIk5vIERBVEFCQVNFX1VSSSAsIGZvdW5kLiBJdCBpcyByZWNvbW1lbmRlZCB0byB1c2UgYSBkYXRhYmFzZS4iKQogICAgcmV0dXJuIFRydWUK'))