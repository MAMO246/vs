
import base64
exec(base64.b64decode('IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIENvcHlyaWdodCAoQykgQHN1YmlucHMKIyBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeQojIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieQojIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yCiMgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KCiMgVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCiMgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKIyBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiMgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCgojIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZQojIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KCmZyb20gdXRpbHMgaW1wb3J0IExPR0dFUgpmcm9tIHB5cm9ncmFtIGltcG9ydCBDbGllbnQKZnJvbSBjb250ZXh0bGliIGltcG9ydCBzdXBwcmVzcwpmcm9tIGNvbmZpZyBpbXBvcnQgQ29uZmlnCmZyb20gYXN5bmNpbyBpbXBvcnQgc2xlZXAKaW1wb3J0IGRhdGV0aW1lCmltcG9ydCBweXR6CmltcG9ydCBjYWxlbmRhcgpmcm9tIHV0aWxzIGltcG9ydCAoCiAgICBjYW5jZWxfYWxsX3NjaGVkdWxlcywKICAgIGRlbGV0ZV9tZXNzYWdlcywKICAgIGdldF9hZG1pbnMsIAogICAgZ2V0X2J1dHRvbnMsIAogICAgZ2V0X3BsYXlsaXN0X3N0ciwKICAgIGxlYXZlX2NhbGwsIAogICAgbXV0ZSwgCiAgICBwYXVzZSwKICAgIHJlY29yZGVyX3NldHRpbmdzLCAKICAgIHJlc3RhcnQsIAogICAgcmVzdGFydF9wbGF5b3V0LCAKICAgIHJlc3VtZSwKICAgIHNjaGVkdWxlX2FfcGxheSwgCiAgICBzZWVrX2ZpbGUsIAogICAgc2V0X2NvbmZpZywgCiAgICBzZXR0aW5nc19wYW5lbCwgCiAgICBzaHVmZmxlX3BsYXlsaXN0LCAKICAgIHNraXAsCiAgICBzdGFydF9yZWNvcmRfc3RyZWFtLAogICAgc3RvcF9yZWNvcmRpbmcsCiAgICBzeW5jX3RvX2RiLCAKICAgIHVubXV0ZSwKICAgIHZvbHVtZSwKICAgIHZvbHVtZV9idXR0b25zCiAgICApCmZyb20gcHlyb2dyYW0udHlwZXMgaW1wb3J0ICgKICAgIElubGluZUtleWJvYXJkTWFya3VwLCAKICAgIElubGluZUtleWJvYXJkQnV0dG9uLCAKICAgIENhbGxiYWNrUXVlcnkKKQpmcm9tIHB5cm9ncmFtLmVycm9ycyBpbXBvcnQgKAogICAgTWVzc2FnZU5vdE1vZGlmaWVkLAogICAgTWVzc2FnZUlkSW52YWxpZCwKICAgIFF1ZXJ5SWRJbnZhbGlkCikKZnJvbSBweXJvZ3JhbS50eXBlcyBpbXBvcnQgKAogICAgSW5saW5lS2V5Ym9hcmRCdXR0b24sIAogICAgSW5saW5lS2V5Ym9hcmRNYXJrdXAKKQoKSVNUID0gcHl0ei50aW1lem9uZShDb25maWcuVElNRV9aT05FKQoKQENsaWVudC5vbl9jYWxsYmFja19xdWVyeSgpCmFzeW5jIGRlZiBjYl9oYW5kbGVyKGNsaWVudDogQ2xpZW50LCBxdWVyeTogQ2FsbGJhY2tRdWVyeSk6CiAgICB3aXRoIHN1cHByZXNzKE1lc3NhZ2VJZEludmFsaWQsIE1lc3NhZ2VOb3RNb2RpZmllZCwgUXVlcnlJZEludmFsaWQpOgogICAgICAgIGFkbWlucyA9IGF3YWl0IGdldF9hZG1pbnMoQ29uZmlnLkNIQVQpCiAgICAgICAgaWYgcXVlcnkuZGF0YS5zdGFydHN3aXRoKCJpbmZvIik6CiAgICAgICAgICAgIG1lLCB5b3UgPSBxdWVyeS5kYXRhLnNwbGl0KCJfIikKICAgICAgICAgICAgdGV4dD0iSm9pbiBAaVB1cmV4IgogICAgICAgICAgICBpZiB5b3UgPT0gInZvbHVtZSI6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgdm9sdW1lX2J1dHRvbnMoKSkKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBpZiB5b3UgPT0gInBsYXllciI6CiAgICAgICAgICAgICAgICBpZiBub3QgQ29uZmlnLkNBTExfU1RBVFVTOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIoIti52LDYsdin2Ysg2YTYpyDZitmI2K3YryDYtNimINmC2YrYryDYp9mE2KrYtNi62YrZhPCfmYLinIsuIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgZ2V0X2J1dHRvbnMoKSkKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgaWYgeW91ID09ICJ2aWRlbyI6CiAgICAgICAgICAgICAgICB0ZXh0PSJUb2dnbGUgeW91ciBib3QgdG8gVmlkZW8gLyBBdWRpbyBQbGF5ZXIuIgogICAgICAgICAgICBlbGlmIHlvdSA9PSAic2h1ZmZsZSI6CiAgICAgICAgICAgICAgICB0ZXh0PSJFbmFibGUgb3IgZGlzYWJsZSBhdXRvIHBsYXlsaXN0IHNodWZmbGluZyIKICAgICAgICAgICAgZWxpZiB5b3UgPT0gImFkbWluIjoKICAgICAgICAgICAgICAgIHRleHQ9IkVuYWJsZSB0byByZXN0cmljdCB0aGUgcGxheSBjb21tYW5kIG9ubHkgZm9yIGFkbWlucy4iCiAgICAgICAgICAgIGVsaWYgeW91ID09ICJtb2RlIjoKICAgICAgICAgICAgICAgIHRleHQ9IkVuYWJsaW5nIE5vbi0gc3RvcCBwbGF5YmFjayB3aWxsIG1ha2UgdGhlIHBsYXllciBydW5uaW5nIDI0IC8gNyBhbmQgYXV0b21hdGljIHN0YXJ0dXAgd2hlbiByZXN0YXJ0aW5nLiAiCiAgICAgICAgICAgIGVsaWYgeW91ID09ICJ0aXRsZSI6CiAgICAgICAgICAgICAgICB0ZXh0PSJFbmFibGUgdG8gZWRpdCB0aGUgVmlkZW9DaGF0IHRpdGxlIHRvIEN1cnJlbnQgcGxheWluZyBzb25nJ3MgdGl0bGUuIgogICAgICAgICAgICBlbGlmIHlvdSA9PSAicmVwbHkiOgogICAgICAgICAgICAgICAgdGV4dD0iQ2hvb3NlIHdoZXRoZXIgdG8gYXV0by1yZXBseSBtZXNzYWdlZCBmb3IgdXNlcmJvdC4gIgogICAgICAgICAgICBlbGlmIHlvdSA9PSAidmlkZW9yZWNvcmQiOgogICAgICAgICAgICAgICAgdGV4dCA9ICJFbmFibGUgdG8gcmVjb3JkIGJvdGggdmlkZW8gYW5kIGF1ZGlvLCBpZiBkaXNhYmxlZCBvbmx5IGF1ZGlvIHdpbGwgYmUgcmVjb3JkZWQuIgogICAgICAgICAgICBlbGlmIHlvdSA9PSAidmlkZW9kaW1lbnNpb24iOgogICAgICAgICAgICAgICAgdGV4dCA9ICJDaG9vc2UgdGhlIHJlY29yZGluZyB2aWRlbydzIGRpbWVuc2lvbnMiCiAgICAgICAgICAgIGVsaWYgeW91ID09ICJyZWN0aXRsZSI6CiAgICAgICAgICAgICAgICB0ZXh0ID0gIkEgY3VzdG9tIHRpdGxlIGZvciB5b3VyIGNoYXQgcmVjb3JkaW5ncywgVXNlIC9ydGl0bGUgY29tbWFuZCB0byBzZXQgYSB0aXRsZSIKICAgICAgICAgICAgZWxpZiB5b3UgPT0gInJlY2R1bWIiOgogICAgICAgICAgICAgICAgdGV4dCA9ICJBIGNoYW5uZWwgdG8gd2hpY2ggYWxsIHRoZSByZWNvcmRpbmdzIGFyZSBmb3J3YXJkZWQuIE1ha2Ugc3VyZSBUaGUgVXNlciBhY2NvdW50IGlzIGFkbWluIG92ZXIgdGhlcmUuIFNldCBvbmUgdXNpbmcgL2VudiBvciAvY29uZmlnLiIKICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKHRleHQ9dGV4dCwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICByZXR1cm4KCgogICAgICAgIGVsaWYgcXVlcnkuZGF0YS5zdGFydHN3aXRoKCJoZWxwIik6CiAgICAgICAgICAgIGlmIHF1ZXJ5Lm1lc3NhZ2UuY2hhdC50eXBlICE9ICJwcml2YXRlIiBhbmQgcXVlcnkubWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmZyb21fdXNlciBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHF1ZXJ5LmFuc3dlcigiSSBjYW50IGhlbHAgeW91IGhlcmUsIHNpbmNlIHlvdSBhcmUgYW4gYW5vbnltb3VzIGFkbWluLCBtZXNzYWdlIG1lIGluIHByaXZhdGUgY2hhdC4iLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgIGVsaWYgcXVlcnkubWVzc2FnZS5jaGF0LnR5cGUgIT0gInByaXZhdGUiIGFuZCBxdWVyeS5mcm9tX3VzZXIuaWQgIT0gcXVlcnkubWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmZyb21fdXNlci5pZDoKICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIoIk9rZGEiLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgIG1lLCBueWF2ID0gcXVlcnkuZGF0YS5zcGxpdCgiXyIpCiAgICAgICAgICAgIGJhY2s9SW5saW5lS2V5Ym9hcmRNYXJrdXAoCiAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi2LHYrNmI2Lnwn5SZIiwgY2FsbGJhY2tfZGF0YT0iaGVscF9tYWluIiksCiAgICAgICAgICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCLwn5eR77iP2KfYutmE2KfZgiIsIGNhbGxiYWNrX2RhdGE9ImNsb3NlIiksCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgbnlhdiA9PSAnbWFpbic6CiAgICAgICAgICAgICAgICByZXBseV9tYXJrdXA9SW5saW5lS2V5Ym9hcmRNYXJrdXAoCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmItin2YjYp9mF2LEg2KfZhNiq2LTYutmK2YTwn462IiwgY2FsbGJhY2tfZGF0YT0naGVscF9wbGF5JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmItin2YTYp9i52K/Yp9iv2KfYquKame+4jyIsIGNhbGxiYWNrX2RhdGE9ZiJoZWxwX3NldHRpbmdzIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmItin2YjYp9mF2LEg2KfZhNiq2LPYrNmK2YTwn46mIiwgY2FsbGJhY2tfZGF0YT0naGVscF9yZWNvcmQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oItin2YjYp9mF2LEg2KfZhNis2K/ZiNmE2Knwn46uIiwgY2FsbGJhY2tfZGF0YT0iaGVscF9zY2hlZHVsZSIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIuOAve+4j9in2YjYp9mF2LEg2KfZhNiq2K3Zg9mFIiwgY2FsbGJhY2tfZGF0YT0naGVscF9jb250cm9sJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi2KfZiNin2YXYsSDYp9mE2KfYr9mF2YbZitip8J+RriIsIGNhbGxiYWNrX2RhdGE9ImhlbHBfYWRtaW4iKSwKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oZiLYp9mI2KfZhdixINin2YTYo9iu2LfYp9ih4p2MIiwgY2FsbGJhY2tfZGF0YT0naGVscF9taXNjJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi2KfZiNin2YXYsSDYp9mE2KrZg9mI2YrZhuKaoO+4jyIsIGNhbGxiYWNrX2RhdGE9J2hlbHBfZW52JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+Xke+4j9il2LrZhNin2YIiLCBjYWxsYmFja19kYXRhPSJjbG9zZSIpLAogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoItmC2KfYptmF2Kkg2KfZhNin2YjYp9mF2LEg2KfZhNiu2KfYtdipINio2KfZhNio2YjYqiAsINin2LbYuti3INi52YTZiiDYp9mE2KfYstix2KfYsSDYqNin2YTYp9iz2YHZhCDZhNi52LHYtiDYp9mE2KrZgdin2LXZitmEIPCfkYcuIiwgcmVwbHlfbWFya3VwPXJlcGx5X21hcmt1cCwgZGlzYWJsZV93ZWJfcGFnZV9wcmV2aWV3PVRydWUpCiAgICAgICAgICAgIGVsaWYgbnlhdiA9PSAncGxheSc6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoQ29uZmlnLlBMQVlfSEVMUCwgcmVwbHlfbWFya3VwPWJhY2ssIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldz1UcnVlKQogICAgICAgICAgICBlbGlmIG55YXYgPT0gJ3NldHRpbmdzJzoKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdChDb25maWcuU0VUVElOR1NfSEVMUCwgcmVwbHlfbWFya3VwPWJhY2ssIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldz1UcnVlKQogICAgICAgICAgICBlbGlmIG55YXYgPT0gJ3NjaGVkdWxlJzoKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdChDb25maWcuU0NIRURVTEVSX0hFTFAsIHJlcGx5X21hcmt1cD1iYWNrLCBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZSkKICAgICAgICAgICAgZWxpZiBueWF2ID09ICdjb250cm9sJzoKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdChDb25maWcuQ09OVFJPTF9IRUxQLCByZXBseV9tYXJrdXA9YmFjaywgZGlzYWJsZV93ZWJfcGFnZV9wcmV2aWV3PVRydWUpCiAgICAgICAgICAgIGVsaWYgbnlhdiA9PSAnYWRtaW4nOgogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0KENvbmZpZy5BRE1JTl9IRUxQLCByZXBseV9tYXJrdXA9YmFjaywgZGlzYWJsZV93ZWJfcGFnZV9wcmV2aWV3PVRydWUpCiAgICAgICAgICAgIGVsaWYgbnlhdiA9PSAnbWlzYyc6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoQ29uZmlnLk1JU0NfSEVMUCwgcmVwbHlfbWFya3VwPWJhY2ssIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldz1UcnVlKQogICAgICAgICAgICBlbGlmIG55YXYgPT0gJ3JlY29yZCc6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoQ29uZmlnLlJFQ09SREVSX0hFTFAsIHJlcGx5X21hcmt1cD1iYWNrLCBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZSkKICAgICAgICAgICAgZWxpZiBueWF2ID09ICdlbnYnOgogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0KENvbmZpZy5FTlZfSEVMUCwgcmVwbHlfbWFya3VwPWJhY2ssIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldz1UcnVlKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IHF1ZXJ5LmZyb21fdXNlci5pZCBpbiBhZG1pbnM6CiAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigKICAgICAgICAgICAgICAgICLZhdinINix2KfYrSDYp9mC2YHZhNmHINi02KrYqNmKINin2YbYqvCfmYLYnyAiLAogICAgICAgICAgICAgICAgc2hvd19hbGVydD1UcnVlCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgogICAgICAgICNzY2hlZHVsZXIgc3R1ZmZzCiAgICAgICAgaWYgcXVlcnkuZGF0YS5zdGFydHN3aXRoKCJzY2giKToKICAgICAgICAgICAgaWYgcXVlcnkubWVzc2FnZS5jaGF0LnR5cGUgIT0gInByaXZhdGUiIGFuZCBxdWVyeS5tZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UuZnJvbV91c2VyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKCJZb3UgY2FudCB1c2Ugc2NoZWR1bGluZyBoZXJlLCBzaW5jZSB5b3UgYXJlIGFuIGFub255bW91cyBhZG1pbi4gU2NoZWR1bGUgZnJvbSBwcml2YXRlIGNoYXQuIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICBpZiBxdWVyeS5tZXNzYWdlLmNoYXQudHlwZSAhPSAicHJpdmF0ZSIgYW5kIHF1ZXJ5LmZyb21fdXNlci5pZCAhPSBxdWVyeS5tZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UuZnJvbV91c2VyLmlkOgogICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHF1ZXJ5LmFuc3dlcigiT2tkYSIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgZGF0YSA9IHF1ZXJ5LmRhdGEKICAgICAgICAgICAgdG9kYXkgPSBkYXRldGltZS5kYXRldGltZS5ub3coSVNUKQogICAgICAgICAgICBzbW9udGg9dG9kYXkuc3RyZnRpbWUoIiVCIikKICAgICAgICAgICAgb2JqID0gY2FsZW5kYXIuQ2FsZW5kYXIoKQogICAgICAgICAgICB0aGlzZGF5ID0gdG9kYXkuZGF5CiAgICAgICAgICAgIHllYXIgPSB0b2RheS55ZWFyCiAgICAgICAgICAgIG1vbnRoID0gdG9kYXkubW9udGgKICAgICAgICAgICAgaWYgZGF0YS5zdGFydHN3aXRoKCJzY2hfbW9udGgiKToKICAgICAgICAgICAgICAgIG5vbmUsIG5vbmUgLCB5ZWFfciwgbW9udGhfLCBkYXkgPSBkYXRhLnNwbGl0KCJfIikKICAgICAgICAgICAgICAgIGlmIHllYV9yID09ICJjaG9vc2UiOgogICAgICAgICAgICAgICAgICAgIHllYXI9aW50KHllYXIpCiAgICAgICAgICAgICAgICAgICAgbW9udGhzID0gWyJKYW51YXJ5IiwgIkZlYnJ1YXJ5IiwgIk1hcmNoIiwgIkFwcmlsIiwgIk1heSIsICJKdW5lIiwgIkp1bHkiLCAiQXVndXN0IiwgIlNlcHRlbWJlciIsICJPY3RvYmVyIiwgIk5vdmVtYmVyIiwgIkRlY2VtYmVyIl0KICAgICAgICAgICAgICAgICAgICBidXR0b249W10KICAgICAgICAgICAgICAgICAgICBidXR0b25fPVtdCiAgICAgICAgICAgICAgICAgICAgaz0wCiAgICAgICAgICAgICAgICAgICAgZm9yIG1vbnRoIGluIG1vbnRoczoKICAgICAgICAgICAgICAgICAgICAgICAgays9MQogICAgICAgICAgICAgICAgICAgICAgICB5ZWFyXyA9IHllYXIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgayA8IGludCh0b2RheS5tb250aCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5ZWFyXyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fLmFwcGVuZChbSW5saW5lS2V5Ym9hcmRCdXR0b24odGV4dD1mIntzdHIobW9udGgpfSAge3N0cih5ZWFyXyl9IixjYWxsYmFja19kYXRhPWYic2NoX3Nob3dkYXRlX3t5ZWFyX31fe2t9IildKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uLmFwcGVuZChbSW5saW5lS2V5Ym9hcmRCdXR0b24odGV4dD1mIntzdHIobW9udGgpfSAge3N0cih5ZWFyXyl9IixjYWxsYmFja19kYXRhPWYic2NoX3Nob3dkYXRlX3t5ZWFyX31fe2t9IildKQogICAgICAgICAgICAgICAgICAgIGJ1dHRvbiA9IGJ1dHRvbiArIGJ1dHRvbl8KICAgICAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kKFtJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+Xke+4j9in2LrZhNin2YIiLCBjYWxsYmFja19kYXRhPSJzY2hjbG9zZSIpXSkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoIk5vdyBDaG9vc2UgdGhlIG1vbnRoIHRvIHNjaGVkdWxlIGEgdm9pY2VjaGF044WkIOOFpOOFpCIsIHJlcGx5X21hcmt1cD1JbmxpbmVLZXlib2FyZE1hcmt1cChidXR0b24pKQogICAgICAgICAgICAgICAgZWxpZiBkYXkgPT0gIm5vbmUiOgogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB5ZWFyID0gaW50KHllYV9yKQogICAgICAgICAgICAgICAgICAgIG1vbnRoID0gaW50KG1vbnRoXykKICAgICAgICAgICAgICAgICAgICBkYXRlID0gaW50KGRheSkKICAgICAgICAgICAgICAgICAgICBkYXRldGltZV9vYmplY3QgPSBkYXRldGltZS5kYXRldGltZS5zdHJwdGltZShzdHIobW9udGgpLCAiJW0iKQogICAgICAgICAgICAgICAgICAgIHNtb250aCA9IGRhdGV0aW1lX29iamVjdC5zdHJmdGltZSgiJUIiKQogICAgICAgICAgICAgICAgICAgIGJ1dHRvbj1bXQogICAgICAgICAgICAgICAgICAgIGlmIHllYXIgPT0gdG9kYXkueWVhciBhbmQgbW9udGggPT0gdG9kYXkubW9udGggYW5kIGRhdGUgPT0gdG9kYXkuZGF5OgogICAgICAgICAgICAgICAgICAgICAgICBub3cgPSB0b2RheS5ob3VyCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbm93PTAKICAgICAgICAgICAgICAgICAgICBsID0gbGlzdCgpCiAgICAgICAgICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2Uobm93LCAyNCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGwuYXBwZW5kKGkpCiAgICAgICAgICAgICAgICAgICAgc3BsaXRlZD1bbFtpOmkgKyA2XSBmb3IgaSBpbiByYW5nZSgwLCBsZW4obCksIDYpXQogICAgICAgICAgICAgICAgICAgIGZvciBpIGluIHNwbGl0ZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGs9W10KICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGQgaW4gaToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsuYXBwZW5kKElubGluZUtleWJvYXJkQnV0dG9uKHRleHQ9ZiJ7ZH0iLGNhbGxiYWNrX2RhdGE9ZiJzY2hfZGF5X3t5ZWFyfV97bW9udGh9X3tkYXRlfV97ZH0iKSkKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uLmFwcGVuZChrKQogICAgICAgICAgICAgICAgICAgIGlmIG1vbnRoID09IHRvZGF5Lm1vbnRoIGFuZCBkYXRlIDwgdG9kYXkuZGF5IGFuZCB5ZWFyPT10b2RheS55ZWFyKzE6CiAgICAgICAgICAgICAgICAgICAgICAgIHB5ZWFyPXllYXItMQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHB5ZWFyPXllYXIKICAgICAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kKFtJbmxpbmVLZXlib2FyZEJ1dHRvbigiQmFjayIsIGNhbGxiYWNrX2RhdGE9ZiJzY2hfc2hvd2RhdGVfe3B5ZWFyfV97bW9udGh9IiksIElubGluZUtleWJvYXJkQnV0dG9uKCJDbG9zZSIsIGNhbGxiYWNrX2RhdGE9InNjaGNsb3NlIildKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdChmIkNob29zZSB0aGUgaG91ciBvZiB7ZGF0ZX0ge3Ntb250aH0ge3llYXJ9IHRvIHNjaGVkdWxlICBhIHZvaWNlY2hhdC4iLCByZXBseV9tYXJrdXA9SW5saW5lS2V5Ym9hcmRNYXJrdXAoYnV0dG9uKSkKCiAgICAgICAgICAgIGVsaWYgZGF0YS5zdGFydHN3aXRoKCJzY2hfZGF5Iik6CiAgICAgICAgICAgICAgICBub25lLCBub25lLCB5ZWFyLCBtb250aCwgZGF5LCBob3VyID0gZGF0YS5zcGxpdCgiXyIpCiAgICAgICAgICAgICAgICB5ZWFyID0gaW50KHllYXIpCiAgICAgICAgICAgICAgICBtb250aCA9IGludChtb250aCkKICAgICAgICAgICAgICAgIGRheSA9IGludChkYXkpCiAgICAgICAgICAgICAgICBob3VyID0gaW50KGhvdXIpCiAgICAgICAgICAgICAgICBkYXRldGltZV9vYmplY3QgPSBkYXRldGltZS5kYXRldGltZS5zdHJwdGltZShzdHIobW9udGgpLCAiJW0iKQogICAgICAgICAgICAgICAgc21vbnRoID0gZGF0ZXRpbWVfb2JqZWN0LnN0cmZ0aW1lKCIlQiIpCiAgICAgICAgICAgICAgICBpZiB5ZWFyID09IHRvZGF5LnllYXIgYW5kIG1vbnRoID09IHRvZGF5Lm1vbnRoIGFuZCBkYXkgPT0gdG9kYXkuZGF5IGFuZCBob3VyID09IHRvZGF5LmhvdXI6CiAgICAgICAgICAgICAgICAgICAgbm93PXRvZGF5Lm1pbnV0ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBub3c9MAogICAgICAgICAgICAgICAgYnV0dG9uPVtdCiAgICAgICAgICAgICAgICBsID0gbGlzdCgpCiAgICAgICAgICAgICAgICBmb3IgaSBpbiByYW5nZShub3csIDYwKToKICAgICAgICAgICAgICAgICAgICBsLmFwcGVuZChpKQogICAgICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMCwgbGVuKGwpLCA2KToKICAgICAgICAgICAgICAgICAgICBjaHVuayA9IGxbaTppICsgNl0KICAgICAgICAgICAgICAgICAgICBrPVtdCiAgICAgICAgICAgICAgICAgICAgZm9yIGQgaW4gY2h1bms6CiAgICAgICAgICAgICAgICAgICAgICAgIGsuYXBwZW5kKElubGluZUtleWJvYXJkQnV0dG9uKHRleHQ9ZiJ7ZH0iLGNhbGxiYWNrX2RhdGE9ZiJzY2hfbWludXRlX3t5ZWFyfV97bW9udGh9X3tkYXl9X3tob3VyfV97ZH0iKSkKICAgICAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kKGspCiAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kKFtJbmxpbmVLZXlib2FyZEJ1dHRvbigiQmFjayIsIGNhbGxiYWNrX2RhdGE9ZiJzY2hfbW9udGhfe3llYXJ9X3ttb250aH1fe2RheX0iKSwgSW5saW5lS2V5Ym9hcmRCdXR0b24oIkNsb3NlIiwgY2FsbGJhY2tfZGF0YT0ic2NoY2xvc2UiKV0pCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoZiJDaG9vc2UgbWludXRlIG9mIHtob3VyfXRoIGhvdXIgb24ge2RheX0ge3Ntb250aH0ge3llYXJ9IHRvIHNjaGVkdWxlIFZvaWNlY2hhdC4iLCByZXBseV9tYXJrdXA9SW5saW5lS2V5Ym9hcmRNYXJrdXAoYnV0dG9uKSkKCiAgICAgICAgICAgIGVsaWYgZGF0YS5zdGFydHN3aXRoKCJzY2hfbWludXRlIik6CiAgICAgICAgICAgICAgICBub25lLCBub25lLCB5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUgPSBkYXRhLnNwbGl0KCJfIikKICAgICAgICAgICAgICAgIHllYXIgPSBpbnQoeWVhcikKICAgICAgICAgICAgICAgIG1vbnRoID0gaW50KG1vbnRoKQogICAgICAgICAgICAgICAgZGF5ID0gaW50KGRheSkKICAgICAgICAgICAgICAgIGhvdXIgPSBpbnQoaG91cikKICAgICAgICAgICAgICAgIG1pbnV0ZSA9IGludChtaW51dGUpCiAgICAgICAgICAgICAgICBkYXRldGltZV9vYmplY3QgPSBkYXRldGltZS5kYXRldGltZS5zdHJwdGltZShzdHIobW9udGgpLCAiJW0iKQogICAgICAgICAgICAgICAgc21vbnRoID0gZGF0ZXRpbWVfb2JqZWN0LnN0cmZ0aW1lKCIlQiIpCiAgICAgICAgICAgICAgICBpZiB5ZWFyID09IHRvZGF5LnllYXIgYW5kIG1vbnRoID09IHRvZGF5Lm1vbnRoIGFuZCBkYXkgPT0gdG9kYXkuZGF5IGFuZCBob3VyID09IHRvZGF5LmhvdXIgYW5kIG1pbnV0ZSA8PSB0b2RheS5taW51dGU6CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJJIGRvbnQgaGF2ZSBhIHRpbWVtYWNoaW5lIHRvIGdvIHRvIHBhc3QhISEuIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gCiAgICAgICAgICAgICAgICBmaW5hbD1mIntkYXl9dGgge3Ntb250aH0ge3llYXJ9IGF0IHtob3VyfTp7bWludXRlfSIKICAgICAgICAgICAgICAgIGJ1dHRvbj1bCiAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigiQ29uZmlybSIsIGNhbGxiYWNrX2RhdGE9ZiJzY2hjb25maXJtX3t5ZWFyfS17bW9udGh9LXtkYXl9IHtob3VyfTp7bWludXRlfSIpLAogICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigiQmFjayIsIGNhbGxiYWNrX2RhdGE9ZiJzY2hfZGF5X3t5ZWFyfV97bW9udGh9X3tkYXl9X3tob3VyfSIpCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICBbCiAgICAgICAgICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCJDbG9zZSIsIGNhbGxiYWNrX2RhdGE9InNjaGNsb3NlIikKICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICBkYXRhPUNvbmZpZy5TQ0hFRFVMRURfU1RSRUFNLmdldChmIntxdWVyeS5tZXNzYWdlLmNoYXQuaWR9X3txdWVyeS5tZXNzYWdlLm1lc3NhZ2VfaWR9IikKICAgICAgICAgICAgICAgIGlmIG5vdCBkYXRhOgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigiVGhpcyBzY2hlZHVsZSBpcyBleHBpcmVkIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICAgICAgaWYgZGF0YVsnMyddID09ICJ0ZWxlZ3JhbSI6CiAgICAgICAgICAgICAgICAgICAgdGl0bGU9ZGF0YVsnMSddCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHRpdGxlPWYiW3tkYXRhWycxJ119XSh7ZGF0YVsnMiddfSkiCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoZiJZb3VyIFN0cmVhbSB7dGl0bGV9IGlzIG5vdyBzY2hlZHVsZWQgdG8gc3RhcnQgb24ge2ZpbmFsfVxuXG5DbGljayBDb25maXJtIHRvIGNvbmZpcm0gdGhlIHRpbWUuIiwgcmVwbHlfbWFya3VwPUlubGluZUtleWJvYXJkTWFya3VwKGJ1dHRvbiksIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldz1UcnVlKSAgICAgICAgICAgICAgICAKCiAgICAgICAgICAgIGVsaWYgZGF0YS5zdGFydHN3aXRoKCJzY2hfc2hvd2RhdGUiKToKICAgICAgICAgICAgICAgIHR5ZWFyPXllYXIKICAgICAgICAgICAgICAgIG5vbmUsIG5vbmUsIHllYXIsIG1vbnRoID0gZGF0YS5zcGxpdCgiXyIpCiAgICAgICAgICAgICAgICBkYXRldGltZV9vYmplY3QgPSBkYXRldGltZS5kYXRldGltZS5zdHJwdGltZShtb250aCwgIiVtIikKICAgICAgICAgICAgICAgIHRoaXNzbW9udGggPSBkYXRldGltZV9vYmplY3Quc3RyZnRpbWUoIiVCIikKICAgICAgICAgICAgICAgIG9iaiA9IGNhbGVuZGFyLkNhbGVuZGFyKCkKICAgICAgICAgICAgICAgIHRoaXNkYXkgPSB0b2RheS5kYXkKICAgICAgICAgICAgICAgIHllYXIgPSBpbnQoeWVhcikKICAgICAgICAgICAgICAgIG1vbnRoID0gaW50KG1vbnRoKQogICAgICAgICAgICAgICAgbT1vYmoubW9udGhkYXlzY2FsZW5kYXIoeWVhciwgbW9udGgpCiAgICAgICAgICAgICAgICBidXR0b249W10KICAgICAgICAgICAgICAgIGJ1dHRvbi5hcHBlbmQoW0lubGluZUtleWJvYXJkQnV0dG9uKHRleHQ9ZiJ7c3RyKHRoaXNzbW9udGgpfSAge3N0cih5ZWFyKX0iLGNhbGxiYWNrX2RhdGE9ZiJzY2hfbW9udGhfY2hvb3NlX25vbmVfbm9uZSIpXSkKICAgICAgICAgICAgICAgIGRheXM9WyJNb24iLCAiVHVlcyIsICJXZWQiLCAiVGh1IiwgIkZyaSIsICJTYXQiLCAiU3VuIl0KICAgICAgICAgICAgICAgIGY9W10KICAgICAgICAgICAgICAgIGZvciBkYXkgaW4gZGF5czoKICAgICAgICAgICAgICAgICAgICBmLmFwcGVuZChJbmxpbmVLZXlib2FyZEJ1dHRvbih0ZXh0PWYie2RheX0iLGNhbGxiYWNrX2RhdGE9ZiJkYXlfaW5mb19ub25lIikpCiAgICAgICAgICAgICAgICBidXR0b24uYXBwZW5kKGYpCiAgICAgICAgICAgICAgICBmb3Igb25lIGluIG06CiAgICAgICAgICAgICAgICAgICAgZj1bXQogICAgICAgICAgICAgICAgICAgIGZvciBkIGluIG9uZToKICAgICAgICAgICAgICAgICAgICAgICAgeWVhcl89eWVhcgogICAgICAgICAgICAgICAgICAgICAgICBpZiB5ZWFyPT10b2RheS55ZWFyIGFuZCBtb250aCA9PSB0b2RheS5tb250aCBhbmQgZCA8IGludCh0b2RheS5kYXkpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgeWVhcl8gKz0gMQogICAgICAgICAgICAgICAgICAgICAgICBpZiBkID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrPSJcdTIwNjMiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkPSJub25lIgogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaz1kCiAgICAgICAgICAgICAgICAgICAgICAgIGYuYXBwZW5kKElubGluZUtleWJvYXJkQnV0dG9uKHRleHQ9ZiJ7a30iLGNhbGxiYWNrX2RhdGE9ZiJzY2hfbW9udGhfe3llYXJffV97bW9udGh9X3tkfSIpKQogICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5hcHBlbmQoZikKICAgICAgICAgICAgICAgIGJ1dHRvbi5hcHBlbmQoW0lubGluZUtleWJvYXJkQnV0dG9uKCJDbG9zZSIsIGNhbGxiYWNrX2RhdGE9InNjaGNsb3NlIildKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0KGYiQ2hvb3NlIHRoZSBkYXkgb2YgdGhlIG1vbnRoIHlvdSB3YW50IHRvIHNjaGVkdWxlIHRoZSB2b2ljZWNoYXQuXG5Ub2RheSBpcyB7dGhpc2RheX0ge3Ntb250aH0ge3R5ZWFyfS4gQ2hvb29zaW5nIGEgZGF0ZSBwcmVjZWVkaW5nIHRvZGF5IHdpbGwgYmUgY29uc2lkZXJlZCBhcyBuZXh0IHllYXIge3llYXIrMX0iLCByZXBseV9tYXJrdXA9SW5saW5lS2V5Ym9hcmRNYXJrdXAoYnV0dG9uKSkKCiAgICAgICAgICAgIGVsaWYgZGF0YS5zdGFydHN3aXRoKCJzY2hjb25maXJtIik6CiAgICAgICAgICAgICAgICBub25lLCBkYXRlID0gZGF0YS5zcGxpdCgiXyIpCiAgICAgICAgICAgICAgICBkYXRlID0gZGF0ZXRpbWUuZGF0ZXRpbWUuc3RycHRpbWUoZGF0ZSwgJyVZLSVtLSVkICVIOiVNJykKICAgICAgICAgICAgICAgIGxvY2FsX2R0ID0gSVNULmxvY2FsaXplKGRhdGUsIGlzX2RzdD1Ob25lKQogICAgICAgICAgICAgICAgdXRjX2R0ID0gbG9jYWxfZHQuYXN0aW1lem9uZShweXR6LnV0YykucmVwbGFjZSh0emluZm89Tm9uZSkKICAgICAgICAgICAgICAgIGpvYl9pZD1mIntxdWVyeS5tZXNzYWdlLmNoYXQuaWR9X3txdWVyeS5tZXNzYWdlLm1lc3NhZ2VfaWR9IgogICAgICAgICAgICAgICAgQ29uZmlnLlNDSEVEVUxFX0xJU1QuYXBwZW5kKHsiam9iX2lkIjpqb2JfaWQsICJkYXRlIjp1dGNfZHR9KQogICAgICAgICAgICAgICAgQ29uZmlnLlNDSEVEVUxFX0xJU1QgPSBzb3J0ZWQoQ29uZmlnLlNDSEVEVUxFX0xJU1QsIGtleT1sYW1iZGEgazoga1snZGF0ZSddKQogICAgICAgICAgICAgICAgYXdhaXQgc2NoZWR1bGVfYV9wbGF5KGpvYl9pZCwgdXRjX2R0KQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0KGYiU3VjY2VzZnVsbHkgc2NoZWR1bGVkIHRvIHN0cmVhbSBvbiA8Y29kZT4ge2RhdGUuc3RyZnRpbWUoJyViICVkICVZLCAlSTolTSAlcCcpfSA8L2NvZGU+IikKICAgICAgICAgICAgICAgIGF3YWl0IGRlbGV0ZV9tZXNzYWdlcyhbcXVlcnkubWVzc2FnZSwgcXVlcnkubWVzc2FnZS5yZXBseV90b19tZXNzYWdlXSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbGlmIHF1ZXJ5LmRhdGEgPT0gJ3NjaGNhbmNlbGFsbCc6CiAgICAgICAgICAgICAgICBhd2FpdCBjYW5jZWxfYWxsX3NjaGVkdWxlcygpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQoIkFsbCBTY2hlZHVsZWQgU3RyZWFtcyBhcmUgY2FuY2VsbGVkIHN1Y2Nlc2Z1bGx5LiIpCgogICAgICAgICAgICBlbGlmIHF1ZXJ5LmRhdGEgPT0gInNjaGNhbmNlbCI6CiAgICAgICAgICAgICAgICBidXR0b25zID0gWwogICAgICAgICAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oJ1llcywgSWFtIFN1cmUhIScsIGNhbGxiYWNrX2RhdGE9J3NjaGNhbmNlbGFsbCcpLAogICAgICAgICAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbignTm8nLCBjYWxsYmFja19kYXRhPSdzY2hjbG9zZScpLAogICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdCgiQXJlIHlvdSBzdXJlIHRoYXQgeW91IHdhbnQgdG8gY2FuY2VsIGFsbCB0aGUgc2NoZWR1bGVkIHN0cmVhbXM/IiwgcmVwbHlfbWFya3VwPUlubGluZUtleWJvYXJkTWFya3VwKGJ1dHRvbnMpKQogICAgICAgICAgICBlbGlmIGRhdGEgPT0gInNjaGNsb3NlIjoKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigiTWVudSBDbG9zZWQiKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5kZWxldGUoKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmRlbGV0ZSgpCgogICAgICAgIGVsaWYgcXVlcnkuZGF0YSA9PSAic2h1ZmZsZSI6CiAgICAgICAgICAgIGlmIG5vdCBDb25maWcucGxheWxpc3Q6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoIlBsYXlsaXN0IGlzIGVtcHR5LiIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBhd2FpdCBzaHVmZmxlX3BsYXlsaXN0KCkKICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJQbGF5bGlzdCBzaHVmZmxlZC4iKQogICAgICAgICAgICBhd2FpdCBzbGVlcCgxKSAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdF9yZXBseV9tYXJrdXAocmVwbHlfbWFya3VwPWF3YWl0IGdldF9idXR0b25zKCkpCiAgICAKCiAgICAgICAgZWxpZiBxdWVyeS5kYXRhLmxvd2VyKCkgPT0gInBhdXNlIjoKICAgICAgICAgICAgaWYgQ29uZmlnLlBBVVNFOgogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCLYqtmFINin2YTYpdmK2YLYp9mBINmF2KTZgtiq2YvYpyDYqNin2YTZgdi52YTwn5iQIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYXdhaXQgcGF1c2UoKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJTdHJlYW0gUGF1c2VkIikKICAgICAgICAgICAgICAgIGF3YWl0IHNsZWVwKDEpCgogICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD1hd2FpdCBnZXRfYnV0dG9ucygpKQogCiAgICAgICAgCiAgICAgICAgZWxpZiBxdWVyeS5kYXRhLmxvd2VyKCkgPT0gInJlc3VtZSI6ICAgCiAgICAgICAgICAgIGlmIG5vdCBDb25maWcuUEFVU0U6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoItmE2Kcg2LTZitihINiq2YjZgtmBINmE2YTYp9iz2KrYptmG2KfZgeOAve+4jyIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGF3YWl0IHJlc3VtZSgpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoIlJlZHVtZWQgdGhlIHN0cmVhbSIpCiAgICAgICAgICAgICAgICBhd2FpdCBzbGVlcCgxKQogICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD1hd2FpdCBnZXRfYnV0dG9ucygpKQogICAgICAgICAgCiAgICAgICAgZWxpZiBxdWVyeS5kYXRhPT0ic2tpcCI6IAogICAgICAgICAgICBpZiBub3QgQ29uZmlnLnBsYXlsaXN0OgogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCLZgtin2KbZhdipINin2YTYqti02LrZitmEINmB2KfYsdi62Knwn5mC4p2MIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCLYrNin2LEg2KrYrti32Yog2KfZhNmB2YrYr9mK2YjjgL3vuI8uIikKICAgICAgICAgICAgICAgIGF3YWl0IHNraXAoKQogICAgICAgICAgICAgICAgYXdhaXQgc2xlZXAoMSkKICAgICAgICAgICAgaWYgQ29uZmlnLnBsYXlsaXN0OgogICAgICAgICAgICAgICAgdGl0bGU9ZiI8Yj57Q29uZmlnLnBsYXlsaXN0WzBdWzFdfTwvYj5cbuOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpCIKICAgICAgICAgICAgZWxpZiBDb25maWcuU1RSRUFNX0xJTks6CiAgICAgICAgICAgICAgICB0aXRsZT1mIjxiPlN0cmVhbSBVc2luZyBbVXJsXSh7Q29uZmlnLkRBVEFbJ0ZJTEVfREFUQSddWydmaWxlJ119KTwvYj7jhaQgIOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpCIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHRpdGxlPWYiPGI+U3RyZWFtaW5nIFN0YXJ0dXAgW3N0cmVhbV0oe0NvbmZpZy5TVFJFQU1fVVJMfSk8L2I+IOOFpCDjhaQgIOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpOOFpCIKICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0KGYiPGI+e3RpdGxlfTwvYj4iLAogICAgICAgICAgICAgICAgZGlzYWJsZV93ZWJfcGFnZV9wcmV2aWV3PVRydWUsCiAgICAgICAgICAgICAgICByZXBseV9tYXJrdXA9YXdhaXQgZ2V0X2J1dHRvbnMoKQogICAgICAgICAgICApCgogICAgICAgIGVsaWYgcXVlcnkuZGF0YT09InJlcGxheSI6CiAgICAgICAgICAgIGlmIG5vdCBDb25maWcucGxheWxpc3Q6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoItmC2KfYptmF2Kkg2KfZhNiq2LTYutmK2YQg2YHYp9ix2LrYqfCfmYLinYwiLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoInRyeWluZyB0byByZXN0YXJ0IHBsYXllciIpCiAgICAgICAgICAgICAgICBhd2FpdCByZXN0YXJ0X3BsYXlvdXQoKQogICAgICAgICAgICAgICAgYXdhaXQgc2xlZXAoMSkKICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgZ2V0X2J1dHRvbnMoKSkKCgogICAgICAgIGVsaWYgcXVlcnkuZGF0YS5sb3dlcigpID09ICJtdXRlIjoKICAgICAgICAgICAgaWYgQ29uZmlnLk1VVEVEOgogICAgICAgICAgICAgICAgYXdhaXQgdW5tdXRlKCkKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigiVW5tdXRlZCBzdHJlYW0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYXdhaXQgbXV0ZSgpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoIk11dGVkIHN0cmVhbSIpCiAgICAgICAgICAgIGF3YWl0IHNsZWVwKDEpCiAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdF9yZXBseV9tYXJrdXAocmVwbHlfbWFya3VwPWF3YWl0IHZvbHVtZV9idXR0b25zKCkpCgogICAgICAgIGVsaWYgcXVlcnkuZGF0YS5sb3dlcigpID09ICdzZWVrJzoKICAgICAgICAgICAgaWYgbm90IENvbmZpZy5DQUxMX1NUQVRVUzoKICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIoIti52LDYsdin2Ysg2YTYpyDZitmI2KzYryDZgdmK2K/ZitmIINmF2LTYutmE8J+YkC4iLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgICNpZiBub3QgKENvbmZpZy5wbGF5bGlzdCBvciBDb25maWcuU1RSRUFNX0xJTkspOgogICAgICAgICAgICAgICAgI3JldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIoIlN0YXJ0dXAgc3RyZWFtIGNhbnQgYmUgc2Vla2VkLiIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCLYqtmFINiq2YLYr9mK2YUg2KfZhNmB2YrYr9mK2Ygg2KjZhtis2KfYreKaoO+4j/CfmLQuIikKICAgICAgICAgICAgZGF0YT1Db25maWcuREFUQS5nZXQoJ0ZJTEVfREFUQScpCiAgICAgICAgICAgIGlmIG5vdCBkYXRhLmdldCgnZHVyJywgMCkgb3IgXAogICAgICAgICAgICAgICAgZGF0YS5nZXQoJ2R1cicpID09IDA6CiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKCJUaGlzIGlzIGEgbGl2ZSBzdHJlYW0gYW5kIGNhbm5vdCBiZSBzZWVrZWQuIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICBrLCByZXBseSA9IGF3YWl0IHNlZWtfZmlsZSgxMCkKICAgICAgICAgICAgaWYgayA9PSBGYWxzZToKICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIocmVwbHksIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgZ2V0X2J1dHRvbnMoKSkKCiAgICAgICAgZWxpZiBxdWVyeS5kYXRhLmxvd2VyKCkgPT0gJ3Jld2luZCc6CiAgICAgICAgICAgIGlmIG5vdCBDb25maWcuQ0FMTF9TVEFUVVM6CiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKCLYudiw2LHYp9mLINmE2Kcg2YrZiNis2K8g2LTYpiDZgtmK2K8g2KfZhNiq2LTYutmK2YTwn5i2LiIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgI2lmIG5vdCAoQ29uZmlnLnBsYXlsaXN0IG9yIENvbmZpZy5TVFJFQU1fTElOSyk6CiAgICAgICAgICAgICAgICAjcmV0dXJuIGF3YWl0IHF1ZXJ5LmFuc3dlcigiU3RhcnR1cCBzdHJlYW0gY2FudCBiZSBzZWVrZWQuIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoItiq2YUg2KrYo9iu2YrYsSDYp9mE2YHZitiv2YrZiPCfmJIuIikKICAgICAgICAgICAgZGF0YT1Db25maWcuREFUQS5nZXQoJ0ZJTEVfREFUQScpCiAgICAgICAgICAgIGlmIG5vdCBkYXRhLmdldCgnZHVyJywgMCkgb3IgXAogICAgICAgICAgICAgICAgZGF0YS5nZXQoJ2R1cicpID09IDA6CiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKCJUaGlzIGlzIGEgbGl2ZSBzdHJlYW0gYW5kIGNhbm5vdCBiZSBzZWVrZWQuIiwgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICBrLCByZXBseSA9IGF3YWl0IHNlZWtfZmlsZSgtMTApCiAgICAgICAgICAgIGlmIGsgPT0gRmFsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKHJlcGx5LCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdF9yZXBseV9tYXJrdXAocmVwbHlfbWFya3VwPWF3YWl0IGdldF9idXR0b25zKCkpCgogICAgCiAgICAgICAgZWxpZiBxdWVyeS5kYXRhID09ICdyZXN0YXJ0JzoKICAgICAgICAgICAgaWYgbm90IENvbmZpZy5DQUxMX1NUQVRVUzoKICAgICAgICAgICAgICAgIGlmIG5vdCBDb25maWcucGxheWxpc3Q6CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJQbGF5ZXIgaXMgZW1wdHksIHN0YXJ0aW5nIFNUQVJUVVBfU1RSRUFNLiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcign2KfYs9iq2KbZhtin2YEg2YLYp9im2YXYqSDYp9mE2KrYtNi62YrZhPCfmLTjgL3vuI8nKQogICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoIlJlc3RyYXRpbmcgdGhlIHBsYXllciIpCiAgICAgICAgICAgIGF3YWl0IHJlc3RhcnQoKQogICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXQodGV4dD1hd2FpdCBnZXRfcGxheWxpc3Rfc3RyKCksIHJlcGx5X21hcmt1cD1hd2FpdCBnZXRfYnV0dG9ucygpLCBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZSkKCiAgICAgICAgZWxpZiBxdWVyeS5kYXRhLnN0YXJ0c3dpdGgoInZvbHVtZSIpOgogICAgICAgICAgICBtZSwgeW91ID0gcXVlcnkuZGF0YS5zcGxpdCgiXyIpICAKICAgICAgICAgICAgaWYgeW91ID09ICJtYWluIjoKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdF9yZXBseV9tYXJrdXAocmVwbHlfbWFya3VwPWF3YWl0IHZvbHVtZV9idXR0b25zKCkpCiAgICAgICAgICAgIGlmIHlvdSA9PSAiYWRkIjoKICAgICAgICAgICAgICAgIGlmIDE5MCA8PSBDb25maWcuVk9MVU1FIDw9MjAwOgogICAgICAgICAgICAgICAgICAgIHZvbD0yMDAgCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHZvbD1Db25maWcuVk9MVU1FKzEwCiAgICAgICAgICAgICAgICBpZiBub3QgKDEgPD0gdm9sIDw9IDIwMCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHF1ZXJ5LmFuc3dlcigiT25seSAxLTIwMCByYW5nZSBhY2NlcHRlZC4iKQogICAgICAgICAgICAgICAgYXdhaXQgdm9sdW1lKHZvbCkKICAgICAgICAgICAgICAgIENvbmZpZy5WT0xVTUU9dm9sCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD1hd2FpdCB2b2x1bWVfYnV0dG9ucygpKQogICAgICAgICAgICBlbGlmIHlvdSA9PSAibGVzcyI6CiAgICAgICAgICAgICAgICBpZiAxIDw9IENvbmZpZy5WT0xVTUUgPD0xMDoKICAgICAgICAgICAgICAgICAgICB2b2w9MQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB2b2w9Q29uZmlnLlZPTFVNRS0xMAogICAgICAgICAgICAgICAgaWYgbm90ICgxIDw9IHZvbCA8PSAyMDApOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIoIk9ubHkgMS0yMDAgcmFuZ2UgYWNjZXB0ZWQuIikKICAgICAgICAgICAgICAgIGF3YWl0IHZvbHVtZSh2b2wpCiAgICAgICAgICAgICAgICBDb25maWcuVk9MVU1FPXZvbAogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgdm9sdW1lX2J1dHRvbnMoKSkKICAgICAgICAgICAgZWxpZiB5b3UgPT0gImJhY2siOgogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgZ2V0X2J1dHRvbnMoKSkKCgogICAgICAgIGVsaWYgcXVlcnkuZGF0YSBpbiBbImlzX2xvb3AiLCAiaXNfdmlkZW8iLCAiYWRtaW5fb25seSIsICJlZGl0X3RpdGxlIiwgInNldF9zaHVmZmxlIiwgInJlcGx5X21zZyIsICJzZXRfbmV3X2NoYXQiLCAicmVjb3JkIiwgInJlY29yZF92aWRlbyIsICJyZWNvcmRfZGltIl06CiAgICAgICAgICAgIGlmIHF1ZXJ5LmRhdGEgPT0gImlzX2xvb3AiOgogICAgICAgICAgICAgICAgQ29uZmlnLklTX0xPT1AgPSBzZXRfY29uZmlnKENvbmZpZy5JU19MT09QKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgc2V0dGluZ3NfcGFuZWwoKSkKICAKICAgICAgICAgICAgZWxpZiBxdWVyeS5kYXRhID09ICJpc192aWRlbyI6CiAgICAgICAgICAgICAgICBDb25maWcuSVNfVklERU8gPSBzZXRfY29uZmlnKENvbmZpZy5JU19WSURFTykKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdF9yZXBseV9tYXJrdXAocmVwbHlfbWFya3VwPWF3YWl0IHNldHRpbmdzX3BhbmVsKCkpCiAgICAgICAgICAgICAgICBkYXRhPUNvbmZpZy5EQVRBLmdldCgnRklMRV9EQVRBJykKICAgICAgICAgICAgICAgIGlmIG5vdCBkYXRhIFwKICAgICAgICAgICAgICAgICAgICBvciBkYXRhLmdldCgnZHVyJywgMCkgPT0gMDoKICAgICAgICAgICAgICAgICAgICBhd2FpdCByZXN0YXJ0X3BsYXlvdXQoKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgaywgcmVwbHkgPSBhd2FpdCBzZWVrX2ZpbGUoMCkKICAgICAgICAgICAgICAgIGlmIGsgPT0gRmFsc2U6CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVzdGFydF9wbGF5b3V0KCkKCiAgICAgICAgICAgIGVsaWYgcXVlcnkuZGF0YSA9PSAiYWRtaW5fb25seSI6CiAgICAgICAgICAgICAgICBDb25maWcuQURNSU5fT05MWSA9IHNldF9jb25maWcoQ29uZmlnLkFETUlOX09OTFkpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD1hd2FpdCBzZXR0aW5nc19wYW5lbCgpKQogICAgICAgIAogICAgICAgICAgICBlbGlmIHF1ZXJ5LmRhdGEgPT0gImVkaXRfdGl0bGUiOgogICAgICAgICAgICAgICAgQ29uZmlnLkVESVRfVElUTEUgPSBzZXRfY29uZmlnKENvbmZpZy5FRElUX1RJVExFKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9YXdhaXQgc2V0dGluZ3NfcGFuZWwoKSkKICAgICAgICAKICAgICAgICAgICAgZWxpZiBxdWVyeS5kYXRhID09ICJzZXRfc2h1ZmZsZSI6CiAgICAgICAgICAgICAgICBDb25maWcuU0hVRkZMRSA9IHNldF9jb25maWcoQ29uZmlnLlNIVUZGTEUpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD1hd2FpdCBzZXR0aW5nc19wYW5lbCgpKQogICAgICAgIAogICAgICAgICAgICBlbGlmIHF1ZXJ5LmRhdGEgPT0gInJlcGx5X21zZyI6CiAgICAgICAgICAgICAgICBDb25maWcuUkVQTFlfUE0gPSBzZXRfY29uZmlnKENvbmZpZy5SRVBMWV9QTSkKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdF9yZXBseV9tYXJrdXAocmVwbHlfbWFya3VwPWF3YWl0IHNldHRpbmdzX3BhbmVsKCkpCiAgICAgICAgCiAgICAgICAgICAgIGVsaWYgcXVlcnkuZGF0YSA9PSAicmVjb3JkX2RpbSI6CiAgICAgICAgICAgICAgICBpZiBub3QgQ29uZmlnLklTX1ZJREVPX1JFQ09SRDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKCJUaGlzIGNhbnQgYmUgdXNlZCBmb3IgYXVkaW8gcmVjb3JkaW5ncyIpCiAgICAgICAgICAgICAgICBDb25maWcuUE9SVFJBSVQ9c2V0X2NvbmZpZyhDb25maWcuUE9SVFJBSVQpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD0oYXdhaXQgcmVjb3JkZXJfc2V0dGluZ3MoKSkpCiAgICAgICAgICAgIGVsaWYgcXVlcnkuZGF0YSA9PSAncmVjb3JkX3ZpZGVvJzoKICAgICAgICAgICAgICAgIENvbmZpZy5JU19WSURFT19SRUNPUkQ9c2V0X2NvbmZpZyhDb25maWcuSVNfVklERU9fUkVDT1JEKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5lZGl0X3JlcGx5X21hcmt1cChyZXBseV9tYXJrdXA9KGF3YWl0IHJlY29yZGVyX3NldHRpbmdzKCkpKQoKICAgICAgICAgICAgZWxpZiBxdWVyeS5kYXRhID09ICdyZWNvcmQnOgogICAgICAgICAgICAgICAgaWYgQ29uZmlnLklTX1JFQ09SRElORzoKICAgICAgICAgICAgICAgICAgICBrLCBtc2cgPSBhd2FpdCBzdG9wX3JlY29yZGluZygpCiAgICAgICAgICAgICAgICAgICAgaWYgayA9PSBGYWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKG1zZywgc2hvd19hbGVydD1UcnVlKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigiUmVjb3JkaW5nIFN0b3BwZWQiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBrLCBtc2cgPSBhd2FpdCBzdGFydF9yZWNvcmRfc3RyZWFtKCkKICAgICAgICAgICAgICAgICAgICBpZiBrID09IEZhbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIobXNnLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJSZWNvcmRpbmcgc3RhcnRlZCIpCiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmVkaXRfcmVwbHlfbWFya3VwKHJlcGx5X21hcmt1cD0oYXdhaXQgcmVjb3JkZXJfc2V0dGluZ3MoKSkpCgogICAgICAgICAgICBlbGlmIHF1ZXJ5LmRhdGEgPT0gInNldF9uZXdfY2hhdCI6CiAgICAgICAgICAgICAgICBpZiBxdWVyeS5mcm9tX3VzZXIgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgcXVlcnkuYW5zd2VyKCJZb3UgY2FudCBkbyBzY2hlZHVsaW5nIGhlcmUsIHNpbmNlIHlvdSBhcmUgYW4gYW5vbnltb3VzIGFkbWluLiBTY2hlZHVsZSBmcm9tIHByaXZhdGUgY2hhdC4iLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgICAgICBpZiBxdWVyeS5mcm9tX3VzZXIuaWQgaW4gQ29uZmlnLlNVRE86CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJTZXR0aW5nIHVwIG5ldyBDSEFUIikKICAgICAgICAgICAgICAgICAgICBjaGF0PXF1ZXJ5Lm1lc3NhZ2UuY2hhdC5pZAogICAgICAgICAgICAgICAgICAgIGlmIENvbmZpZy5JU19SRUNPUkRJTkc6CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHN0b3BfcmVjb3JkaW5nKCkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBjYW5jZWxfYWxsX3NjaGVkdWxlcygpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbGVhdmVfY2FsbCgpCiAgICAgICAgICAgICAgICAgICAgQ29uZmlnLkNIQVQ9Y2hhdAogICAgICAgICAgICAgICAgICAgIENvbmZpZy5BRE1JTl9DQUNIRT1GYWxzZQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHJlc3RhcnQoKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5Lm1lc3NhZ2UuZWRpdCgiU3VjY2VzZnVsbHkgQ2hhbmdlZCBDaGF0IikKICAgICAgICAgICAgICAgICAgICBhd2FpdCBzeW5jX3RvX2RiKCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkuYW5zd2VyKCJUaGlzIGNhbiBvbmx5IGJlIHVzZWQgYnkgU1VETyB1c2VycyIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgaWYgbm90IENvbmZpZy5EQVRBQkFTRV9VUkk6CiAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5hbnN3ZXIoIk5vIERBVEFCQVNFIGZvdW5kLCB0aGlzIGNoYW5nZXMgYXJlIHNhdmVkIHRlbXBvcmFybHkgYW5kIHdpbGwgYmUgcmV2ZXJ0ZWQgb24gcmVzdGFydC4gQWRkIE1vbmdvRGIgdG8gbWFrZSB0aGlzIHBlcm1hbmFudC4iKQogICAgICAgIGVsaWYgcXVlcnkuZGF0YS5zdGFydHN3aXRoKCJjbG9zZSIpOgogICAgICAgICAgICBpZiAic3VkbyIgaW4gcXVlcnkuZGF0YToKICAgICAgICAgICAgICAgIGlmIHF1ZXJ5LmZyb21fdXNlci5pZCBpbiBDb25maWcuU1VETzoKICAgICAgICAgICAgICAgICAgICBhd2FpdCBxdWVyeS5tZXNzYWdlLmRlbGV0ZSgpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigiVGhpcyBjYW4gb25seSBiZSB1c2VkIGJ5IFNVRE8gdXNlcnMiLCBzaG93X2FsZXJ0PVRydWUpICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHF1ZXJ5Lm1lc3NhZ2UuY2hhdC50eXBlICE9ICJwcml2YXRlIiBhbmQgcXVlcnkubWVzc2FnZS5yZXBseV90b19tZXNzYWdlOgogICAgICAgICAgICAgICAgICAgIGlmIHF1ZXJ5Lm1lc3NhZ2UucmVwbHlfdG9fbWVzc2FnZS5mcm9tX3VzZXIgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIGVsaWYgcXVlcnkuZnJvbV91c2VyLmlkICE9IHF1ZXJ5Lm1lc3NhZ2UucmVwbHlfdG9fbWVzc2FnZS5mcm9tX3VzZXIuaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBxdWVyeS5hbnN3ZXIoIk9rZGEiLCBzaG93X2FsZXJ0PVRydWUpCiAgICAgICAgICAgICAgICBlbGlmIHF1ZXJ5LmZyb21fdXNlci5pZCBpbiBDb25maWcuQURNSU5TOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHF1ZXJ5LmFuc3dlcigiT2tkYSIsIHNob3dfYWxlcnQ9VHJ1ZSkKICAgICAgICAgICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigiTWVudSBDbG9zZWQiKQogICAgICAgICAgICAgICAgYXdhaXQgcXVlcnkubWVzc2FnZS5kZWxldGUoKQogICAgICAgIGF3YWl0IHF1ZXJ5LmFuc3dlcigpCg=='))
